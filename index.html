<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
    <title>OOTP World Editor</title>
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
	<script type="text/javascript" src="./scripts/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="./scripts/jquery.fancytree-all-deps.min.js"></script>
    <script type="text/javascript" src="./scripts/jquery.magnific-popup.min.js"></script>
    <script type="text/javascript" src="./scripts/vkbeautify.0.99.00.beta.js"></script>
    <script type="text/javascript" src="./scripts/snap.svg-min.js"></script>
    <script type="text/javascript" src="./scripts/jquery.listtopie.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/translate@2/index.min.js"></script>
    <script type="text/javascript" src="./scripts/multiselect.min.js"></script>
    <link href="./scripts/worldeditor.css" rel="stylesheet">
    <link href="./scripts/skin-win8-n/ui.fancytree.min.css" rel="stylesheet">
    <link href="./scripts/bootstrap.css" rel="stylesheet">
    <link href='./scripts/magnific-popup.css' rel='stylesheet' type='text/css'>
    <link href="./scripts/jquery.contextMenu.css" rel="stylesheet" type='text/css'/>
    <link href="./scripts/DataTables-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="./scripts/Buttons-2.4.1/css/buttons.dataTables.min.css" rel="stylesheet">
    <link href="./scripts/FixedHeader-3.4.0/css/fixedHeader.dataTables.min.css" rel="stylesheet">
    <link href="./scripts/Select-1.7.0/css/select.dataTables.min.css" rel="stylesheet">
    <link href="./scripts/smart_wizard_all.min.css" rel="stylesheet" type="text/css" />
    <link href="./scripts/jquery.lineProgressbar.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="./scripts/jquery.listtopie.css"/>
    <script type="text/javascript" src="./scripts/jquery.contextMenu.js"></script>
    <script type="text/javascript" src="./scripts/jquery.fancytree.contextMenu.js"></script>
    <script type="text/javascript" src="./scripts/jquery.fancytree.dnd5.js"></script>
    <script type="text/javascript" src="./scripts/jquery.fancytree.multi.js"></script>
    <script src="./scripts/DataTables-1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="./scripts/Buttons-2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="./scripts/FixedHeader-3.4.0/js/dataTables.fixedHeader.min.js"></script>
    <script src="./scripts/Select-1.7.0/js/dataTables.select.min.js"></script>
    <script type="text/javascript" src="./scripts/latinize.js"></script>
    <script type="text/javascript" src="./scripts/chroma.min.js"></script>
    <script src="./scripts/jquery.smartWizard.min.js" type="text/javascript"></script>
    <script src="https://kit.fontawesome.com/1bfcbf3745.js" crossorigin="anonymous"></script>
    <script src="./scripts/jquery.lineProgressbar.js" type="text/javascript"></script>
    
    <script>
        const { ipcRenderer } = require('electron');
        const { translate } = require('bing-translate-api');
        const XMLWriter = require('xml-writer');
        var nodeToEdit = null;
        var max_world_id = max_continent_id = max_nation_id = max_state_id = max_city_id = max_ethnicity_id = max_region_id = max_region_sort_order = world_count = continent_count = nation_count = state_count = city_count = ethnicity_count = region_count = 0
        var ethnicities_by_id = {}
        var cities_by_id = {}
        var states_by_id = {}
        var nations_by_id = {}
        var continents_by_id = {}
        var regions_by_id = {}
        var nations_by_continent = {}
        var states_by_nation = {}
        var cities_by_state = {}
        var cities_by_nation = {}
        var usa_defined = []
        const time_zones = [ { tz: "-12.00", loc: "(GMT-12:00) International Date Line West" }, { tz: "-11.00", loc: "(GMT-11:00) Midway Island, Samoa" }, { tz: "-10.00", loc: "(GMT-10:00) Hawaii" }, { tz: "-9.00", loc: "(GMT-09:00) Alaska" }, { tz: "-8.00", loc: "(GMT-08:00) Pacific Time (US &amp; Canada)" }, { tz: "-7.00", loc: "(GMT-07:00) Mountain Time (US &amp; Canada)" }, { tz: "-6.00", loc: "(GMT-06:00) Central Time (US &amp; Canada)" }, { tz: "-5.00", loc: "(GMT-05:00) Eastern Time (US &amp; Canada)" }, { tz: "-4.00", loc: "(GMT-04:00) Atlantic Time (Canada)" }, { tz: "-3.50", loc: "(GMT-03:30) Newfoundland" }, { tz: "-3.00", loc: "(GMT-03:00) Brasilia" }, { tz: "-2.00", loc: "(GMT-02:00) Mid-Atlantic" }, { tz: "-1.00", loc: "(GMT-01:00) Cape Verde Is." },  { tz: "0.00", loc: "(GMT+00:00) Greenwich Mean Time - Dublin, Edinburgh, Lisbon, London" }, { tz: "1.00", loc: "(GMT+01:00) Amsterdam, Berlin, Bern, Rome, Stockholm, Vienna" },  { tz: "2.00", loc: "(GMT+02:00) Cairo" }, { tz: "3.00", loc: "(GMT+03:00) Moscow, St. Petersburg, Volgograd" }, { tz: "3.50", loc: "(GMT+03:30) Tehran" }, { tz: "4.00", loc: "(GMT+04:00) Abu Dhabi, Muscat" },  { tz: "4.50", loc: "(GMT+04:30) Kabul" },  { tz: "5.00", loc: "(GMT+05:00) Islamabad, Karachi, Tashkent" }, { tz: "5.50", loc: "(GMT+05:30) Chennai, Kolkata, Mumbai, New Delhi" }, { tz: "5.75", loc: "(GMT+05:45) Kathmandu" }, { tz: "6.00", loc: "(GMT+06:00) Almaty, Novosibirsk" }, { tz: "6.50", loc: "(GMT+06:30) Yangon (Rangoon)" }, { tz: "7.00", loc: "(GMT+07:00) Bangkok, Hanoi, Jakarta" }, { tz: "8.00", loc: "(GMT+08:00) Beijing, Chongqing, Hong Kong, Urumqi" },  { tz: "9.00", loc: "(GMT+09:00) Osaka, Sapporo, Tokyo" }, { tz: "9.50", loc: "(GMT+09:30) Adelaide, Darwin" },  { tz: "10.00", loc: "(GMT+10:00) Canberra, Melbourne, Sydney" }, { tz: "11.00", loc: "(GMT+11:00) Magadan, Solomon Is., New Caledonia" }, { tz: "12.00", loc: "(GMT+12:00) Auckland, Wellington" }]
        const tzDisplay = { "-12.00": "(GMT-12:00) International Date Line West", "-11.00": "(GMT-11:00) Midway Island, Samoa", "-10.00": "(GMT-10:00) Hawaii", "-9.00": "(GMT-09:00) Alaska", "-8.00": "(GMT-08:00) Pacific Time (US &amp; Canada)", "-7.00": "(GMT-07:00) Mountain Time (US &amp; Canada)", "-6.00": "(GMT-06:00) Central Time (US &amp; Canada)", "-5.00": "(GMT-05:00) Eastern Time (US &amp; Canada)", "-4.00": "(GMT-04:00) Atlantic Time (Canada)", "-3.50": "(GMT-03:30) Newfoundland", "-3.00": "(GMT-03:00) Brasilia", "-2.00": "(GMT-02:00) Mid-Atlantic", "-1.00": "(GMT-01:00) Cape Verde Is." , "0.00": "(GMT+00:00) Greenwich Mean Time - Dublin, Edinburgh, Lisbon, London", "1.00": "(GMT+01:00) Amsterdam, Berlin, Bern, Rome, Stockholm, Vienna" , "2.00": "(GMT+02:00) Cairo", "3.00": "(GMT+03:00) Moscow, St. Petersburg, Volgograd", "3.50": "(GMT+03:30) Tehran", "4.00": "(GMT+04:00) Abu Dhabi, Muscat" , "4.50": "(GMT+04:30) Kabul" , "5.00": "(GMT+05:00) Islamabad, Karachi, Tashkent", "5.50": "(GMT+05:30) Chennai, Kolkata, Mumbai, New Delhi", "5.75": "(GMT+05:45) Kathmandu", "6.00": "(GMT+06:00) Almaty, Novosibirsk", "6.50": "(GMT+06:30) Yangon (Rangoon)", "7.00": "(GMT+07:00) Bangkok, Hanoi, Jakarta", "8.00": "(GMT+08:00) Beijing, Chongqing, Hong Kong, Urumqi" , "9.00": "(GMT+09:00) Osaka, Sapporo, Tokyo", "9.50": "(GMT+09:30) Adelaide, Darwin" , "10.00": "(GMT+10:00) Canberra, Melbourne, Sydney", "11.00": "(GMT+11:00) Magadan, Solomon Is., New Caledonia", "12.00": "(GMT+12:00) Auckland, Wellington" }
        const baseballQuality = { 0: "Non-Existent", 1: "Poor", 2: "Fair", 3: "Average", 4: "Good", 5: "Excellent" }
        const usa = { 0: "No", 1: "Yes" }
        const hardcoded = { 0: "No", 1: "Yes" }
        const gender = { 0: "Male", 1: "Female" }
        const dst = { 0: "No", 1: "Yes"}
        const altitudes = { 0: "~0 m", 1: "~500 m", 2: "~1000 m", 3: "~1500 m", 4: "~2000 m", 5: "~2500 m", 6: "~3000 m" }
        let currentVersion = ""
        let newXML = false
        let bulkImportData = null

        $.extend( $.fn.dataTable.defaults, {
            searching: false,
            ordering:  true,
            paging: false, 
            info: false,
            scrollY: 700,
            scrollCollapse: true
        } );
    </script>
    <style>
        .white-popup {
            height: 650px;
            width: auto;
        }

        .sw .toolbar>.sw-btn.disabled, .sw .toolbar>.sw-btn:disabled {
            opacity: .25;
        }

        ul.fancytree-container {
            /* font-family: tahoma,arial,helvetica;
            font-size: 10pt;
            white-space: nowrap;
            padding: 3px;
            margin: 0; */
            background-color: transparent;
            border: 0px solid transparent;
            /* min-height: 0;
            position: relative; */
        }

        .context-menu-list .context-menu-icon.context-menu-icon--fa { 
            font-family: 'Lato', Helvetica, sans-serif; font-weight: 400; 
        }

         .context-menu-icon.context-menu-icon--fa::before {
            color: black
        }

        .context-menu-icon::before  {
            color: black
        } 
        
        .percentCount {
            font-family: 'Lato', Helvetica, sans-serif; 
            font-weight: 700; 
        }
    </style>
</head>
<body>
    <div id="overlay">
        <div class="loader"></div>
    </div>
    <div class="section group" style="position: absolute; top: 10px; width:100%;" >
        <div class="col span_1_of_2">
            <div id="xmlOutput" style="max-height: 840px; overflow: auto;"></div>
        </div>
        <div class="col span_1_of_2">
            <!--DIVS FOR ADDING-->
            <div id="addEthnicity" class="rightDiv">
                <h2 style="text-align:center;">Add Ethnicity</h2>
                <form id="newEthnicityForm" action="">
                    <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
                        <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                        <tbody>
                        <tr>
                            <td class="left">ID:</td>
                            <td class="right"><input type='text' style="display:none;" id='newEthnicityID' class="centerText" readonly><span id="newEthnicityIdDisplay">0</span></td>
                        </tr>
                        <tr>
                            <td class="left">Name:</td>
                            <td class="right"><input type='text' style="width:95%;" id='newEthnicityName' class="centerText toKorean" required></td>
                        </tr>
                        <tr>
                            <td class="left">Name (Korean):</td>
                            <td class="right"><input type='text' style="width:95%;" id='newEthnicityNameK' class="centerText"></td>
                        </tr>
                        <tr>
                            <td class="left">African:</td>
                            <td class="right"><input type='number' style="width:95%;" class='newEthPct' min='0' max='1000' id='newEthnicityAfrican' value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Asian:</td>
                            <td class="right"><input type='number' style="width:95%;" class='newEthPct' min='0' max='1000' id='newEthnicityAsian' value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">East Indian:</td>
                            <td class="right"><input type='number' style="width:95%;" class='newEthPct' min='0' max='1000' id='newEthnicityEastIndian' value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Caucasian:</td>
                            <td class="right"><input type='number' style="width:95%;" class='newEthPct' min='0' max='1000' id='newEthnicityCaucasian' value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Hispanic:</td>
                            <td class="right"><input type='number' style="width:95%;" class='newEthPct' min='0' max='1000' id='newEthnicityHispanic' value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Total:</td>
                            <td class="right"><input type='number' min='1000' max='1000' class="readonly centerText" style="width:95%;" id='newEthnicityTotal' class="centerText" pattern="1000"></td>
                        </tr>
                        </tbody>
                    </table>
                    <br>
                <div style="text-align:center;">
                    <input type="button" value="Reset" class="resetButton" data-trigger="#addEthnicityTrigger">
                    <input type="submit" id="newEthnicitySubmit" value="Add Ethnicity">
                </div>
                </form>
            </div>
            <div id="addContinent" class="rightDiv">
                <h2 style="text-align:center;">Add Continent</h2>
                <form id="newContinentForm" action="">
                    <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
                        <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                        <tbody>
                        <tr>
                            <td class="left">ID:</td>
                            <td class="right"><input style="display:none;" type='text' name='newContinentID' id='newContinentID' class="centerText"><span id="newContinentIDDisplay">0</span></td>
                        </tr>
                        <tr>
                            <td class="left">Name:</td>
                            <td class="right"><input style="width:95%;" type="text" class="centerText toKorean" name="newContinentName" id="newContinentName" required></td>
                        </tr>
                        <tr>
                            <td class="left">Abbreviation:</td>
                            <td class="right"><input style="width:95%;" type="text" class="centerText toKorean" name="newContinentAbbr" id="newContinentAbbr" required></td>
                        </tr>
                        <tr>
                            <td class="left">Demonym:</td>
                            <td class="right"><input style="width:95%;" type="text" class="centerText toKorean" name="newContinentDem" id="newContinentDem" required></td>
                        </tr>
                        <tr>
                            <td class="left">Population:</td>
                            <td class="right"><input style="width:95%;" type="number" class="centerText" name="newContinentPop" id="newContinentPop" value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">ETID:</td>
                            <td class="right"><input style="width:95%;" type="number" class="centerText" name="newContinentEtid" id="newContinentEtid" value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Name (Korean):</td>
                            <td class="right"><input style="width:95%;" type="text" class="centerText" name="newContinentNameK" id="newContinentNameK" value=""></td>
                        </tr>
                        <tr>
                            <td class="left">Abbreviation (Korean):</td>
                            <td class="right"><input style="width:95%;" type="text" class="centerText" name="newContinentAbbrK" id="newContinentAbbrK" value=""></td>
                        </tr>
                        <tr>
                            <td class="left">Demonym (Korean):</td>
                            <td class="right"><input style="width:95%;" type="text" class="centerText" name="newContinentDemK" id="newContinentDemK" value=""></td>
                        </tr>
                        </tbody>
                    </table>
                    <br>
                    <div style="text-align:center;">
                        <input type="button" value="Reset" class="resetButton" data-trigger="#addContinentTrigger">
                        <input type="submit" id="newContinentSubmit" value="Add Continent">
                    </div>
                </form>
            </div>
            <div id="addNation" class="rightDiv">
                <h2 style="text-align:center;">Add Nation</h2>
                <form id="newNationForm">
                    <table class="headlessTable cell-border compact stripe" style="width:95%; margin:0 auto;">
                        <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                        <tbody>
                        <tr>
                            <td class="left">ID:</td>
                            <td class="right"><input style="display:none;" type='text' id='newNationID' class="centerText"><span id="newNationIDDisplay">0</span></td>
                        </tr>
                        <tr>
                            <td class="left">Continent:</td>
                            <td class="right">
                                <select style="width:99%;" id="newNationContinent">
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Name:</td>
                            <td class="right"><input type="text" class="centerText toKorean" id="newNationName" value="" required></td>
                        </tr>
                        <tr>
                            <td class="left">Abbreviation:</td>
                            <td class="right"><input type="text" class="centerText toKorean" id="newNationAbbr" value="" required></td>
                        </tr>
                        <tr>
                            <td class="left">Demonym:</td>
                            <td class="right"><input type="text" class="centerText toKorean" id="newNationDem" value="" required></td>
                        </tr>
                        <tr>
                            <td class="left">Population:</td>
                            <td class="right"><input type="number" id="newNationPopulation" value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">ETID:</td>
                            <td class="right"><input type="number" id="newNationEtid" value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Gender:</td>
                            <td class="right">
                                <select id="newNationGender" style="width:99%;">
                                    <option value="0">Male</option>
                                    <option value="1">Female</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Baseball Quality:</td>
                            <td class="right">
                                <select id="newNationBbqual" style="width:99%;">
                                    <option value="5">5: Excellent</option>
                                    <option value="4">4: Good</option>
                                    <option value="3" selected>3: Average</option>
                                    <option value="2">2: Fair</option>
                                    <option value="1">1: Poor</option>
                                    <option value="0">Non-Existent</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Observes DST:</td>
                            <td class="right">
                                <select id="newNationDST" style="width:99%;">
                                    <option value="0">No</option>
                                    <option value="1">Yes</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">"This Is The USA"?</td>
                            <td class="right">
                                <select id="newNationUSA" class="defineUSA" style="width:99%;">
                                    <option value="0">No</option>
                                    <option value="1">Yes</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Use Hardcoded ML Player Origins</td>
                            <td class="right">
                                <select id="newNationHardcoded" class="defineHardcoded style="width:99%;">
                                    <option value="0">No</option>
                                    <option value="1">Yes</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Name (Korean):</td>
                            <td class="right"><input type="text" class="centerText" id="newNationNameK" value=""></td>
                        </tr>
                        <tr>
                            <td class="left">Short (Korean):</td>
                            <td class="right"><input type="text" class="centerText" id="newNationShortK" value=""></td>
                        </tr>
                        <tr>
                            <td class="left">Abbr. (Korean):</td>
                            <td class="right"><input type="text" class="centerText" id="newNationAbbrK" value=""></td>
                        
                        </tr>
                        <tr>    
                            <td class="left">Demonym (Korean):</td>
                            <td class="right"><input type="text" class="centerText" id="newNationDemK" value=""></td>
                        </tr>
                        <tr>
                            <td class="left">Time Zone:</td>
                            <td class="right">
                                <select class="tzSelect" id="newNationTimeZone" style="width:100%;">
                                </select>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <br>
                    <div style="text-align:center;">
                        <input type="button" value="Reset" class="resetButton" data-trigger="#addNationTrigger">
                        <input type="submit" id="newNationSubmit" value="Add Nation">
                    </div>
                </form>   
            </div>
            <div id="addState" class="rightDiv">
                <h2 style="text-align:center;">Add State</h2>
                <form id="newStateForm">
                    <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
                        <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                        <tbody>
                        <tr>
                            <td class="left">ID:</td>
                            <td class="right"><input style="display:none;" type='text' id='newStateId' class="centerText"><span id="newStateIDDisplay">0</span></td>
                        </tr>
                        <tr>
                            <td class="left">Continent:</td>
                            <td class="right">
                                <select style="width:99%;" id="newStateContinent">
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Nation:</td>
                            <td class="right">
                                <select style="width:99%;" id="newStateNation">
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Name:</td>
                            <td class="right"><input type="text" style="width:96%;" class="centerText toKorean" id="newStateName" value="" required></td>
                        </tr>
                        <tr>
                            <td class="left">Abbreviation:</td>
                            <td class="right"><input type="text" style="width:96%;" class="centerText toKorean" id="newStateAbbr" value="" required></td>
                        </tr>
                        <tr>
                            <td class="left">Population:</td>
                            <td class="right"><input type="number" style="width:96%;"id="newStatePopulation" value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Time Zone:</td>
                            <td class="right"><select class="tzSelect" id="newStateTimeZone" style="width:99%;"></select></td>
                        </tr>
                        <tr>
                            <td class="left">Observes DST:</td>
                            <td class="right">
                                <select id="newStateDST" style="width:99%;">
                                    <option value="0">No</option>
                                    <option value="1">Yes</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Latitude:</td>
                            <td class="right"><input type="text" style="width:96%;" id="newStateLatitude" value="00.00000" pattern="-?\d{1,3}\.\d+"></td>
                        </tr>
                        <tr>
                            <td class="left">Longitude:</td>
                            <td class="right"><input type="text" style="width:96%;" id="newStateLongitude" value="00.00000" pattern="-?\d{1,3}\.\d+"></td>
                        </tr>
                        <tr>
                            <td class="left">Name (Korean):</td>
                            <td class="right"><input type="text" style="width:96%;"id="newStateNameK" value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Abbreviation (Korean):</td>
                            <td class="right"><input type="text" style="width:96%;" id="newStateAbbrK" value="0"></td>
                        </tr>
                        </tbody>
                    </table>
                    <br>
                    <div style="text-align:center;">
                        <input type="button" value="Reset" class="resetButton" data-trigger="#addStateTrigger">
                        <input type="submit" id="newStateSubmit" value="Add State">
                    </div>
                </form>
            </div>
            <div id="addCity" class="rightDiv">
                <h2 style="text-align:center;">Add City</h2>
                <form id="newCityForm">
                    <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
                        <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                        <tbody>
                        <tr>
                            <td class="left">ID:</td>
                            <td class="right"><input style="display:none;" type='text' id='newCityId' class="centerText"><span id="newCityIDDisplay">0</span></td>
                        </tr>
                        <tr>
                            <td class="left">Continent:</td>
                            <td class="right">
                                <select style="width:99%;" id="newCityContinent">
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Nation:</td>
                            <td class="right">
                                <select style="width:99%;" id="newCityNation">
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">State:</td>
                            <td class="right">
                                <select style="width:99%;" id="newCityState">
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Name:</td>
                            <td class="right"><input type="text" style="width:97%;" class="centerText toKorean" id="newCityName" value="" required></td>
                        </tr>
                        <tr>
                            <td class="left">Abbreviation:</td>
                            <td class="right"><input type="text" style="width:97%;" class="centerText toKorean" id="newCityAbbr" value="" required></td>
                        </tr>
                        <tr>
                            <td class="left">Population:</td>
                            <td class="right"><input type="number" style="width:97%;" id="newCityPopulation" value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Time Zone:</td>
                            <td class="right"><select class="tzSelect" id="newCityTimeZone" style="width:99%;"></select></td>
                        </tr>
                        <tr>
                            <td class="left">National Capitol:</td>
                            <td class="right">
                                <select style="width:99%;" id="newCityCapitol" style="width:99%;">
                                    <option value="0">No</option>
                                    <option value="1">Yes</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Observes DST:</td>
                            <td class="right">
                                <select style="width:99%;" id="newCityDST" style="width:99%;">
                                    <option value="0">No</option>
                                    <option value="1">Yes</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Latitude:</td>
                            <td class="right"><input type="text" style="width:97%;" class="newCityAltCalc" id="newCityLatitude" value="00.00000" pattern="-?\d{1,3}\.\d+"></td>
                        </tr>
                        <tr>
                            <td class="left">Longitude:</td>
                            <td><input type="text" style="width:97%;" id="newCityLongitude" class="newCityAltCalc" value="00.00000" pattern="-?\d{1,3}\.\d+"></td>
                        </tr>
                        <tr>
                            <td class="left">Altitude:</td>
                            <td class="right">
                                <select style="width:99%;" id='newCityAltitude'> 
                                    <option value='0'>~0 m</option>
                                    <option value='1'>~500 m</option>
                                    <option value='2'>~1000 m</option>
                                    <option value='3'>~1500 m</option>
                                    <option value='4'>~2000 m</option>
                                    <option value='5'>~2500 m</option>
                                    <option value='6'>~3000 m</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Name (Korean):</td>
                            <td class="right"><input type="text" style="width:97%;" id="newCityNameK" value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Abbreviation (Korean):</td>
                            <td class="right"><input type="text" style="width:97%;" id="newCityAbbrK" value="0"></td>
                        </tr>
                        </tbody>
                    </table>
                    <br>
                    <div style="text-align:center;">
                        <input type="button" value="Reset" class="resetButton" data-trigger="#addCityTrigger">
                        <input type="submit" id="newCitySubmit" value="Add City">
                    </div>
                </form>
            </div>
            <div id="addRegion" class="rightDiv">
                <h2 style="text-align:center;">Add Region</h2>
                <form id="newRegionForm">
                    <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
                        <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                        <tbody>
                        <tr>
                            <td class="left">ID:</td>
                            <td class="right"><input type='text' style="display:none;" name='newRegionID' id='newRegionID' class="centerText"><span id="newRegionIdDisplay"></span></td>
                        </tr>
                        <tr>
                            <td class="left">Name:</td>
                            <td class="right"><input type="text" class="centerText toKorean" name="newRegionName" id="newRegionName" required></td>
                        </tr>
                        <tr>
                            <td class="left">Name (Korean):</td>
                            <td class="right"><input type="text" class="centerText" name="newRegionNameK" id="newRegionNameK"></td>
                        </tr>
                        <tr>
                            <td class="left">Region Source:</td>
                            <td class="right">
                                <select id="newRegionSource" style="width:100%;">
                                    <option val="nations">Nations</option>
                                    <option val="states">States</option>
                                    <option val="cities">Cities</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left"><span id="filterLabel">Nations</span> From:</td>
                            <td class="right">
                                <select id="newRegionFilter" style="width:100%;"></select>
                            </td>
                        </tr>
                        <tr id="sourceStateRow" style="display:none;">
                            <td class="left">Source State:</td>
                            <td class="right">
                                <select id="newRegionSubFilter" style="width:100%;"></select>
                            </td>
                        </tr>
                        </tbody>
                </table>
                <br/>
                <div class="row">
                    <div class="col-xs-5">
                        <select name="from[]" id="multi_d" class="form-control" size="26" multiple="multiple" style="height:500px;">
                            
                        </select>
                    </div>
                    
                    <div class="col-xs-2">
                        <button type="button" id="multi_d_rightAll" class="btn btn-default btn-block" style="margin-top: 265px;"><i class="glyphicon glyphicon-forward"></i></button>
                        <button type="button" id="multi_d_rightSelected" class="btn btn-default btn-block"><i class="glyphicon glyphicon-chevron-right"></i></button>
                        <button type="button" id="multi_d_leftSelected" class="btn btn-default btn-block"><i class="glyphicon glyphicon-chevron-left"></i></button>
                        <button type="button" id="multi_d_leftAll" class="btn btn-default btn-block"><i class="glyphicon glyphicon-backward"></i></button>
                    </div>
                    
                    <div class="col-xs-5">
                        <b>Nations</b>
                        <fieldset id="newRegionFields" required>
                        <select name="to[]" id="multi_d_to" class="form-control nrTarget" size="8" multiple="multiple" style="height:157px;" required oninvalid="this.setCustomValidity('At least one Nation, State, or City must be chosen')" oninput="this.setCustomValidity('')"></select>
                        
                        
                        <b>States</b>
                        <select name="to_2[]" id="multi_d_to_2" class="form-control nrTarget" size="8" multiple="multiple" style="height:157px;" required oninvalid="this.setCustomValidity('At least one Nation, State, or City must be chosen')" oninput="this.setCustomValidity('')"></select>

                        
                        <b>Cities</b>
                        <select name="to_2[]" id="multi_d_to_3" class="form-control nrTarget" size="8" multiple="multiple" style="height:157px;" required oninvalid="this.setCustomValidity('At least one Nation, State, or City must be chosen')" oninput="this.setCustomValidity('')"></select>
                        </fieldset>
                    </div>
                </div>
                <div style="text-align:center; margin-top:10px;">
                    <input type="button" value="Reset" class="resetButton" data-trigger="#addRegionTrigger">
                    <input type="submit" id="newRegionSubmit" value="Add Region">
                </div>
                </form>
            </div>
            <div id="addSecondNation" class="rightDiv">
                SECOND NATION ADDING HERE
            </div>

            <!--DIVS FOR EDITING-->
            <div id="editEthnicity" class="rightDiv">
                <h2 style="text-align:center;">Edit Ethnicity</h2>
                <form id="editEthnicityForm" action="">
                    <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
                        <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                        <tbody>
                        <tr>
                            <td class="left">ID:</td>
                            <td class="right"><input type='text' style="display:none;" id='editEthnicityID' class="centerText" readonly><span id="editEthnicityDisplay">0</span></td>
                        </tr>
                        <tr>
                            <td class="left">Name:</td>
                            <td class="right"><input type='text' style="width:95%;" id='editEthnicityName' class="centerText toKorean" required></td>
                        </tr>
                        <tr>
                            <td class="left">Name (Korean):</td>
                            <td class="right"><input type='text' style="width:95%;" id='editEthnicityNameK' class="centerText"></td>
                        </tr>
                        <tr>
                            <td class="left">African:</td>
                            <td class="right"><input type='number' style="width:95%;" class='editEthPct' min='0' max='1000' id='editEthnicityAfrican' value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Asian:</td>
                            <td class="right"><input type='number' style="width:95%;" class='editEthPct' min='0' max='1000' id='editEthnicityAsian' value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">East Indian:</td>
                            <td class="right"><input type='number' style="width:95%;" class='editEthPct' min='0' max='1000' id='editEthnicityEastIndian' value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Caucasian:</td>
                            <td class="right"><input type='number' style="width:95%;" class='editEthPct' min='0' max='1000' id='editEthnicityCaucasian' value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Hispanic:</td>
                            <td class="right"><input type='number' style="width:95%;" class='editEthPct' min='0' max='1000' d='editEthnicityHispanic' value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Total:</td>
                            <td class="right"><input type='number' min='1000' max='1000' class="readonly centerText" style="width:95%;" id='editEthnicityTotal' class="centerText" pattern="1000"></td>
                        </tr>
                        </tbody>
                    </table>
                    <br>
                <div style="text-align:center;">
                    <input type="submit" id="editEthnicitySubmit" value="Submit Changes">
                </div>
                </form>
            </div>
            <div id="editContinent" class="rightDiv">
                <h2 style="text-align:center;">Edit Continent</h2>
                <form id="editContinentForm" action="">
                    <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
                        <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                        <tbody>
                        <tr>
                            <td class="left">ID:</td>
                            <td class="right"><input style="display:none;" type='text' name='editContinentID' id='editContinentID' class="centerText"><span id="editContinentIDDisplay">0</span></td>
                        </tr>
                        <tr>
                            <td class="left">Name:</td>
                            <td class="left"><input style="width:95%;" type="text" class="centerText toKorean" name="editContinentName" id="editContinentName" required></td>
                        </tr>
                        <tr>
                            <td class="left">Abbreviation:</td>
                            <td class="left"><input style="width:95%;" type="text" class="centerText toKorean" name="editContinentAbbr" id="editContinentAbbr" required></td>
                        </tr>
                        <tr>
                            <td class="left">Demonym:</td>
                            <td class="left"><input style="width:95%;" type="text" class="centerText toKorean" name="editContinentDem" id="editContinentDem" required></td>
                        </tr>
                        <tr>
                            <td class="left">Population:</td>
                            <td class="left"><input style="width:95%;" type="number" class="centerText" name="editContinentPop" id="editContinentPop" value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">ETID:</td>
                            <td class="left"><input style="width:95%;" type="number" class="centerText" name="editContinentEtid" id="editContinentEtid" value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Name (Korean):</td>
                            <td class="left"><input style="width:95%;" type="text" class="centerText" name="editContinentNameK" id="editContinentNameK" value=""></td>
                        </tr>
                        <tr>
                            <td class="left">Abbreviation (Korean):</td>
                            <td class="left"><input style="width:95%;" type="text" class="centerText" name="editContinentAbbrK" id="editContinentAbbrK" value=""></td>
                        </tr>
                        <tr>
                            <td class="left">Demonym (Korean):</td>
                            <td class="left"><input style="width:95%;" type="text" class="centerText" name="editContinentDemK" id="editContinentDemK" value=""></td>
                        </tr>
                        </tbody>
                    </table>
                    <br>
                    <div style="text-align:center;">
                        <input type="submit" id="editContinentSubmit" value="Submit Changes">
                    </div>
                </form>
            </div>
            <div id="editNation" class="rightDiv">
                <h2 style="text-align:center;">Edit Nation</h2>
                <form id="editNationForm">
                    <table class="headlessTable cell-border compact stripe" style="width:95%; margin:0 auto;">
                        <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                        <tbody>
                        <tr>
                            <td class="left">ID:</td>
                            <td class="right"><input style="display:none;" type='text' id='editNationID' class="centerText"><span id="editNationIDDisplay">0</span></td>
                        </tr>
                        <tr>
                            <td class="left">Name:</td>
                            <td class="right"><input type="text" class="centerText toKorean" id="editNationName" value="" required></td>
                        </tr>
                        <tr>
                            <td class="left">Abbreviation:</td>
                            <td class="right"><input type="text" class="centerText toKorean" id="editNationAbbr" value="" required></td>
                        </tr>
                        <tr>
                            <td class="left">Capitol:</td>
                            <td class="right">
                                <div style="position:relative; width:50%; float:left; text-align:left;">
                                    <label for="editNationCapitolState">State:</label><br>
                                    <select id="editNationCapitolState" style="width:100%;"></select>
                                </div>
                                <div style="position:relative; width:50%; float:right; text-align:left;">
                                    <label for="editNationCapitol">City:</label><br>
                                    <select id="editNationCapitol" style="width:100%;"></select>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Demonym:</td>
                            <td class="right"><input type="text" class="centerText toKorean" id="editNationDem" value="" required></td>
                        </tr>
                        <tr>
                            <td class="left">Population:</td>
                            <td class="right"><input type="number" id="editNationPopulation" value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">ETID:</td>
                            <td class="right"><input type="number" id="editNationEtid" value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Gender:</td>
                            <td class="right">
                                <select id="editNationGender" style="width:99%;">
                                    <option value="0">Male</option>
                                    <option value="1">Female</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Baseball Quality:</td>
                            <td class="right">
                                <select id="editNationBbqual" style="width:99%;">
                                    <option value="5">5: Excellent</option>
                                    <option value="4">4: Good</option>
                                    <option value="3" selected>3: Average</option>
                                    <option value="2">2: Fair</option>
                                    <option value="1">1: Poor</option>
                                    <option value="0">Non-Existent</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Observes DST:</td>
                            <td class="right">
                                <select id="editNationDST" style="width:99%;">
                                    <option value="0">No</option>
                                    <option value="1">Yes</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">"This Is The USA"?</td>
                            <td class="right">
                                <select id="editNationUSA" class="defineUSA" style="width:99%;">
                                    <option value="0">No</option>
                                    <option value="1">Yes</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Use Hardcoded ML Player Origins</td>
                            <td class="right">
                                <select id="editNationHardcoded" class="defineHardcoded" style="width:99%;">
                                    <option value="0">No</option>
                                    <option value="1">Yes</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Name (Korean):</td>
                            <td class="right"><input type="text" class="centerText" id="editNationNameK" value=""></td>
                        </tr>
                        <tr>
                            <td class="left">Short (Korean):</td>
                            <td class="right"><input type="text" class="centerText" id="editNationShortK" value=""></td>
                        </tr>
                        <tr>
                            <td class="left">Abbr. (Korean):</td>
                            <td class="right"><input type="text" class="centerText" id="editNationAbbrK" value=""></td>
                        
                        </tr>
                        <tr>    
                            <td class="left">Demonym (Korean):</td>
                            <td class="right"><input type="text" class="centerText" id="editNationDemK" value=""></td>
                        </tr>
                        <tr>
                            <td class="left">Time Zone:</td>
                            <td class="right">
                                <select class="tzSelect" id="editNationTimeZone" style="width:100%;">
                                </select>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <br>
                    <div style="text-align:center;">
                        <input type="submit" id="editNationSubmit" value="Submit Changes">
                    </div>
                </form>   
            </div>
            <div id="editState" class="rightDiv">
                <h2 style="text-align:center;">Edit State</h2>
                <form id="editStateForm">
                    <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
                        <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                        <tbody>
                        <tr>
                            <td class="left">ID:</td>
                            <td class="right"><input style="display:none;" type='text' id='editStateId' class="centerText"><span id="editStateIDDisplay">0</span></td>
                        </tr>
                        <tr>
                            <td class="left">Name:</td>
                            <td class="right"><input type="text" style="width:96%;" class="centerText toKorean" id="editStateName" value="" required></td>
                        </tr>
                        <tr>
                            <td class="left">Abbreviation:</td>
                            <td class="right"><input type="text" style="width:96%;" class="centerText toKorean" id="editStateAbbr" value="" required></td>
                        </tr>
                        <tr>
                            <td class="left">Population:</td>
                            <td class="right"><input type="number" style="width:96%;"id="editStatePopulation" value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Time Zone:</td>
                            <td class="right"><select class="tzSelect" id="editStateTimeZone" style="width:99%;"></select></td>
                        </tr>
                        <tr>
                            <td class="left">Observes DST:</td>
                            <td class="right">
                                <select id="editStateDST" style="width:99%;">
                                    <option value="0">No</option>
                                    <option value="1">Yes</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Latitude:</td>
                            <td class="right"><input type="text" style="width:96%;" id="editStateLatitude" value="00.00000" pattern="-?\d{1,3}\.\d+"></td>
                        </tr>
                        <tr>
                            <td class="left">Longitude:</td>
                            <td class="right"><input type="text" style="width:96%;" id="editStateLongitude" value="00.00000" pattern="-?\d{1,3}\.\d+"></td>
                        </tr>
                        <tr>
                            <td class="left">Name (Korean):</td>
                            <td class="right"><input type="text" style="width:96%;"id="editStateNameK" value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Abbreviation (Korean):</td>
                            <td class="right"><input type="text" style="width:96%;" id="editStateAbbrK" value="0"></td>
                        </tr>
                        </tbody>
                    </table>
                    <br>
                    <div style="text-align:center;">
                        <input type="submit" id="editStateSubmit" value="Submit Changes">
                    </div>
                </form>
            </div>
            <div id="editCity" class="rightDiv">
                <h2 style="text-align:center;">Edit City</h2>
                <form id="editCityForm">
                    <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
                        <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                        <tbody>
                        <tr>
                            <td class="left">ID:</td>
                            <td class="right"><input style="display:none;" type='text' id='editCityId' class="centerText"><span id="editCityIDDisplay">0</span></td>
                        </tr>   
                        <tr>
                            <td class="left">Name:</td>
                            <td class="right"><input type="text" style="width:97%;" class="centerText toKorean" id="editCityName" value="" required></td>
                        </tr>
                        <tr>
                            <td class="left">Abbreviation:</td>
                            <td class="right"><input type="text" style="width:97%;" class="centerText toKorean" id="editCityAbbr" value="" required></td>
                        </tr>
                        <tr>
                            <td class="left">Population:</td>
                            <td class="right"><input type="number" style="width:97%;" id="editCityPopulation" value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Time Zone:</td>
                            <td class="right"><select class="tzSelect" id="editCityTimeZone" style="width:99%;"></select></td>
                        </tr>
                        <tr>
                            <td class="left">National Capitol:</td>
                            <td class="right">
                                <select style="width:99%;" id="editCityCapitol" style="width:99%;">
                                    <option value="0">No</option>
                                    <option value="1">Yes</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Observes DST:</td>
                            <td class="right">
                                <select style="width:99%;" id="editCityDST" style="width:99%;">
                                    <option value="0">No</option>
                                    <option value="1">Yes</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Latitude:</td>
                            <td class="right"><input type="text" style="width:97%;" id="editCityLatitude" value="00.00000" pattern="-?\d{1,3}\.\d+"></td>
                        </tr>
                        <tr>
                            <td class="left">Longitude:</td>
                            <td><input type="text" style="width:97%;" id="editCityLongitude" value="00.00000" pattern="-?\d{1,3}\.\d+"></td>
                        </tr>
                        <tr>
                            <td class="left">Altitude:</td>
                            <td class="right">
                                <select style="width:99%;" id='editCityAltitude'> 
                                    <option value='0'>~0 m</option>
                                    <option value='1'>~500 m</option>
                                    <option value='2'>~1000 m</option>
                                    <option value='3'>~1500 m</option>
                                    <option value='4'>~2000 m</option>
                                    <option value='5'>~2500 m</option>
                                    <option value='6'>~3000 m</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left">Name (Korean):</td>
                            <td class="right"><input type="text" style="width:97%;" id="editCityNameK" value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Abbreviation (Korean):</td>
                            <td class="right"><input type="text" style="width:97%;" id="editCityAbbrK" value="0"></td>
                        </tr>
                        </tbody>
                    </table>
                    <br>
                    <div style="text-align:center;">
                        <input type="submit" id="editCitySubmit" value="Submit Changes">
                    </div>
                </form>
            </div>
            <div id="editRegion" class="rightDiv">
                <h2 style="text-align:center;">Add Region</h2>
                <form id="editRegionForm">
                    <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
                        <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                        <tbody>
                        <tr>
                            <td class="left">ID:</td>
                            <td class="right"><input type='text' style="display:none;" name='editRegionID' id='editRegionID' class="centerText"><span id="editRegionIdDisplay"></span></td>
                        </tr>
                        <tr>
                            <td class="left">Name:</td>
                            <td class="right"><input type="text" class="centerText toKorean" name="editRegionName" id="editRegionName" required></td>
                        </tr>
                        <tr>
                            <td class="left">Name (Korean):</td>
                            <td class="right"><input type="text" class="centerText" name="editRegionNameK" id="editRegionNameK"></td>
                        </tr>
                        <tr>
                            <td class="left">Region Source:</td>
                            <td class="right">
                                <select id="editRegionSource" style="width:100%;">
                                    <option val="nations">Nations</option>
                                    <option val="states">States</option>
                                    <option val="cities">Cities</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="left"><span id="editFilterLabel">Nations</span> From:</td>
                            <td class="right">
                                <select id="editRegionFilter" style="width:100%;"></select>
                            </td>
                        </tr>
                        <tr id="editSourceStateRow" style="display:none;">
                            <td class="left">Source State:</td>
                            <td class="right">
                                <select id="editRegionSubFilter" style="width:100%;"></select>
                            </td>
                        </tr>
                        </tbody>
                </table>
                <br/>
                <div class="row">
                    <div class="col-xs-5">
                        <select name="from[]" id="edit_multi_d" class="form-control" size="26" multiple="multiple" style="height:500px;">
                            
                        </select>
                    </div>
                    
                    <div class="col-xs-2">
                        <button type="button" id="edit_multi_d_rightAll" class="btn btn-default btn-block" style="margin-top: 265px;"><i class="glyphicon glyphicon-forward"></i></button>
                        <button type="button" id="edit_multi_d_rightSelected" class="btn btn-default btn-block"><i class="glyphicon glyphicon-chevron-right"></i></button>
                        <button type="button" id="edit_multi_d_leftSelected" class="btn btn-default btn-block"><i class="glyphicon glyphicon-chevron-left"></i></button>
                        <button type="button" id="edit_multi_d_leftAll" class="btn btn-default btn-block"><i class="glyphicon glyphicon-backward"></i></button>
                    </div>
                    
                    <div class="col-xs-5">
                        <b>Nations</b>
                        <fieldset id="editRegionFields" required>
                        <select name="to[]" id="edit_multi_d_to" class="form-control nrTarget" size="8" multiple="multiple" style="height:157px;" required oninvalid="this.setCustomValidity('At least one Nation, State, or City must be chosen')" oninput="this.setCustomValidity('')"></select>
                        
                        
                        <b>States</b>
                        <select name="to_2[]" id="edit_multi_d_to_2" class="form-control nrTarget" size="8" multiple="multiple" style="height:157px;" required oninvalid="this.setCustomValidity('At least one Nation, State, or City must be chosen')" oninput="this.setCustomValidity('')"></select>

                        
                        <b>Cities</b>
                        <select name="to_2[]" id="edit_multi_d_to_3" class="form-control nrTarget" size="8" multiple="multiple" style="height:157px;" required oninvalid="this.setCustomValidity('At least one Nation, State, or City must be chosen')" oninput="this.setCustomValidity('')"></select>
                        </fieldset>
                    </div>
                </div>
                <div style="text-align:center; margin-top:10px;">
                    <input type="submit" id="editRegionSubmit" value="Submit Changes">
                </div>
                </form>
            </div>

            <!--DIVS FOR MOVING-->
            <div id="moveNation" class="rightDiv">
                <h2 style="text-align:center;">Move Nation</h2>
                <form id="moveNationForm" action="">
                    <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
                        <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                        <tbody>
                        <tr>
                            <td>Move To Continent:</td>
                            <td><select id="moveNationToContinent" style="width:100%;"></select></td>
                        </tr>
                        </tbody>
                    </table><br>
                    <div style="text-align:center;">
                        <input type="submit" id="submitNationMove" value="Move Nation">
                    </div>
                </form>
            </div>
            <div id="moveState" class="rightDiv">
                <h2 style="text-align:center;">Move State</h2>
                <form id="moveStateForm" action="">
                    <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
                        <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                        <tbody>
                        <tr>
                            <td>Move To Continent:</td>
                            <td><select id="moveStateToContinent" style="width:100%;"></select></td>
                        </tr>
						<tr>
                            <td>Move To Nation:</td>
                            <td><select id="moveStateToNation" style="width:100%;"></select></td>
                        </tr>
                        </tbody>
                    </table><br>
                    <div style="text-align:center;">
                        <input type="submit" id="submitStateMove" value="Move State">
                    </div>
                </form>
            </div>
            <div id="moveCity" class="rightDiv">
                <h2 style="text-align:center;">Move City</h2>
                <form id="moveCityForm" action="">
                    <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
                        <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                        <tbody>
                        <tr>
                            <td>Move To Continent:</td>
                            <td><select id="moveCityToContinent" style="width:100%;"></select></td>
                        </tr>
						<tr>
                            <td>Move To Nation:</td>
                            <td><select id="moveCityToNation" style="width:100%;"></select></td>
                        </tr>
						<tr>
                            <td>Move To State:</td>
                            <td><select id="moveCityToState" style="width:100%;"></select></td>
                        </tr>
                        </tbody>
                    </table><br>
                    <div style="text-align:center;">
                        <input type="submit" id="submitCityMove" value="Move City">
                    </div>
                </form>
            </div>

            <!--GENERAL INFORMATION DIV-->
            <div id="infoPanel" class="rightDiv">    
            </div>
        </div>
    </div>

    <div class="section group" style="position: absolute; bottom: 20px; width:100%;">
        <table style="width:90%; margin: 0 auto; font-size:0.7em;">
            <tr>
                <td>CONTINENTS: <span id="continent_count">0</span></td>
                <td>NATIONS: <span id="nation_count">0</span></td>
                <td>STATES: <span id="state_count">0</span></td>
                <td>CITIES: <span id="city_count">0</span></td>
                <td>ETHNICITIES: <span id="ethnicity_count">0</span></td>
                <td>REGIONS: <span id="region_count">0</span></td>
                <td>USA DEFINED: <span id="usa_defined_count">0</span></td>
            </tr>
            <tr>
                <td>MAX_CONTINENT_ID: <span id="max_continent_id">0</span></td>
                <td>MAX_NATION_ID: <span id="max_nation_id">0</span></td>
                <td>MAX_STATE_ID: <span id="max_state_id">0</span></td>
                <td>MAX_CITY_ID: <span id="max_city_id">0</span></td>
                <td>MAX_ETHNICITY_ID: <span id="max_ethnicity_id">0</span></td>
                <td>MAX_REGION_ID: <span id="max_region_id">0</span></td>
                <td></td>
            </tr>
        </table>    
    </div>

    <div id="wizardContainer" class="white-popup mfp-hide">
        <div id="smartwizard">
            <ul class="nav">
                <li class="nav-item">
                <a class="nav-link" href="#step-1">
                    <div class="num">1</div>
                    Ethnicity
                </a>
                </li>
                <li class="nav-item">
                <a class="nav-link" href="#step-2">
                    <span class="num">2</span>
                    Continent
                </a>
                </li>
                <li class="nav-item">
                <a class="nav-link" href="#step-3">
                    <span class="num">3</span>
                    Nation
                </a>
                </li>
                <li class="nav-item">
                <a class="nav-link " href="#step-4">
                    <span class="num">4</span>
                    State
                </a>
                <li class="nav-item">
                <a class="nav-link " href="#step-5">
                    <span class="num">5</span>
                    State
                </a>
                </li>
            </ul>
        
            <div class="tab-content">
                <div id="step-1" class="tab-pane" role="tabpanel" aria-labelledby="step-1">
                    <h2 style="text-align:center;">Add First Ethnicity</h2>
                    <form id="form-1" action="">
                    <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
                        <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                        <tbody>
                        <tr>
                            <td class="left">Name:</td>
                            <td class="right"><input type='text' style="width:95%;" id='firstEthnicityName' class="centerText toKorean" required value=""></td>
                        </tr>
                        <tr>
                            <td class="left">Name (Korean):</td>
                            <td class="right"><input type='text' style="width:95%;" id='firstEthnicityNameK' class="centerText"></td>
                        </tr>
                        <tr>
                            <td class="left">African:</td>
                            <td class="right"><input type='number' style="width:95%;" class='firstEthPct' min='0' max='1000' id='firstEthnicityAfrican' value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Asian:</td>
                            <td class="right"><input type='number' style="width:95%;" class='firstEthPct' min='0' max='1000' id='firstEthnicityAsian' value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">East Indian:</td>
                            <td class="right"><input type='number' style="width:95%;" class='firstEthPct' min='0' max='1000' id='firstEthnicityEastIndian' value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Caucasian:</td>
                            <td class="right"><input type='number' style="width:95%;" class='firstEthPct' min='0' max='1000' id='firstEthnicityCaucasian' value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Hispanic:</td>
                            <td class="right"><input type='number' style="width:95%;" class='firstEthPct' min='0' max='1000' id='firstEthnicityHispanic' value="0"></td>
                        </tr>
                        <tr>
                            <td class="left">Total:</td>
                            <td class="right"><input type='number' min='1000' max='1000' class="readonly centerText" style="width:95%;" id='firstEthnicityTotal' class="centerText" pattern="1000" value="0"></td>
                        </tr>
                        </tbody>
                    </table>
                </form>
                </div>
                <div id="step-2" class="tab-pane" role="tabpanel" aria-labelledby="step-2">
                    <h2 style="text-align:center;">Add First Continent</h2>
                    <form id="form-2" action="">
                        <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
                            <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                            <tbody>
                            <tr>
                                <td class="left">Name:</td>
                                <td class="right"><input style="width:95%;" type="text" class="centerText toKorean" name="firstContinentName" id="firstContinentName" required value=""></td>
                            </tr>
                            <tr>
                                <td class="left">Abbreviation:</td>
                                <td class="right"><input style="width:95%;" type="text" class="centerText toKorean" name="firstContinentAbbr" id="firstContinentAbbr" required value=""></td>
                            </tr>
                            <tr>
                                <td class="left">Demonym:</td>
                                <td class="right"><input style="width:95%;" type="text" class="centerText toKorean" name="firstContinentDem" id="firstContinentDem" required value=""></td>
                            </tr>
                            <tr>
                                <td class="left">Population:</td>
                                <td class="right"><input style="width:95%;" type="number" class="centerText" name="firstContinentPop" id="firstContinentPop" value="0"></td>
                            </tr>
                            <tr>
                                <td class="left">Name (Korean):</td>
                                <td class="right"><input style="width:95%;" type="text" class="centerText" name="firstContinentNameK" id="firstContinentNameK" value=""></td>
                            </tr>
                            <tr>
                                <td class="left">Abbreviation (Korean):</td>
                                <td class="right"><input style="width:95%;" type="text" class="centerText" name="firstContinentAbbrK" id="firstContinentAbbrK" value=""></td>
                            </tr>
                            <tr>
                                <td class="left">Demonym (Korean):</td>
                                <td class="right"><input style="width:95%;" type="text" class="centerText" name="firstContinentDemK" id="firstContinentDemK" value=""></td>
                            </tr>
                            </tbody>
                        </table>
                    </form>
                </div>
                <div id="step-3" class="tab-pane" role="tabpanel" aria-labelledby="step-3">
                    <h2 style="text-align:center;">Add First Nation</h2>
                    <form id="form-3">
                        <table class="headlessTable cell-border compact stripe" style="width:95%; margin:0 auto;">
                            <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                            <tbody>
                            <tr>
                                <td class="left">Name:</td>
                                <td class="right"><input type="text" class="centerText toKorean" id="firstNationName" required value=""></td>
                            </tr>
                            <tr>
                                <td class="left">Abbreviation:</td>
                                <td class="right"><input type="text" class="centerText toKorean" id="firstNationAbbr" required value=""></td>
                            </tr>
                            <tr>
                                <td class="left">Demonym:</td>
                                <td class="right"><input type="text" class="centerText toKorean" id="firstNationDem" required value=""></td>
                            </tr>
                            <tr>
                                <td class="left">Population:</td>
                                <td class="right"><input type="number" id="firstNationPopulation" value="0"></td>
                            </tr>
                            <tr>
                                <td class="left">Gender:</td>
                                <td class="right">
                                    <select id="firstNationGender" style="width:99%;">
                                        <option value="0">Male</option>
                                        <option value="1">Female</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="left">Baseball Quality:</td>
                                <td class="right">
                                    <select id="firstNationBbqual" style="width:99%;">
                                        <option value="5">5: Excellent</option>
                                        <option value="4">4: Good</option>
                                        <option value="3" selected>3: Average</option>
                                        <option value="2">2: Fair</option>
                                        <option value="1">1: Poor</option>
                                        <option value="0">Non-Existent</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="left">Observes DST:</td>
                                <td class="right">
                                    <select id="firstNationDST" style="width:99%;">
                                        <option value="0">No</option>
                                        <option value="1">Yes</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="left">"This Is The USA"?</td>
                                <td class="right">
                                    <select id="firstNationUSA" class="defineUSA" style="width:99%;">
                                        <option value="0">No</option>
                                        <option value="1">Yes</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="left">Use Hardcoded ML Player Origins</td>
                                <td class="right">
                                    <select id="firstNationHardcoded" class="defineHardcoded" style="width:99%;">
                                        <option value="0">No</option>
                                        <option value="1">Yes</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="left">Name (Korean):</td>
                                <td class="right"><input type="text" class="centerText" id="firstNationNameK" value=""></td>
                            </tr>
                            <tr>
                                <td class="left">Short (Korean):</td>
                                <td class="right"><input type="text" class="centerText" id="firstNationShortK" value=""></td>
                            </tr>
                            <tr>
                                <td class="left">Abbr. (Korean):</td>
                                <td class="right"><input type="text" class="centerText" id="firstNationAbbrK" value=""></td>
                            
                            </tr>
                            <tr>    
                                <td class="left">Demonym (Korean):</td>
                                <td class="right"><input type="text" class="centerText" id="firstNationDemK" value=""></td>
                            </tr>
                            <tr>
                                <td class="left">Time Zone:</td>
                                <td class="right">
                                    <select class="tzSelect" id="firstNationTimeZone" style="width:100%;">
                                    </select>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </form> 
                </div>
                <div id="step-4" class="tab-pane" role="tabpanel" aria-labelledby="step-4">
                    <h2 style="text-align:center;">Add First State</h2>
                        <form id="form-4">
                        <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
                            <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                            <tbody>
                            <tr>
                                <td class="left">Name:</td>
                                <td class="right"><input type="text" style="width:96%;" class="centerText toKorean" id="firstStateName" required value=""</td>
                            </tr>
                            <tr>
                                <td class="left">Abbreviation:</td>
                                <td class="right"><input type="text" style="width:96%;" class="centerText toKorean" id="firstStateAbbr" required value=""></td>
                            </tr>
                            <tr>
                                <td class="left">Population:</td>
                                <td class="right"><input type="number" style="width:96%;"id="firstStatePopulation" value="0"></td>
                            </tr>
                            <tr>
                                <td class="left">Time Zone:</td>
                                <td class="right"><select class="tzSelect" id="firstStateTimeZone" style="width:99%;"></select></td>
                            </tr>
                            <tr>
                                <td class="left">Observes DST:</td>
                                <td class="right">
                                    <select id="firstStateDST" style="width:99%;">
                                        <option value="0">No</option>
                                        <option value="1">Yes</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="left">Latitude:</td>
                                <td class="right"><input type="text" style="width:96%;" id="firstStateLatitude" value="00.00000" pattern="-?\d{1,3}\.\d+"></td>
                            </tr>
                            <tr>
                                <td class="left">Longitude:</td>
                                <td class="right"><input type="text" style="width:96%;" id="firstStateLongitude" value="00.00000" pattern="-?\d{1,3}\.\d+"></td>
                            </tr>
                            <tr>
                                <td class="left">Name (Korean):</td>
                                <td class="right"><input type="text" style="width:96%;"id="firstStateNameK" value="0"></td>
                            </tr>
                            <tr>
                                <td class="left">Abbreviation (Korean):</td>
                                <td class="right"><input type="text" style="width:96%;" id="firstStateAbbrK" value="0"></td>
                            </tr>
                            </tbody>
                        </table>
                    </form>
                </div>
                <div id="step-5" class="tab-pane" role="tabpanel" aria-labelledby="step-5">
                    <h2 style="text-align:center;">Add First City</h2>
                        <form id="form-5">
                        <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
                            <thead style="display:none;"><tr><td></td><td></td></tr></thead>
                            <tbody>
                            <tr>
                                <td class="left">Name:</td>
                                <td class="right"><input type="text" style="width:97%;" class="centerText toKorean" id="firstCityName" required value=""></td>
                            </tr>
                            <tr>
                                <td class="left">Abbreviation:</td>
                                <td class="right"><input type="text" style="width:97%;" class="centerText toKorean" id="firstCityAbbr" required value=""></td>
                            </tr>
                            <tr>
                                <td class="left">Population:</td>
                                <td class="right"><input type="number" style="width:97%;" id="firstCityPopulation" value="0"></td>
                            </tr>
                            <tr>
                                <td class="left">Time Zone:</td>
                                <td class="right"><select class="tzSelect" id="firstCityTimeZone" style="width:99%;"></select></td>
                            </tr>
                            <tr>
                                <td class="left">National Capitol:</td>
                                <td class="right">
                                    <select style="width:99%;" id="firstCityCapitol" style="width:99%;">
                                        <option value="0">No</option>
                                        <option value="1">Yes</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="left">Observes DST:</td>
                                <td class="right">
                                    <select style="width:99%;" id="firstCityDST" style="width:99%;">
                                        <option value="0">No</option>
                                        <option value="1">Yes</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="left">Latitude:</td>
                                <td class="right"><input type="text" style="width:97%;" id="firstCityLatitude" value="00.00000" pattern="-?\d{1,3}\.\d+"></td>
                            </tr>
                            <tr>
                                <td class="left">Longitude:</td>
                                <td><input type="text" style="width:97%;" id="firstCityLongitude" value="00.00000" pattern="-?\d{1,3}\.\d+"></td>
                            </tr>
                            <tr>
                                <td class="left">Altitude:</td>
                                <td class="right">
                                    <select style="width:99%;" id='firstCityAltitude'> 
                                        <option value='0'>~0 m</option>
                                        <option value='1'>~500 m</option>
                                        <option value='2'>~1000 m</option>
                                        <option value='3'>~1500 m</option>
                                        <option value='4'>~2000 m</option>
                                        <option value='5'>~2500 m</option>
                                        <option value='6'>~3000 m</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="left">Name (Korean):</td>
                                <td class="right"><input type="text" style="width:97%;" id="firstCityNameK"></td>
                            </tr>
                            <tr>
                                <td class="left">Abbreviation (Korean):</td>
                                <td class="right"><input type="text" style="width:97%;" id="firstCityAbbrK"></td>
                            </tr>
                            </tbody>
                        </table>
                    </form>
                </div>
            </div>
        
            <!-- Include optional progressbar HTML -->
            <div class="progress">
            <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </div>  
    </div>
    <div id="FAQ" class="faq-white-popup mfp-hide">
        <div style="width:100%; text-align:center;">	
			<span class="header">About The OOTP World Editor</span><div id="currentVersion"></div>
		</div>
        <div id="faqContainer" style="width:100%; height:90%; overflow:auto;">
			<div class="question" style="margin-top:10px!important;">So what is this thing?</div><br>
			<div class="answer">This is a utility designed to make it easy to create and edit "world" xml files for Out Of The Park Baseball 24 and newer.  It may work with older versions, but it may not.</div><br>
			<div class="question">What is Out Of The Park Baseball?</div><br>
			<div class="answer">Out Of The Park Baseball is an award winning baseball management simulation published by OOTP Developments.  For more information about OOTP, as well as the other games they make, <a href="http://www.ootpdevelopments.com" target="_blank">visit their site</a>.</div><br>
			<div class="question">How did you do this?</div><br>
			<div class="answer">The World Editor is built using <a href="https://nodejs.org/en/about/" target="_blank">Node.js</a> and <a href="https://www.electronjs.org/" target="_blank">Electron</a>.  So it's written entirely in HTML and JavaScript like pretty much any website.</div></br>
			<div class="question">Who is responsible for this thing?</div>
			<div class="answer">That would be me.  My name is Eriq Jaffe, and I've been playing OOTP Baseball since 2004.  Feel free to <a href="mailto:eriqjaffe@gmail.com">shoot me an email</a> with any questions or comments.  You can also view the source code for this on <a href="https://github.com/eriqjaffe/OOTP-World-Editor" target="_blank">GitHub</a>.<br><br>The background image is modified from an image by <a href="https://commons.wikimedia.org/wiki/File:Mercator_world_map_(physical,_political,_population).jpg" target="_blank">Janwillemvanaalst</a>, <a href="https://creativecommons.org/licenses/by/4.0" target="_blank">CC BY 4.0</a>, via Wikimedia Commons.</div><br>
		</div>
    </div>
    <div id="warning" class="faq-white-popup mfp-hide">
        <div style="width:100%; text-align:center;">	
			<span class="header" style="color:red;">WARNING!!!</span><br><br>
            <span class="warning">THIS IS A BETA APPLICATION</span><br><br>
            <span class="warning">MAKE SURE YOU BACK UP OR USE A COPY OF YOUR WORLD_DEFAULT.XML</span><br><br>
            <span class="warning">I TAKE NO RESPONSIBILITY FOR ANYTHING THAT HAPPENS BECAUSE YOU ARE USING THIS PROGRAM</span><br><br>
            <span class="warning">SERIOUSLY</span><br><br>
            <span class="warning">FOR REALS</span><br><br><br><br><br><br>
            <input type="button" id="warningAck" value="OK, OK, OK, I get it already.  Sheesh!">
		</div>
    </div>
    <div id="bulkRegionImport" class="faq-white-popup mfp-hide">
        <h2 style="text-align:center;" id="importRegionsHeader">Import Regions From File</h2>
        <form id="bulkRegionForm" action="">
        <br>
        <div style="text-align:center;">
            <input type="submit" class="submit" value="Import Region">
            <br><br>
            <div id="regionImportProgressParent" style="width: 100%; display: inline-block;">
            <span id="regionImportProgressLabel">&nbsp;</span><br>
            <div id="regionImportProgress"></div>
            </div>
        </div>
        </form>
    </div>
    <div id="bulkEthnicityImport" class="faq-white-popup mfp-hide">
        <h2 style="text-align:center;" id="importEthnicitiesHeader">Import Ethnicities From File</h2>
        <form id="bulkEthnicityForm" action="">
        <br>
        <div style="text-align:center;">
            <input type="submit" class="submit" value="Import Ethnicities">
            <br><br>
            <div id="ethnicityImportProgressParent" style="width: 100%; display: inline-block;">
            <span id="ethnicityImportProgressLabel">&nbsp;</span><br>
            <div id="ethnicityImportProgress"></div>
            </div>
        </div>
        </form>
    </div>
    <div id="bulkContinentImport" class="faq-white-popup mfp-hide">
        <h2 style="text-align:center;" id="importContinentsHeader">Import Continents From File</h2>
        <form id="bulkContinentForm" action="">
        <br>
        <div style="text-align:center;">
            <input type="submit" class="submit" value="Import Continents">
            <br><br>
            <div id="continentImportProgressParent" style="width: 100%; display: inline-block;">
            <span id="continentImportProgressLabel">&nbsp;</span><br>
            <div id="continentImportProgress"></div>
            </div>
        </div>
        </form>
    </div>
    <div id="bulkNationImport" class="faq-white-popup mfp-hide">
        <h2 style="text-align:center;" id="importNationsHeader">Import Nations From File</h2>
        <form id="bulkNationForm" action="">
        <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
            <thead style="display:none;"><tr><td></td><td></td></tr></thead>
            <tbody>
            <tr>
                <td class="left">Continent:</td>
                <td class="right"><select id="bulkNationContinent" style="width:99%;"></select></td>
            </tr>
            </tbody>
        </table><br>
        <div style="text-align:center;">
            <input type="submit" class="submit" value="Import Nations">
            <br><br>
            <div id="nationImportProgressParent" style="width: 100%; display: inline-block;">
            <span id="nationImportProgressLabel">&nbsp;</span><br>
            <div id="nationImportProgress"></div>
            </div>
        </div>
        </form>
    </div>
    <div id="bulkStateImport" class="faq-white-popup mfp-hide">
        <h2 style="text-align:center;" id="importStatesHeader">Import States From File</h2>
        <form id="bulkStateForm" action="">
        <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
            <thead style="display:none;"><tr><td></td><td></td></tr></thead>
            <tbody>
            <tr>
                <td class="left">Continent:</td>
                <td class="right"><select id="bulkStateContinent" style="width:99%;"></select></td>
            </tr>
            <tr>
                <td class="left">Nation:</td>
                <td class="right"><select id="bulkStateNation" style="width:99%;"></select></td>
            </tr>
            </tbody>
        </table><br>
        <div style="text-align:center;">
            <input type="submit" class="submit" value="Import States">
            <br><br>
            <div id="stateImportProgressParent" style="width: 100%; display: inline-block;">
            <span id="stateImportProgressLabel">&nbsp;</span><br>
            <div id="stateImportProgress"></div>
            </div>
        </div>
        </form>
    </div>
    <div id="bulkCityImport" class="faq-white-popup mfp-hide">
        <h2 style="text-align:center;" id="importCitiesHeader">Import Cities From File</h2>
        <form id="bulkCityForm" action="">
        <table class="headlessTable cell-border compact stripe" style="width:80%; margin:0 auto;">
            <thead style="display:none;"><tr><td></td><td></td></tr></thead>
            <tbody>
            <tr>
                <td class="left">Continent:</td>
                <td class="right"><select id="bulkCityContinent" style="width:99%;"></select></td>
            </tr>
            <tr>
                <td class="left">Nation:</td>
                <td class="right"><select id="bulkCityNation" style="width:99%;"></select></td>
            </tr>
            <tr>
                <td class="left">State:</td>
                <td class="right"><select id="bulkCityState" style="width:99%;"></select></td>
            </tr>
            </tbody>
        </table><br>
        <div style="text-align:center;">
            <input type="submit" class="submit" value="Import Cities">
            <br><br>
            <div id="cityImportProgressParent" style="width: 100%; display: inline-block;">
            <span id="cityImportProgressLabel"></span><br>
            <div id="cityImportProgress"></div>
            </div>
        </div>
        </form>
    </div>
    <input type="button" id="loadXML" value="Load XML file" style="display: none;">
    <input type="button" id="saveXML" value="Save XML file" style="display: none;">
    <input type="button" id="closeXML" value="Close XML file" style="display: none;">
    <input type="button" id="newXML" value="New XML file" style="display: none;">
    <input type="button" class="button" id="addEthnicityTrigger" value="Add Ethnicity" style="display:none;">
    <input type="button" class="button" id="addContinentTrigger" value="Add Continent" style="display:none;">
    <input type="button" class="button" id="addNationTrigger" value="Add Nation" style="display:none;">
    <input type="button" class="button" id="addStateTrigger" value="Add State" style="display:none;">
    <input type="button" class="button" id="addCityTrigger" value="Add City" style="display:none;">
    <input type="button" class="button" id="addRegionTrigger" value="Add Region" style="display:none;">
    <input type="button" class="button" id="about" value="About World Editor" style="display:none;">
    <input type="button" class="button" id="bulkImportCities" value="Bulk Import Cities" style="display:none;">
    <input type="button" class="button" id="bulkImportStates" value="Bulk Import States" style="display:none;">
    <input type="button" class="button" id="bulkImportNations" value="Bulk Import Nations" style="display:none;">
    <input type="button" class="button" id="bulkImportContinents" value="Bulk Import Continents" style="display:none;">
    <input type="button" class="button" id="bulkImportEthnicities" value="Bulk Import Ethnicities" style="display:none;">
    <input type="button" class="button" id="bulkImportRegions" value="Bulk Import Regions" style="display:none;">
    <div style="display:none;"><img src="./images/trash-solid.svg" id="rejectDrop" height="10px"></div>
    
<script>
    require('./renderer.js')

    var fancyTreeReady = false;

    ipcRenderer.on('open-warning', (event, data) => {
        $.magnificPopup.open({
            items: {
                src: '#warning',
                type: 'inline'
            },
            focus: '#warningAck',
            closeOnBgClick: false,
            enableEscapeKey: false,
            showCloseBtn:false
        });
    }) 

     ipcRenderer.on('load-debug', (event, data) => {
        console.log("loading debug!")
        ipcRenderer.send('debug-load', null)
    })

    $(document).ready(function() {

        ipcRenderer.send('check-for-debug', null)

        ipcRenderer.send('get-version', null)
        
        for (z of time_zones) {
            $(".tzSelect").each(function() {
                $(this).append($('<option>', { value : z.tz })
                .text(z.loc));
            })
        }

        $(".tzSelect").each(function() {
            $(this).children(':nth-child(14)').prop('selected', true);
        })

        $('#multi_d').multiselect({
            right: '#multi_d_to, #multi_d_to_2, #multi_d_to_3',
            rightSelected: '#multi_d_rightSelected',
            leftSelected: '#multi_d_leftSelected',
            rightAll: '#multi_d_rightAll',
            leftAll: '#multi_d_leftAll',
    
            search: {
                left: '<input type="text" name="q" class="form-control" placeholder="Search..." />'
            },

            
    
            moveToRight: function(Multiselect, $options, event, silent, skipStack) {
                var destination = null;
                var target = null;
                var button = $(event.currentTarget).attr('id');
                
                switch ($("#newRegionSource").val()) {
                    case ("Nations"):
                        destination = Multiselect.$right.eq(0)
                        target = "multi_d_to"
                        break;
                    case ("States"):
                        destination = Multiselect.$right.eq(1)
                        target = "multi_d_to2"
                        break;
                    case ("Cities"):
                        destination = Multiselect.$right.eq(2)
                        target = "multi_d_to3"
                        break;
                }
    
                if (button == 'multi_d_rightSelected') {
                    var $left_options = Multiselect.$left.find('> option:selected');

                    destination.append($left_options);

                    var usedNames = {};
                    $("#"+target+" > option").each(function () {
                        if(usedNames[this.text]) {
                            $(this).remove();
                        } else {
                            usedNames[this.text] = this.value;
                        }
                    });
    
                    if ( typeof Multiselect.callbacks.sort == 'function' && !silent ) {
                        destination.find('> option').sort(Multiselect.callbacks.sort).appendTo(destination);
                    }
                    
                } else if (button == 'multi_d_rightAll') {
                    var $left_options = Multiselect.$left.children(':visible');
                    destination.append($left_options);
    
                    var usedNames = {};
                    $("#multi_d > option").each(function () {
                        if(usedNames[this.text]) {
                            $(this).remove();
                        } else {
                            usedNames[this.text] = this.value;
                        }
                    });

                    if ( typeof Multiselect.callbacks.sort == 'function' && !silent ) {
                        destination.find('> option').sort(Multiselect.callbacks.sort).appendTo(destination);
                    }
                }

                var req = ($('#multi_d_to option').length + $('#multi_d_to_2 option').length + $('#multi_d_to_3 option').length == 0) ? true : false

                $(".nrTarget").each(function() {
                    $(this).prop('required',req);
                })

                if ($("#newRegionSource").val() == "Cities") {
                    $("#newRegionSubFilter").trigger("change")
                } else {
                    $("#newRegionFilter").trigger("change")
                }
                
            },

            moveToLeft: function(Multiselect, $options, event, silent, skipStack) {
                var button = $(event.currentTarget).attr('id');
                var src = null;
                
                switch ($("#newRegionSource").val()) {
                    case ("Nations"):
                        src = Multiselect.$right.eq(0)
                        break;
                    case ("States"):
                        src = Multiselect.$right.eq(1)
                        break;
                    case ("Cities"):
                        src = Multiselect.$right.eq(2)
                        break;
                }

                var src_id = $(src[0]).attr("id")

                if (button == 'multi_d_leftSelected') {
                    $("#"+$(src[0]).attr("id")+" > option:selected").each(function() {
                        $(this).remove()
                    })
                } else if (button == 'multi_d_leftAll') {
                    $("#"+$(src[0]).attr("id")+" > option:visible").each(function() {
                        $(this).remove()
                    })
                }

                $("#"+$(src[0]).attr("id")).html($('#'+$(src[0]).attr("id")+' option').sort(function(x, y) {
                    return $(x).text().toLowerCase() < $(y).text().toLowerCase() ? -1 : 1;
                }))

                var req = ($('#multi_d_to option').length + $('#multi_d_to_2 option').length + $('#multi_d_to_3 option').length == 0) ? true : false

                $(".nrTarget").each(function() {
                    $(this).prop('required',req);
                })
            }
        });

        $('#edit_multi_d').multiselect({
            right: '#edit_multi_d_to, #edit_multi_d_to_2, #edit_multi_d_to_3',
            rightSelected: '#edit_multi_d_rightSelected',
            leftSelected: '#edit_multi_d_leftSelected',
            rightAll: '#edit_multi_d_rightAll',
            leftAll: '#edit_multi_d_leftAll',
    
            search: {
                left: '<input type="text" name="q" class="form-control" placeholder="Search..." />'
            },

            moveToRight: function(Multiselect, $options, event, silent, skipStack) {
                var destination = null;
                var target = null;
                var button = $(event.currentTarget).attr('id');
                
                switch ($("#editRegionSource").val()) {
                    case ("Nations"):
                        destination = Multiselect.$right.eq(0)
                        target = "edit_multi_d_to"
                        break;
                    case ("States"):
                        destination = Multiselect.$right.eq(1)
                        target = "edit_multi_d_to2"
                        break;
                    case ("Cities"):
                        destination = Multiselect.$right.eq(2)
                        target = "edit_multi_d_to3"
                        break;
                }
    
                if (button == 'edit_multi_d_rightSelected') {
                    var $left_options = Multiselect.$left.find('> option:selected');

                    destination.append($left_options);

                    var usedNames = {};
                    $("#"+target+" > option").each(function () {
                        if(usedNames[this.text]) {
                            $(this).remove();
                        } else {
                            usedNames[this.text] = this.value;
                        }
                    });
    
                    if ( typeof Multiselect.callbacks.sort == 'function' && !silent ) {
                        destination.find('> option').sort(Multiselect.callbacks.sort).appendTo(destination);
                    }
                    
                } else if (button == 'edit_multi_d_rightAll') {
                    var $left_options = Multiselect.$left.children(':visible');
                    destination.append($left_options);
    
                    var usedNames = {};
                    $("#edit_multi_d > option").each(function () {
                        if(usedNames[this.text]) {
                            $(this).remove();
                        } else {
                            usedNames[this.text] = this.value;
                        }
                    });

                    if ( typeof Multiselect.callbacks.sort == 'function' && !silent ) {
                        destination.find('> option').sort(Multiselect.callbacks.sort).appendTo(destination);
                    }
                }

                var req = ($('#edit_multi_d_to option').length + $('#edit_multi_d_to_2 option').length + $('#edit_multi_d_to_3 option').length == 0) ? true : false

                $(".nrTarget").each(function() {
                    $(this).prop('required',req);
                })

                if ($("#editRegionSource").val() == "Cities") {
                    $("#editRegionSubFilter").trigger("change")
                } else {
                    $("#editRegionFilter").trigger("change")
                }
            },

            moveToLeft: function(Multiselect, $options, event, silent, skipStack) {
                var button = $(event.currentTarget).attr('id');
                var src = null;
                
                switch ($("#editRegionSource").val()) {
                    case ("Nations"):
                        src = Multiselect.$right.eq(0)
                        break;
                    case ("States"):
                        src = Multiselect.$right.eq(1)
                        break;
                    case ("Cities"):
                        src = Multiselect.$right.eq(2)
                        break;
                }

                var src_id = $(src[0]).attr("id")

                if (button == 'edit_multi_d_leftSelected') {
                    $("#"+$(src[0]).attr("id")+" > option:selected").each(function() {
                        $(this).remove()
                    })
                } else if (button == 'edit_multi_d_leftAll') {
                    $("#"+$(src[0]).attr("id")+" > option:visible").each(function() {
                        $(this).remove()
                    })
                }

                $("#"+$(src[0]).attr("id")).html($('#'+$(src[0]).attr("id")+' option').sort(function(x, y) {
                    return $(x).text().toLowerCase() < $(y).text().toLowerCase() ? -1 : 1;
                }))

                var req = ($('#edit_multi_d_to option').length + $('#edit_multi_d_to_2 option').length + $('#edit_multi_d_to_3 option').length == 0) ? true : false

                $(".nrTarget").each(function() {
                    $(this).prop('required',req);
                })
            }
        });

        $(".headlessTable").dataTable({ordering: false, scrollY: "auto"})

        ipcRenderer.send('menu-reset', null)
    })

    $("#warningAck").on("click", function(e) {
        e.preventDefault()
        $.magnificPopup.close()
    })

    $(".readonly").on('keydown paste focus mousedown', function(e){
        e.preventDefault();
    });

    $("#loadXML").on("click",function(e) {
        $("#overlay").css("display","inline-block")
        ipcRenderer.send('open-xml', null)
    })

    $("#newXML").on("click", function() {
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        if (tree != null) {
            if (confirm("Are you sure?  You currently have a file open.")) {
                if (confirm("Do you want to save your current file?")) {
                    newXML = true
                    $("#saveXML").trigger("click")
                    //startNewXML()
                } else {
                    newXML = false
                    startNewXML()
                    return
                }        
            } else {
                newXML = false
            }
        } else {
            startNewXML()
        }
    })

    function startNewXML() {
        clearRightDiv()
        nodeToEdit = null;
        max_world_id = max_continent_id = max_nation_id = max_state_id = max_city_id = max_ethnicity_id = max_region_id = max_region_sort_order = world_count = continent_count = nation_count = state_count = city_count = ethnicity_count = region_count = 0
        ethnicities_by_id = {}
        cities_by_id = {}
        states_by_id = {}
        nations_by_id = {}
        continents_by_id = {}
        regions_by_id = {}
        nations_by_continent = {}
        states_by_nation = {}
        cities_by_state = {}
        cities_by_nation = {}
        usa_defined = []
        $("#continent_count").text(continent_count)
        $("#nation_count").text(nation_count)
        $("#state_count").text(state_count)
        $("#city_count").text(city_count)
        $("#ethnicity_count").text(ethnicity_count)
        $("#region_count").text(region_count)
        $("#usa_defined_count").text(usa_defined.length)
        $("#max_continent_id").text(max_continent_id)
        $("#max_nation_id").text(max_nation_id)
        $("#max_state_id").text(max_state_id)
        $("#max_city_id").text(max_city_id)
        $("#max_ethnicity_id").text(max_ethnicity_id)
        $("#max_region_id").text(max_region_id)
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        if (tree != null) { 
            tree.destroy() 
        }

        $.magnificPopup.open({
            items: {
                src: '#wizardContainer',
                type: 'inline',
                height: 800,
                width: 1000
            },
            callbacks: {
                open: function() {
                    $(function() {
                        $('#smartwizard').smartWizard({
                            selected: 0,
                            transition: {
                                animation: 'slideHorizontal'
                            },
                            toolbar: {
                                showNextButton: true, // show/hide a Next button
                                showPreviousButton: true, // show/hide a Previous button
                                position: 'bottom', // none/ top/ both bottom
                                extraHtml: "<button class='btn sw-btn' id='btnFinish' disabled onclick='firstStuffSubmit()'>Finish</button>"
                            },
                            autoAdjustHeight: false,
                            //theme: 'arrows'
                        });

                        $(".tab-content").height('517')
                        $('#smartwizard').smartWizard("goToStep", 0);

                         $("#smartwizard").on("showStep", function(e, anchorObject, stepIndex, stepDirection, stepPosition) {
                            $(".tab-content").height('517')
                            $("#prev-btn").removeClass('disabled').prop('disabled', false);
                            $("#next-btn").removeClass('disabled').prop('disabled', false);
                            if(stepPosition === 'first') {
                                $("#prev-btn").addClass('disabled').prop('disabled', true);
                            } else if(stepPosition === 'last') {
                                $("#next-btn").addClass('disabled').prop('disabled', true);
                            } else {
                                $("#prev-btn").removeClass('disabled').prop('disabled', false);
                                $("#next-btn").removeClass('disabled').prop('disabled', false);
                            }

                            if (stepPosition == 'last') {
                                //showConfirm();
                                $("#btnFinish").prop('disabled', false);
                            } else {
                                $("#btnFinish").prop('disabled', true);
                            }
                        })

                        $("#smartwizard").on("leaveStep", function(e, anchorObject, currentStepIdx, nextStepIdx, stepDirection) {
                            if (stepDirection == 'forward') {
                                let form = document.getElementById('form-' + (currentStepIdx + 1));
                                if (!form.checkValidity()) {
                                    // Create the temporary button, click and remove it
                                    var tmpSubmit = document.createElement('button')
                                    form.appendChild(tmpSubmit)
                                    tmpSubmit.click()
                                    form.removeChild(tmpSubmit)
                                    return false
                                } else {
                                    switch (currentStepIdx) {
                                        case 2:
                                            $("#firstStateTimeZone").val($("#firstNationTimeZone").val())
                                            break;
                                        case 3:
                                            $("#firstCityTimeZone").val($("#firstStateTimeZone").val())
                                            break;
                                    }
                                }
                            }
                        })
                    });
                },
                close: function() {
                    $('#smartwizard').smartWizard("reset");
                    $('#smartwizard').smartWizard("setState", [0], "enable");
                    $('#smartwizard').smartWizard("setState", [1,2,3,4], "disable");
                }
            }
        });
    }

    $("#closeXML").on("click", function() {
        if (confirm("Are you sure?")) {
            clearRightDiv()
            //window.location.reload()
            nodeToEdit = null;
            max_world_id = max_continent_id = max_nation_id = max_state_id = max_city_id = max_ethnicity_id = max_region_id = max_region_sort_order = world_count = continent_count = nation_count = state_count = city_count = ethnicity_count = region_count = 0
            ethnicities_by_id = {}
            cities_by_id = {}
            states_by_id = {}
            nations_by_id = {}
            continents_by_id = {}
            regions_by_id = {}
            nations_by_continent = {}
            states_by_nation = {}
            cities_by_state = {}
            cities_by_nation = {}
            usa_defined = []
            $("#continent_count").text(continent_count)
            $("#nation_count").text(nation_count)
            $("#state_count").text(state_count)
            $("#city_count").text(city_count)
            $("#ethnicity_count").text(ethnicity_count)
            $("#region_count").text(region_count)
            $("#usa_defined_count").text(usa_defined.length)
            $("#max_continent_id").text(max_continent_id)
            $("#max_nation_id").text(max_nation_id)
            $("#max_state_id").text(max_state_id)
            $("#max_city_id").text(max_city_id)
            $("#max_ethnicity_id").text(max_ethnicity_id)
            $("#max_region_id").text(max_region_id)
            var tree = $.ui.fancytree.getTree("#xmlOutput")
            tree.destroy()
        } 
    })

    $("#newRegionSource").on("change",function(e) {
        $('#multi_d').empty()
        $('#newRegionFilter').empty()
        $("#filterLabel").html($(this).val())
        var src = null;
        switch ($(this).val()) {
            case ("Nations"):
                src = continents_by_id
                break;
            case ("States"):
                src = nations_by_id
                break;
            case ("Cities"):
                src = nations_by_id
                break;
        }

        $.each(src, function(key, value) {
            $('#newRegionFilter')
                .append($('<option>', { value : key })
                .text(value));
        });

        sortDropdown("#newRegionFilter")

        if ($(this).val() == "Nations") {
            $("#newRegionFilter option").eq(0).before($("<option></option>").val("all").text("Entire World"));
        }
        
        $("#newRegionFilter :nth-child(1)").prop('selected', true);
        $("#newRegionFilter").trigger("change")
        
    })

    $("#editRegionSource").on("change",function(e) {
        $('#edit_multi_d').empty()
        $('#editRegionFilter').empty()
        $("#editFilterLabel").html($(this).val())
        var src = null;
        switch ($(this).val()) {
            case ("Nations"):
                src = continents_by_id
                break;
            case ("States"):
                src = nations_by_id
                break;
            case ("Cities"):
                src = nations_by_id
                break;
        }

        $.each(src, function(key, value) {
            $('#editRegionFilter')
                .append($('<option>', { value : key })
                .text(value));
        });

        sortDropdown("#editRegionFilter")

        if ($(this).val() == "Nations") {
            $("#editRegionFilter option").eq(0).before($("<option></option>").val("all").text("Entire World"));
        }
        
        $("#editRegionFilter :nth-child(1)").prop('selected', true);
        $("#editRegionFilter").trigger("change")
        
    })

    $("#newRegionFilter").on("change", function(e) {
        $('#multi_d').empty()
        switch ($("#newRegionSource").val()) {
            case ("Nations"):
                $("#sourceStateRow").css("display","none")
                if ($(this).val() != "all") {
                    for (x of nations_by_continent[$(this).val()]) {
                        $('#multi_d')
                            .append($('<option>', { value : x.id })
                            .text(x.title));
                    }
                } else {
                    $.each(nations_by_id, function(key, value) {
                        $('#multi_d')
                            .append($('<option>', { value : key })
                            .text(value));
                    });
                }
                break;
            case ("States"):
                $("#sourceStateRow").css("display","none")
                for (x of states_by_nation[$(this).val()]) {
                    $('#multi_d')
                        .append($('<option>', { value : x.id })
                        .text(x.title));
                }
                break;
            case ("Cities"):
                $("#newRegionSubFilter").empty()
                for (x of states_by_nation[$(this).val()]) {
                    $('#newRegionSubFilter')
                        .append($('<option>', { value : x.id })
                        .text(x.title));
                }
                sortDropdown("#newRegionSubFilter")
                for (x of cities_by_state[$("#newRegionSubFilter").val()]) {
                    $('#multi_d')
                        .append($('<option>', { value : x.id })
                        .text(x.title));
                }
                $("#sourceStateRow").css("display","table-row")
                break;
        }
        sortDropdown("#multi_d")
    })

    $("#editRegionFilter").on("change", function(e) {
        $('#edit_multi_d').empty()
        switch ($("#editRegionSource").val()) {
            case ("Nations"):
                $("#editSourceStateRow").css("display","none")
                if ($(this).val() != "all") {
                    for (x of nations_by_continent[$(this).val()]) {
                        $('#edit_multi_d')
                            .append($('<option>', { value : x.id })
                            .text(x.title));
                    }
                } else {
                    $.each(nations_by_id, function(key, value) {
                        $('#edit_multi_d')
                            .append($('<option>', { value : key })
                            .text(value));
                    });
                }
                break;
            case ("States"):
                $("#editSourceStateRow").css("display","none")
                for (x of states_by_nation[$(this).val()]) {
                    $('#edit_multi_d')
                        .append($('<option>', { value : x.id })
                        .text(x.title));
                }
                break;
            case ("Cities"):
                $("#editRegionSubFilter").empty()
                for (x of states_by_nation[$(this).val()]) {
                    $('#editRegionSubFilter')
                        .append($('<option>', { value : x.id })
                        .text(x.title));
                }
                sortDropdown("#editRegionSubFilter")
                for (x of cities_by_state[$("#editRegionSubFilter").val()]) {
                    $('#edit_multi_d')
                        .append($('<option>', { value : x.id })
                        .text(x.title));
                }
                $("#editSourceStateRow").css("display","table-row")
                break;
        }
        sortDropdown("#edit_multi_d")
    })

    $("#newRegionSubFilter").on("change",function() {
        $('#multi_d').empty()
        for (x of cities_by_state[$(this).val()]) {
            $('#multi_d')
                .append($('<option>', { value : x.id })
                .text(x.title));
        }
        sortDropdown("#multi_d")
    })

    $("#editRegionSubFilter").on("change",function() {
        $('#edit_multi_d').empty()
        for (x of cities_by_state[$(this).val()]) {
            $('#edit_multi_d')
                .append($('<option>', { value : x.id })
                .text(x.title));
        }
        sortDropdown("#edit_multi_d")
    })

    $("#saveXML").on("click",function(e) {
        $("#overlay").css("display","inline-block")

/*         ipcRenderer.invoke('alert', "There are no nations defined as The USA.  There should always be at least one nation with this flag enabled because OOTP needs it as the nation for pre-defined leagues, like NL or AL.").then((result) => {})
            $("#overlay").css("display","none")
            return false */

        var usaCount = countUSA()

        if (usaCount < 1) {
            alert("There are no nations defined as The USA.  There should always be at least one nation with this flag enabled because OOTP needs it as the nation for pre-defined leagues, like NL or AL.")
            $("#overlay").css("display","none")
            return false           
        } else if (usaCount > 1) {
            alert("More than one nation is defined as The USA.  While this is not necessarily game-breaking, OOTP expects only one nation to have this flag set.")
            $("#overlay").css("display","none")
            return false
        }

        const tree = $.ui.fancytree.getTree("#xmlOutput")

        const commentStr = "\nOOTP loads this file whenever the user creates a new game. You can edit this file as long as you watch the syntax. Please read the online manual section about customizing the world XML file.\n"
                         + "NATION tokens:\n"
                         + "use_hardcoded_ml_player_origins - either 1 (=yes) or 0 (=no). If missing, the value will be set to 0. By default it's 1 for the USA nation record in the XML file. Just disable it (set it to 0) or delete it and OOTP will not use the hard coded player distribution for that nation anymore.\n"
                         + "this_is_modern_usa - either 1 (=yes) or 0 (=no). If missing, the value will be set to 0. By default it's 1 for the USA nation record in the XML file. There should always be at least one nation with this flag enabled because OOTP needs it as the nation for pre-defined leagues, like NL or AL.\n"
                         + "\r\n"
                         + "When OOTP creates fictional players for modern US major leagues, it will need to find the following nations by name: Dominican Republic, Venezuela, Puerto Rico, Mexico, Canada, Cuba, Japan, Panama, Australia, South Korea, Germany, Aruba, England, The Netherlands, Italy, Spain, Taiwan. So you should not change the names for these nations if you want to simulate realistic major leagues!\n"

        xw = new XMLWriter()
        xw.startDocument('1.0', 'UTF-8')
        xw.writeComment(commentStr)
        xw.startElement('WORLD')
            .writeAttribute("id","1")
            .writeAttribute("name", "default")
            .writeAttribute("version", "3")
            .writeAttribute("timestamp", "OOTP Developments 2023-04-24 13:59:02")

            xw.startElement("ETHNICITIES")
            
            var ethnicities = tree.findFirst("ETHNICITIES")
            var eth = ethnicities.toDict(true)
            for (e of eth.children) {
                xw.startElement("ETHNICITY")
                .writeAttribute("id", e.data.id)
                .writeAttribute("name", e.title)
                .writeAttribute("name_korean", e.data.name_korean)
                .writeAttribute("african", e.data.african)
                .writeAttribute("asian", e.data.asian)
                .writeAttribute("east_indian", e.data.east_indian)
                .writeAttribute("caucasian", e.data.caucasian)
                .writeAttribute("hispanic", e.data.hispanic)
                .endElement()
            }
            
            xw.endElement()

            xw.startElement("CONTINENTS")
            var continent = tree.findFirst("CONTINENT")
            var cont = continent.toDict(true)
            for (c of cont.children) {
                xw.startElement("CONTINENT")
                .writeAttribute("id", c.data.id)
                .writeAttribute("name", c.title)
                .writeAttribute("pop", c.data.pop)
                .writeAttribute("etid", c.data.etid)
                .writeAttribute("abbr", c.data.abbr)
                .writeAttribute("dem", c.data.dem)
                .writeAttribute("abbr_korean", c.data.abbr_korean)
                .writeAttribute("dem_korean", c.data.dem_korean)
                nationsEl = xw.startElement("NATIONS")
                for(n of c.children){
                    xw.startElement("NATION")
                    .writeAttribute("id", n.data.id)
                    .writeAttribute("name", n.title)
                    .writeAttribute("name_korean", n.data.name_korean)
                    .writeAttribute("short_korean", n.data.short_korean)
                    .writeAttribute("pop", n.data.pop)
                    .writeAttribute("etid", n.data.etid)
                    .writeAttribute("capid", n.data.capid)
                    .writeAttribute("gender", n.data.gender)
                    .writeAttribute("bbqual", n.data.bbqual)
                    .writeAttribute("abbr", n.data.abbr)
                    .writeAttribute("abbr_korean", n.data.abbr_korean)
                    .writeAttribute("dem", n.data.dem)
                    .writeAttribute("dem_korean", n.data.dem_korean)
                    .writeAttribute("time_zone", n.data.time_zone)
                    if (parseInt(n.data.this_is_the_usa) == 1) {
                        xw.writeAttribute("this_is_the_usa", 1)
                    }
                    if (parseInt(n.data.use_hardcoded_ml_player_origins) == 1) {
                        xw.writeAttribute("use_hardcoded_ml_player_origins", 1)
                    }
                    // second nations & nation ethnicities
                    for (child of n.children) {
                        if (child.type == "second_nations") {
                            if (child.data != undefined) {
                                xw.startElement("SECOND_NATIONS")
                                for (sn of child.data.subdata) {
                                    xw.startElement("SECOND_NATION")
                                    .writeAttribute("id", sn.id)
                                    .writeAttribute("pct", sn.pct) 
                                    .writeAttribute("use_name", sn.use_name)
                                    .endElement()
                                }
                                xw.endElement()
                            }
                        }
                        if (child.type == "nation_ethnicity") {
                            if (child.data != undefined) {
                                xw.startElement("ETHN_PCTS")
                                for (e of child.data.subdata) {
                                    xw.startElement("ETHN_PCT")
                                    .writeAttribute("etid", e.etid) 
                                    .writeAttribute("pct", e.pct)
                                    .endElement()
                                }
                                xw.endElement()
                            }
                        }
                    }
                    
                    xw.startElement("STATES")
                    for (s of n.children[2].children) {
                        xw.startElement("STATE")
                        .writeAttribute("id", s.data.id)
                        .writeAttribute("name", s.title)
                        .writeAttribute("name_korean", s.data.name_korean)
                        .writeAttribute("pop", s.data.pop)
                        .writeAttribute("abbr", s.data.abbr)
                        .writeAttribute("abbr_korean", s.data.abbr_korean)
                        .writeAttribute("time_zone", s.data.time_zone)
                        .writeAttribute("observes_dst", s.data.observes_dst)
                        .writeAttribute("lat",s.data.lat)
                        .writeAttribute("long", s.data.long)
                            xw.startElement("CITIES")
                            if (s.children != undefined) {
                                for (ci of s.children) {
                                    xw.startElement("CITY")
                                    .writeAttribute("id", ci.data.id)
                                    .writeAttribute("name", ci.title)
                                    .writeAttribute("name_korean", ci.data.name_korean)
                                    .writeAttribute("pop", ci.data.pop)
                                    .writeAttribute("time_zone", ci.data.time_zone)
                                    .writeAttribute("observes_dst", ci.data.observes_dst)
                                    .writeAttribute("lat", ci.data.lat)
                                    .writeAttribute("long", ci.data.long)
                                    .writeAttribute("abbr", ci.data.abbr)
                                    .writeAttribute("abbr_korean", ci.data.abbr_korean)
                                    .endElement()
                                }            
                            }
                            xw.endElement()
                        xw.endElement()
                    }
                    xw.endElement()
                    xw.startElement("CAPITAL")
                        .writeAttribute("id",n.data.capid)
                        .endElement()
                xw.endElement()
                }
            
            xw.endElement() 
        xw.endElement()
        }

        
        xw.endElement()

        xw.startElement("REGIONS")
        
        var regions = tree.findFirst("REGIONS")
        var reg = regions.toDict(true)
        if (reg.children != undefined) {
            for (r of reg.children) {
                xw.startElement("REGION")
                .writeAttribute("id", r.data.id)
                .writeAttribute("sort_order", r.data.sort_order)
                .writeAttribute("name", r.title)
                .writeAttribute("name_korean", r.data.title_korean)
                if (r.data.cities.length > 0) {
                    xw.startElement("REGION_CITIES")
                    for (st of r.data.cities) {
                        xw.startElement("REGION_CITY")
                        .writeAttribute("id", st.id)
                        .endElement()
                    }
                    xw.endElement()
                }
                if (r.data.states.length > 0) {
                    xw.startElement("REGION_STATES")
                    for (st of r.data.states) {
                        xw.startElement("REGION_STATE")
                        .writeAttribute("id", st.id)
                        .endElement()
                    }
                    xw.endElement()
                }
                if (r.data.nations.length) {
                    xw.startElement("REGION_NATIONS")
                    for (st of r.data.nations) {
                        xw.startElement("REGION_NATION")
                        .writeAttribute("id", st.id)
                        .endElement()
                    }
                    xw.endElement()
                }
                xw.endElement()
            }
        }
        

        xw.endElement()

        var tmpXML = vkbeautify.xml(xw.toString())
        tmpXML = tmpXML.replaceAll("SECOND_NATION id","SECOND_NATIONS id")
        tmpXML = tmpXML.replace("<!--","\n<!--")
        tmpXML = tmpXML.replace("-->","-->\n")

        ipcRenderer.send('save_xml',Buffer.from(tmpXML))
    })

    $("#bulkImportCities").on("click", function(e, c, n, s) {
        e.preventDefault()
        ipcRenderer.send('bulk-import-cities', [c, n, s])
    })

    ipcRenderer.on('bulk-city-import', (event, data) => {
        let json = JSON.parse(data)
        if (json.result != "success") {
            alert(json.errorMessage)
            return false;
        }
        if (json.responseData.length < 1) {
            alert("There don't appear to be any cities in that file")
            return false;
        }
        $("#importCitiesHeader").html("Importing "+json.responseData.length+" Cities From File")
        $('#bulkCityContinent').empty()
        $.each(continents_by_id, function(key, value) {
            $("#bulkCityContinent")
                .append($('<option>', { value : key })
                .text(value));
        });
        sortDropdown("#bulkCityContinent")
        if (json.continent > 0) {
            $("#bulkCityContinent").val(json.continent)
        }

        $("#bulkCityContinent").trigger("change", [json.nation, json.state])

        $("#cityImportProgressParent").css("display","none")
        $("#cityImportProgressLabel").text("")
        $('#cityImportProgress').LineProgressbar({
            duration: 0,
            percentage: 0
        });

        $.magnificPopup.open({
            items: {
                src: '#bulkCityImport',
                type: 'inline'
            }
        });
        bulkImportData = JSON.stringify(json.responseData)
    })

    $("#bulkCityContinent").on("change", function(e, n, s) {      
        $('#bulkCityNation').empty()
        for (nation of nations_by_continent[$("#bulkCityContinent").val()]) {
            $('#bulkCityNation')
                .append($('<option>', { value : nation.id })
                .text(nation.title));

        }
        sortDropdown("#bulkCityNation")
        if (n > 0) {
            $("#bulkCityNation").val(n)
        }
        $("#bulkCityNation").trigger("change", s)
    })

    $("#bulkCityNation").on("change", function(e, s) {
        $('#bulkCityState').empty()
        for (state of states_by_nation[$("#bulkCityNation").val()]) {
            $('#bulkCityState')
                .append($('<option>', { value : state.id })
                .text(state.title));

        }
        sortDropdown("#bulkCityState")
        if (s > 0) {
            $("#bulkCityState").val(s)
        }
    })

    $("#bulkCityForm").on("submit", async function(e) {
        e.preventDefault();
        let json = JSON.parse(bulkImportData);
        let nation = findNation($("#bulkCityContinent option:selected").text(), $("#bulkCityNation option:selected").text());
        let state = findState($("#bulkCityContinent option:selected").text(), $("#bulkCityNation option:selected").text(), $("#bulkCityState option:selected").text());
        let count = 1
        let cityNameArr = []
        let newCap = -1

        $("#cityImportProgressParent").css("display","inline-block")

        for (const city of json) {

            cityNameArr.push(city.Name)

            $("#cityImportProgressLabel").text("Importing "+city.Name+"...")

            $('#cityImportProgress').LineProgressbar({
                duration: 100,
                percentage: (count/json.length)*100
            });

            let nameK = await translate(city.Name, null, 'ko')
            let abbrK = await translate(city.Abbreviation, null, 'ko')
            let altitude = 0
            
            if (parseInt(city.Altitude) < 0) {
                altitude = getAltitudeEstimate(getElevationDataSync(parseFloat(city.Latitude).toFixed(5).toString(), parseFloat(city.Longitude).toFixed(5).toString()))
            } else {
                altitude = getAltitudeEstimate(parseInt(city.Altitude))
            }

            max_city_id++
            var obj = {}
            obj.name = city.Name
            obj.state = $("#bulkCityState").val()
            obj.nation = $("#bulkCityNation").val()
            obj.continent = $("#bulkCityContinent").val()
            cities_by_id[max_city_id] = obj
            city_count++;
            var city_obj = {}
            var city_bn_obj = {}
            city_obj.type = 'city'
            city_obj.folder = false
            if (parseInt(city.Capitol) == 1) {
                city_obj.icon = './images/star-solid.svg'
                newCap = max_city_id
            } else {
                city_obj.icon = './images/city-solid.svg'
            }
            city_obj.id = max_city_id
            city_obj.title = city.Name
            city_obj.title_korean = nameK.translation
            city_obj.pop = parseInt(city.Population)
            city_obj.lat = parseFloat(city.Latitude).toFixed(5).toString()
            city_obj.long = parseFloat(city.Longitude).toFixed(5).toString()
            city_obj.abbr = city.Abbreviation
            city_obj.altitude = altitude
            city_obj.abbr_korean = abbrK.translation
            city_obj.time_zone = parseFloat(city.TimeZone).toFixed(2).toString()
            city_obj.observes_dst = parseInt(city.DST)
            city_obj.state = $("#bulkCityState").val()
            city_obj.nation = $("#bulkCityNation").val()
            $("#max_city_id").text(max_city_id)
            $("#city_count").text(city_count)
            state.addChildren(city_obj)
            city_bn_obj.id = max_city_id
            city_bn_obj.title = city.Name
            city_bn_obj.state = $("#bulkCityState").val()
            city_bn_obj.nation = $("#bulkCityNation").val()
            cities_by_state[$("#bulkCityState").val()].push(city_obj)
            cities_by_nation[$("#bulkCityNation").val()].push(city_bn_obj)
            count++
        }
        cityNameArr.sort()
        $.magnificPopup.close()
        state.sortChildren(null, true);
        state.setExpanded(true)
        var node = state.findFirst(cityNameArr[0])
        node.setFocus()
        node.setActive()
        node.makeVisible({scrollIntoView: true});
        if (newCap > 0) {
            nation.data.capid = newCap
            resetCaptiol(nation)
        }
    });

    $("#bulkImportStates").on("click", function(e, c, n) {
        e.preventDefault()
        ipcRenderer.send('bulk-import-states', [c, n])
    })

    ipcRenderer.on('bulk-state-import', (event, data) => {
        console.log(JSON.parse(data))
        let json = JSON.parse(data)
        if (json.result != "success") {
            alert(json.errorMessage)
            return false;
        }
        if (json.responseData.length < 1) {
            alert("There don't appear to be any states in that file")
            return false;
        }
        $("#importStatesHeader").html("Importing "+json.responseData.length+" States From File")
        $('#bulkStateContinent').empty()
        $.each(continents_by_id, function(key, value) {
            $("#bulkStateContinent")
                .append($('<option>', { value : key })
                .text(value));
        });
        sortDropdown("#bulkStateContinent")
        if (json.continent > 0) {
            $("#bulkStateContinent").val(json.continent)
        }
        $("#bulkStateContinent").trigger("change", json.nation)

        $("#stateImportProgressParent").css("display","none")
        $("#stateImportProgressLabel").text("")
        $('#stateImportProgress').LineProgressbar({
            duration: 0,
            percentage: 0
        });

        $.magnificPopup.open({
            items: {
                src: '#bulkStateImport',
                type: 'inline'
            }
        });
        bulkImportData = JSON.stringify(json.responseData)
    })

    $("#bulkStateContinent").on("change", function(e, n) {
        $('#bulkStateNation').empty()
        for (nation of nations_by_continent[$("#bulkStateContinent").val()]) {
            //console.log(nation.id, nation.title)
            $('#bulkStateNation')
                .append($('<option>', { value : nation.id })
                .text(nation.title));

        }
        sortDropdown("#bulkStateNation")
        if (n > 0) {
            $("#bulkStateNation").val(n)
        }
    })

    $("#bulkStateForm").on("submit", async function(e) {
        e.preventDefault();
        let json = JSON.parse(bulkImportData);
        let nation = findNation($("#bulkStateContinent option:selected").text(), $("#bulkStateNation option:selected").text());
        let states = nation.findFirst("States")
        let count = 1
        let stateNameArr = []

        $("#stateImportProgressParent").css("display","inline-block")

        for (const state of json) {

            stateNameArr.push(state.Name)

            $("#stateImportProgressLabel").text("Importing "+state.Name+"...")

            $('#stateImportProgress').LineProgressbar({
                duration: 100,
                percentage: (count/json.length)*100
            });

            let nameK = await translate(state.Name, null, 'ko')
            let abbrK = await translate(state.Abbreviation, null, 'ko')

            max_state_id++
            states_by_id[max_state_id] = state.Name
            state_count++;
            var state_obj = {}
            state_obj.type = 'state'
            state_obj.folder = true
            state_obj.icon = './images/landmark-flag-solid.svg'
            state_obj.id = max_state_id
            state_obj.title = state.Name
            state_obj.title_korean = nameK.translation
            state_obj.pop = state.Population
            state_obj.abbr = state.Abbreviation
            state_obj.abbr_korean = abbrK.translation
            state_obj.time_zone = parseFloat(state.TimeZone).toFixed(2).toString()
            state_obj.observes_dst = parseInt(state.DST)
            state_obj.lat = parseFloat(state.Lat).toFixed(5).toString()
            state_obj.long = parseFloat(state.Lat).toFixed(5).toString()
            $("#max_state_id").text(max_state_id)
            $("#state_count").text(state_count)
            states.addChildren(state_obj)
            states_by_nation[$("#bulkStateNation").val()].push(state_obj)
            cities_by_state[max_state_id] = []
            count++
        }

        $.magnificPopup.close()

        stateNameArr.sort()
        
        states.sortChildren(null, true)
        var node = states.findFirst(stateNameArr[0])
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        tree.activateKey(false)
        node.setFocus()
        node.setActive()
        node.makeVisible({scrollIntoView: true});
    })

    $("#bulkImportNations").on("click", function(e, src) {
        e.preventDefault()
        ipcRenderer.send('bulk-import-nations', src)
    })

    ipcRenderer.on('bulk-nation-import', (event, data) => {
        let json = JSON.parse(data)
        if (json.result != "success") {
            alert(json.errorMessage)
            return false;
        }
        if (json.responseData.length < 1) {
            alert("There don't appear to be any nations in that file")
            return false;
        }
        $("#importNationsHeader").html("Importing "+json.responseData.length+" Nations From File")
        $('#bulkNationContinent').empty()
        $.each(continents_by_id, function(key, value) {
            $("#bulkNationContinent")
                .append($('<option>', { value : key })
                .text(value));
        });
        sortDropdown("#bulkNationContinent")
        $("#bulkNationContinent").val((json.continent > 0) ? json.continent : 1)

        $("#nationImportProgressParent").css("display","none")
        $("#nationImportProgressLabel").text("")
        $('#nationImportProgress').LineProgressbar({
            duration: 0,
            percentage: 0
        });

        $.magnificPopup.open({
            items: {
                src: '#bulkNationImport',
                type: 'inline'
            }
        });
        bulkImportData = JSON.stringify(json.responseData)
    })

    $("#bulkNationForm").on("submit", async function(e) {
        e.preventDefault();
        let continent = findContinent($("#bulkNationContinent option:selected").text());
        let json = JSON.parse(bulkImportData);
        let count = 1
        let nationNameArr = []
        var newUSAName = null;

        $("#nationImportProgressParent").css("display","inline-block")

        for (const nation of json) {
            nationNameArr.push(nation.Name)
             $("#nationImportProgressLabel").text("Importing "+nation.Name+"...")

            $('#nationImportProgress').LineProgressbar({
                duration: 100,
                percentage: (count/json.length)*100
            });

            let nameK = await translate(nation.Name, null, 'ko')
            let abbrK = await translate(nation.Abbreviation, null, 'ko')
            let demK = await translate(nation.Demonym, null, 'ko')

            max_nation_id++
            nations_by_id[max_nation_id] = nation.Name
            nation_count++;
            var nation_obj = {}
            nation_obj.type = 'nation'
            nation_obj.folder = true
            nation_obj.icon = (parseInt(nation.IsUSA) == 1) ? './images/flag-usa-solid.svg' : './images/flag-solid.svg'
            nation_obj.id = max_nation_id
            nation_obj.title = nation.Name
            nation_obj.title_korean = nameK.translation
            nation_obj.short_korean = ""
            nation_obj.pop = parseInt(nation.Population)
            nation_obj.etid = 0
            nation_obj.capid = 0
            nation_obj.gender = nation.Gender
            nation_obj.bbqual = nation.BBQuality
            nation_obj.abbr = nation.Abbreviation
            nation_obj.abbr_korean = abbrK.translation
            nation_obj.dem = nation.Demonym
            nation_obj.dem_korean = demK.translation
            nation_obj.time_zone = parseFloat(nation.TimeZone).toFixed(2).toString()
            nation_obj.observes_dst = parseInt(nation.DST)
            nation_obj.this_is_the_usa = parseInt(nation.IsUSA)
            nation_obj.use_hardcoded_ml_player_origins = parseInt(nation.HardcodedOrigins)
            var states_obj = {}
            states_obj.title = "States"
            states_obj.folder = true
            states_obj.icon = './images/landmark-dome-solid.svg'
            states_obj.type = "STATES_PARENT"
            states_obj.children = ([])
            var second_nations_obj = {}
            second_nations_obj.title = "Second Nations"
            second_nations_obj.folder = false
            second_nations_obj.icon = './images/circle-plus-solid.svg'
            second_nations_obj.type = 'second_nations'
            second_nations_obj.subdata = []
            var nation_eth_obj = {}
            nation_eth_obj.title = "Ethnicities"
            nation_eth_obj.folder = false
            nation_eth_obj.icon = './images/user-group-solid.svg'
            nation_eth_obj.type = 'nation_ethnicity'
            nation_eth_obj.subdata = []
            nation_obj.children = [second_nations_obj, nation_eth_obj, states_obj]
            //console.log(nation_obj)
            continent.addChildren(nation_obj)
            cities_by_nation[max_nation_id] = []
            states_by_nation[max_nation_id] = []
            nations_by_continent[$("#bulkNationContinent").val()].push(nation_obj)
            $("#max_nation_id").text(max_nation_id)
            $("#nation_count").text(nation_count)
            $("#usa_defined_count").text(countUSA())
            if (parseInt(nation.IsUSA) == 1) {
                newUSAName = nation.Name
            }
            count++
        }

        if (newUSAName != null) {
            var oldUSA = findNationFromScratch(usa)
            var newUSA = continent.findFirst(newUSAName)
            if (!confirm(oldUSA.title+" is already defined as the USA.\n\nAre you sure you want to change it to "+newUSAName+"?")) {
                newUSA.data.this_is_the_usa = 1
                newUSA.renderTitle()
            } else {
                oldUSA.data.this_is_the_usa = 0
                oldUSA.icon = './images/flag-solid.svg'
                oldUSA.renderTitle()
                newUSA.icon = './images/flag-usa-solid.svg'
                newUSA.renderTitle()
            }
        }

        $.magnificPopup.close()
        nationNameArr.sort()
        continent.sortChildren(null, true)
        var node = continent.findFirst(nationNameArr[0])
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        tree.activateKey(false)
        node.setFocus()
        node.setActive()
        node.makeVisible({scrollIntoView: true});
    })

    $("#bulkImportContinents").on("click", function(e) {
        e.preventDefault()
        ipcRenderer.send('bulk-import-continents', null)
    })

    $("#bulkContinentForm").on("submit", async function(e) {
        e.preventDefault();
        let json = JSON.parse(bulkImportData);
        let count = 1
        let continentNameArr = []

        var tree = $.ui.fancytree.getTree("#xmlOutput")
        var world = tree.findFirst("CONTINENT")

        $("#continentImportProgressParent").css("display","inline-block")
        
        for (const continent of json) {
            continentNameArr.push(continent.Name)
             $("#continentImportProgressLabel").text("Importing "+continent.Name+"...")

            $('#continentImportProgress').LineProgressbar({
                duration: 100,
                percentage: (count/json.length)*100
            });

            let nameK = await translate(continent.Name, null, 'ko')
            let abbrK = await translate(continent.Abbreviation, null, 'ko')
            let demK = await translate(continent.Demonym, null, 'ko')

            max_continent_id++
            continents_by_id[max_continent_id] = continent.Name
            continent_count++;

            var continent_obj = {}
            continent_obj.type = 'continent'
            continent_obj.folder = true
            continent_obj.icon = './images/earth-americas-solid.svg'
            continent_obj.id = max_continent_id
            continent_obj.title = continent.Name
            continent_obj.title_korean = nameK.translation
            continent_obj.pop = continent.Population
            continent_obj.etid = 0
            continent_obj.abbr = continent.Abbreviation
            continent_obj.dem = continent.Demonym
            continent_obj.abbr_korean =  abbrK.translation
            continent_obj.dem_korean = demK.translation
            nations_by_continent[max_continent_id] = []
            
            world.addChildren(continent_obj)
            count++
        }
        $.magnificPopup.close()
        continentNameArr.sort()
        world.sortChildren(null, true);
        var continent = world.findFirst(continentNameArr[0])
        world.setExpanded()
        tree.activateKey(false)
        continent.setFocus()
        continent.setActive()
        
        $("#max_continent_id").text(max_continent_id)
        $("#continent_count").text(continent_count)
    })

    ipcRenderer.on('bulk-continent-import', (event, data) => {
        let json = JSON.parse(data)
        console.log(json)
        if (json.result != "success") {
            alert(json.errorMessage)
            return false;
        }
        if (json.responseData.length < 1) {
            alert("There don't appear to be any nations in that file")
            return false;
        }
        $("#importContinentsHeader").html("Importing "+json.responseData.length+" Continents From File")

        $("#continentImportProgressParent").css("display","none")
        $("#continentImportProgressLabel").text("")
        $('#continentImportProgress').LineProgressbar({
            duration: 0,
            percentage: 0
        });

        $.magnificPopup.open({
            items: {
                src: '#bulkContinentImport',
                type: 'inline'
            }
        });
        bulkImportData = JSON.stringify(json.responseData)
    })
    
    $("#bulkImportEthnicities").on("click", function(e) {
        e.preventDefault()
        ipcRenderer.send('bulk-import-ethnicities', null)
    })

    $("#bulkEthnicityForm").on("submit", async function(e) {
        e.preventDefault()
        let json = JSON.parse(bulkImportData);
        let count = 1
        let ethnicityNameArr = []

        var tree = $.ui.fancytree.getTree("#xmlOutput")
        var world = tree.findFirst("ETHNICITIES")
        
        $("#ethnicityImportProgressParent").css("display","inline-block")

        for (const ethnicity of json) {
            ethnicityNameArr.push(ethnicity.Name)
             $("#ethnicityImportProgressLabel").text("Importing "+ethnicity.Name+"...")

            $('#ethnicityImportProgress').LineProgressbar({
                duration: 100,
                percentage: (count/json.length)*100
            });

            let nameK = await translate(ethnicity.Name, null, 'ko')

            max_ethnicity_id++
            ethnicities_by_id[max_ethnicity_id] = ethnicity.Name
            ethnicity_count++;

            var ethnicity_obj = {}
            ethnicity_obj.type = 'ethnicity'
            ethnicity_obj.icon = './images/user-group-solid.svg'
            ethnicity_obj.title = ethnicity.Name
            ethnicity_obj.name_korean = nameK.translation
            ethnicity_obj.id = max_ethnicity_id
            ethnicity_obj.african = ethnicity.African
            ethnicity_obj.asian = ethnicity.Asian
            ethnicity_obj.east_indian = ethnicity.EastIndian
            ethnicity_obj.caucasian = ethnicity.Caucasian
            ethnicity_obj.hispanic = ethnicity.Hispanic
            
            world.addChildren(ethnicity_obj)
            count++
        }
        $.magnificPopup.close()
        ethnicityNameArr.sort()
        world.sortChildren(null, true);
        var ethnicity = world.findFirst(ethnicityNameArr[0])
        world.setExpanded()
        tree.activateKey(false)
        ethnicity.setFocus()
        ethnicity.setActive()
        
        $("#max_ethnicity_id").text(max_ethnicity_id)
        $("#ethnicity_count").text(ethnicity_count)
    })

    ipcRenderer.on('bulk-ethnicity-import', (event, data) => {
        let json = JSON.parse(data)
        if (json.result != "success") {
            alert(json.errorMessage)
            return false;
        }
        if (json.responseData.length < 1) {
            alert("There don't appear to be any ethnicities in that file")
            return false;
        }
        $("#importEthnicitiesHeader").html("Importing "+json.responseData.length+" Ethnicities From File")

        $("#ethnicityImportProgressParent").css("display","none")
        $("#ethnicityImportProgressLabel").text("")
        $('#ethnicityImportProgress').LineProgressbar({
            duration: 0,
            percentage: 0
        });


        $.magnificPopup.open({
            items: {
                src: '#bulkEthnicityImport',
                type: 'inline'
            }
        });
        bulkImportData = JSON.stringify(json.responseData)
    })

    $("#bulkImportRegions").on("click", function(e) {
        e.preventDefault()
        ipcRenderer.send('bulk-import-regions', null)
    })

    $("#bulkRegionForm").on("submit", async function(e) {
        e.preventDefault()
        let json = JSON.parse(bulkImportData);
        let count = 1
        let regionNameArr = []

        var tree = $.ui.fancytree.getTree("#xmlOutput")
        var world = tree.findFirst("REGIONS")

        $("#regionImportProgressParent").css("display","inline-block")
        
        for (const region of json) {
            regionNameArr.push(region.Name)
            $("#regionImportProgressLabel").text("Importing "+region.Name+"...")

            $('#regionImportProgress').LineProgressbar({
                duration: 100,
                percentage: (count/json.length)*100
            });

            let nameK = await translate(region.Name, null, 'ko')

            max_region_id++
            regions_by_id[max_region_id] = region.Name
            region_count++;

            let cities = (region.Cities != undefined) ? region.Cities.split("x") : []
            let states = (region.States != undefined) ? region.States.split("x") : []
            let nations = (region.Nations != undefined) ? region.Nations.split("x") : []

            console.log(nations)

            var region_obj = {}
            region_obj.type = 'region'
            region_obj.folder = true
            region_obj.icon = "./images/map-location-dot-solid.svg"
            region_obj.id = max_region_id
            region_obj.title = region.Name
            region_obj.sort_order = 0
            region_obj.name_korean = nameK.translation
            var city_arr = []
            var state_arr = []
            var nation_arr = []
            try {
                for (city of cities) {
                    if (cities_by_id[city] != undefined) {
                        var city_obj ={}
                        city_obj.title = cities_by_id[city].name
                        city_obj.id = city
                        city_arr.push(city_obj)
                    }
                }
            } catch (err) {}
            try {
                for (state of states) {
                    if (states_by_id[state] != undefined) {
                        var state_obj = {}
                        state_obj.title = states_by_id[state]
                        state_obj.id = state
                        state_arr.push(state_obj)
                    }
                }
            } catch (err) {}
            try {
                for (nation of nations) {
                    if (nations_by_id[nation] != undefined) {
                        var nation_obj = {}
                        nation_obj.title = nations_by_id[nation]
                        nation_obj.id = nation
                        nation_arr.push(nation_obj)
                    }
                }
            } catch (err) {}
            region_obj.nations = nation_arr
            region_obj.states = state_arr
            region_obj.cities = city_arr
            
            world.addChildren(region_obj)
            count++
        }
        $.magnificPopup.close()
        regionNameArr.sort()
        world.sortChildren(null, true);
        var region = world.findFirst(regionNameArr[0])
        world.setExpanded()
        tree.activateKey(false)
        region.setFocus()
        region.setActive()
        
        $("#max_region_id").text(max_region_id)
        $("#region_count").text(region_count)
    })

    ipcRenderer.on('bulk-region-import', (event, data) => {
        let json = JSON.parse(data)
        if (json.result != "success") {
            alert(json.errorMessage)
            return false;
        }
        if (json.responseData.length < 1) {
            alert("There don't appear to be any regions in that file")
            return false;
        }
        $("#importRegionsHeader").html("Importing "+json.responseData.length+" Regions From File")

        $("#regionImportProgressParent").css("display","none")
        $("#regionImportProgressLabel").text("")
        $('#regionImportProgress').LineProgressbar({
            duration: 0,
            percentage: 0
        });


        $.magnificPopup.open({
            items: {
                src: '#bulkRegionImport',
                type: 'inline'
            }
        });
        bulkImportData = JSON.stringify(json.responseData)
    })

    ipcRenderer.on('version-info', (event, data) => {
        currentVersion = data
        $("#currentVersion").text("Version "+currentVersion)
    })

    ipcRenderer.on('save_xml_result', (event, data) => {
        if (data.status != "success") {
            alert(data.message)
        }
        $("#overlay").css("display","none")
        if (newXML == true) {
            newXML = false
            startNewXML()
        }
    })

    ipcRenderer.on('xml-opened', (event, result) => {
        if (result != 'cancelled') {
            // reset everything
            var tree = $.ui.fancytree.getTree("#xmlOutput")
            if (tree != null) { 
                tree.destroy() 
            }
            $("#dataTable").html("")
            max_world_id = 0
            max_continent_id = 0
            max_nation_id = 0
            max_state_id = 0
            max_city_id = 0
            max_ethnicity_id = 0
            max_region_id = 0
            world_count = 0
            continent_count = 0
            nation_count = 0
            state_count = 0
            city_count = 0
            ethnicity_count = 0
            region_count = 0

            $("#continent_count").text(continent_count)
            $("#nation_count").text(nation_count)
            $("#state_count").text(state_count)
            $("#city_count").text(city_count)
            $("#ethnicity_count").text(ethnicity_count)
            $("#region_count").text(region_count)
            $("#usa_defined_count").text(usa_defined.length)
            $("#max_continent_id").text(max_continent_id)
            $("#max_nation_id").text(max_nation_id)
            $("#max_state_id").text(max_state_id)
            $("#max_city_id").text(max_city_id)
            $("#max_ethnicity_id").text(max_ethnicity_id)
            $("#max_region_id").text(max_region_id)

            // start parsing the new data
            var json = JSON.parse(result)
            var tree_json = [];

            var ethnicities_arr = {}
            var ethnicities = []
            ethnicities_arr.title = "ETHNICITIES";
            ethnicities_arr.folder = true
            ethnicities_arr.type = "ETHNICITIES_PARENT"
            ethnicities_arr.icon = './images/people-group-solid.svg'
            for (ethnicity of json.WORLD.ETHNICITIES[0].ETHNICITY) {
                ethnicities_by_id[ethnicity.$.id] = ethnicity.$.name
                ethnicity_count++;
                var ethnicity_obj = {}
                ethnicity_obj.type = 'ethnicity'
                ethnicity_obj.folder = false
                ethnicity_obj.icon = './images/user-group-solid.svg'
                ethnicity_obj.title = ethnicity.$.name
                ethnicity_obj.name_korean = ethnicity.$.name_korean
                ethnicity_obj.id = ethnicity.$.id
                ethnicity_obj.african = ethnicity.$.african
                ethnicity_obj.asian = ethnicity.$.asian
                ethnicity_obj.east_indian = ethnicity.$.east_indian
                ethnicity_obj.caucasian = ethnicity.$.caucasian
                ethnicity_obj.hispanic = ethnicity.$.hispanic
                ethnicities.push(ethnicity_obj)
                if (parseInt(ethnicity.$.id) > max_ethnicity_id) { max_ethnicity_id = parseInt(ethnicity.$.id) }
            }
            ethnicities_arr.children = ethnicities
            tree_json.push(ethnicities_arr)
            
            var continent_arr = {};
            continent_arr.title = "CONTINENTS";
            continent_arr.folder = true;
            continent_arr.icon = './images/globe-solid.svg'
            continent_arr.type = "CONTINENTS_PARENT"
            var continents = []
            for (continent of json.WORLD.CONTINENTS[0].CONTINENT) {
                continents_by_id[continent.$.id] = continent.$.name
                continent_count++;
                var continent_obj = {}
                continent_obj.type = 'continent'
                continent_obj.folder = true
                continent_obj.icon = './images/earth-americas-solid.svg'
                continent_obj.id = continent.$.id
                continent_obj.title = continent.$.name
                continent_obj.title_korean = (continent.$.name_korean != undefined) ? continent.$.name_korean : ""
                continent_obj.pop = (continent.$.population != undefined) ? continent.$.population : continent.$.pop
                continent_obj.etid = (continent.$.etid != undefined) ? continent.$.etid : ""
                continent_obj.abbr = continent.$.abbr
                continent_obj.dem = continent.$.dem
                continent_obj.abbr_korean = (continent.$.abbr_korean != undefined) ? continent.$.abbr_korean : ""
                continent_obj.dem_korean = (continent.$.dem_korean != undefined) ? continent.$.dem_korean : ""
                if (parseInt(continent.$.id) > max_continent_id) { max_continent_id = parseInt(continent.$.id) }
                var nation_arr = []     
                for (nation of continent.NATIONS[0].NATION) {
                    console.log(nation.$.name)
                    const usa = (nation.$.hasOwnProperty('this_is_the_usa')) ? nation.$.this_is_the_usa : nation.$.this_is_modern_usa
                    nations_by_id[nation.$.id] = nation.$.name
                    nation_count++;
                    var nation_obj = {}
                    nation_obj.type = 'nation'
                    nation_obj.folder = true
                    nation_obj.icon = (usa != undefined) ? './images/flag-usa-solid.svg' : './images/flag-solid.svg'
                    nation_obj.id = nation.$.id
                    nation_obj.title = nation.$.name
                    nation_obj.title_korean = (nation.$.name_korean != undefined) ? nation.$.name_korean : ""
                    nation_obj.short_korean = (nation.$.short_korean != undefined) ? nation.$.short_korean : ""
                    nation_obj.pop = nation.$.pop
                    nation_obj.etid = (nation.$.etid != undefined) ? nation.$.etid : ""
                    /* nation_obj.lid = nation.$.lid = (nation.$.lid != undefined) ? nation.$.lid : "" */
                    nation_obj.capid = (nation.$.capid != undefined) ? nation.$.capid : ""
                    nation_obj.gender = nation.$.gender
                    nation_obj.bbqual = nation.$.bbqual
                    nation_obj.abbr = nation.$.abbr
                    nation_obj.abbr_korean = (nation.$.abbr_korean != undefined) ? nation.$.abbr_korean : ""
                    nation_obj.dem = nation.$.dem
                    nation_obj.dem_korean = (nation.$.dem_korean != undefined) ? nation.$.dem_korean : ""
                    nation_obj.time_zone = parseFloat(nation.$.time_zone).toFixed(2).toString()
                    nation_obj.observes_dst = (nation.$.observes_dst != undefined) ? nation.$.observes_dst : ""
                    nation_obj.this_is_the_usa = (usa != undefined) ? "1" : "0"
                    nation_obj.use_hardcoded_ml_player_origins = (nation.$.use_hardcoded_ml_player_origins != undefined) ? nation.$.use_hardcoded_ml_player_origins : "0"
                    if (nation_obj.this_is_the_usa == 1) { usa_defined.push(nation_obj.id) }
                    if (parseInt(nation.$.id) > max_nation_id) { max_nation_id = parseInt(nation.$.id) }
                    var second_nations_obj = {}
                    second_nations_obj.title = "Second Nations"
                    second_nations_obj.folder = false
                    second_nations_obj.icon = './images/circle-plus-solid.svg'
                    second_nations_obj.type = 'second_nations'
                    var second_nations_arr = []
                    if (nation.SECOND_NATIONS != undefined && nation.SECOND_NATIONS[0].SECOND_NATIONS != undefined) {
                        for (sn of nation.SECOND_NATIONS[0].SECOND_NATIONS) {
                            var sn_obj = {}
                            sn_obj.id = sn.$.id
                            sn_obj.pct = sn.$.pct
                            sn_obj.use_name = sn.$.use_name
                            second_nations_arr.push(sn_obj)
                        }
                        second_nations_obj.subdata = (second_nations_arr)
                    }
                    var nation_eth_obj = {}
                    nation_eth_obj.title = "Ethnicities"
                    nation_eth_obj.folder = false
                    nation_eth_obj.icon = './images/user-group-solid.svg'
                    nation_eth_obj.type = 'nation_ethnicity'
                    var nation_eth_arr = []
                    if (nation.ETHN_PCTS != undefined) {
                        for (n_eth of nation.ETHN_PCTS[0].ETHN_PCT) {
                            var eth_obj = {}
                            eth_obj.name = ethnicities_by_id[n_eth.$.etid]
                            eth_obj.etid = n_eth.$.etid
                            eth_obj.pct = n_eth.$.pct
                            nation_eth_arr.push(eth_obj)
                        }
                        nation_eth_obj.subdata = (nation_eth_arr)
                    }
                    var states_obj = {}
                    states_obj.title = "States"
                    states_obj.folder = true
                    states_obj.icon = './images/landmark-dome-solid.svg'
                    states_obj.type = "STATES_PARENT"
                    var state_arr = []
                    var cities_bn_arr = []
                    for (state of nation.STATES[0].STATE) {
                        states_by_id[state.$.id] = state.$.name
                        state_count++;
                        var state_obj = {}
                        state_obj.type = 'state'
                        state_obj.folder = true
                        state_obj.icon = './images/landmark-flag-solid.svg'
                        state_obj.id = state.$.id
                        state_obj.title = state.$.name
                        state_obj.title_korean = (state.$.name_korean != undefined) ? state.$.name_korean : ""
                        state_obj.pop = state.$.pop
                        state_obj.abbr = state.$.abbr
                        state_obj.abbr_korean = (state.$.abbr_korean != undefined) ? state.$.abbr_korean : ""
                        state_obj.time_zone = (state.$.time_zone != undefined) ? parseFloat(state.$.time_zone).toFixed(2).toString() : parseFloat(nation.$.time_zone).toFixed(2).toString()
                        state_obj.observes_dst = (state.$.observes_dst != undefined) ? state.$.observes_dst : "0"
                        state_obj.lat = (state.$.lat != undefined) ? state.$.lat : "0"
                        state_obj.long = (state.$.long != undefined) ? state.$.long : "0"
                        if (parseInt(state.$.id) > max_state_id) { max_state_id = parseInt(state.$.id) }
                        var city_arr = []
                        if (state.CITIES[0].CITY != undefined) {
                            for (city of state.CITIES[0].CITY) {
                                var obj = {}
                                obj.name = city.$.name
                                obj.state = state.$.id
                                obj.nation = nation.$.id
                                obj.continent = continent.$.id
                                cities_by_id[city.$.id] = obj
                                city_count++;
                                var city_obj = {}
                                var city_bn_obj = {}
                                city_obj.type = 'city'
                                city_obj.folder = false
                                if (nation.$.capid == city.$.id) {
                                    city_obj.icon = './images/star-solid.svg'
                                } else {
                                    city_obj.icon = './images/city-solid.svg'
                                }
                                city_obj.id = city.$.id
                                city_obj.title = city.$.name
                                city_obj.title_korean = (city.$.name_korean != undefined) ? city.$.name_korean : ""
                                city_obj.pop = city.$.pop
                                city_obj.lat = (city.$.lat != undefined) ? city.$.lat : "0"
                                city_obj.long = (city.$.long != undefined) ? city.$.long : "0"
                                city_obj.abbr = city.$.abbr
                                city_obj.altitude = (city.$.altitude != undefined) ? city.$.altitude : "0"
                                city_obj.abbr_korean = (city.$.abbr_korean != undefined) ? city.$.abbr_korean : ""
                                city_obj.time_zone = (city.$.time_zone != undefined) ? parseFloat(city.$.time_zone).toFixed(2).toString() : parseFloat(nation.$.time_zone).toFixed(2).toString()
                                city_obj.observes_dst = (city.$.observes_dst != undefined) ? city.$.observes_dst : "0"
                                city_obj.state = state.$.id
                                city_obj.nation = nation.$.id
                                city_arr.push(city_obj)
                                if (parseInt(city.$.id) > max_city_id) { max_city_id = parseInt(city.$.id) }
                                city_bn_obj.id = city.$.id
                                city_bn_obj.title = city.$.name
                                city_bn_obj.state = state.$.id
                                city_bn_obj.nation = nation.$.id
                                cities_bn_arr.push(city_bn_obj)
                            }
                        }
                        state_obj.children = city_arr
                        state_arr.push(state_obj)
                        cities_by_state[state.$.id] = city_arr
                    }
                    states_obj.children = (state_arr)
                    nation_obj.children = [second_nations_obj, nation_eth_obj, states_obj]
                    nation_arr.push(nation_obj)
                    states_by_nation[nation.$.id] = state_arr
                    cities_by_nation[nation.$.id] = cities_bn_arr
                }
                nations_by_continent[continent.$.id] = nation_arr
                continent_obj.children = nation_arr
                continents.push(continent_obj)
            }
            continent_arr.children = continents
            tree_json.push(continent_arr)

            var regions_arr = {}
            regions_arr.title = "REGIONS"
            regions_arr.folder = true
            regions_arr.icon = './images/map-solid.svg'
            regions_arr.type = "REGIONS_PARENT"
            var regions = []
            
            if (json.WORLD.REGIONS[0].REGION != undefined) {
                for (region of json.WORLD.REGIONS[0].REGION) {
                    regions_by_id[region.$.id] = region.$.name
                    region_count++;
                    var region_obj = {}
                    region_obj.type = 'region'
                    region_obj.folder = true
                    region_obj.icon = "./images/map-location-dot-solid.svg"
                    region_obj.id = region.$.id
                    region_obj.title = region.$.name
                    region_obj.sort_order = region.$.sort_order
                    region_obj.name_korean = region.$.name_korean
                    var city_arr = []
                    var state_arr = []
                    var nation_arr = []
                    try {
                        for (city of REGION_CITIES[0].REGION_CITY) {
                            var city_obj ={}
                            city_obj.title = cities_by_id[city.$.id].name
                            city_obj.id = city.$.id
                            city_arr.push(city_obj)
                        }
                    } catch (err) {}
                    try {
                        for (state of region.REGION_STATES[0].REGION_STATE) {
                            var state_obj = {}
                            state_obj.title = states_by_id[state.$.id]
                            state_obj.id = state.$.id
                            state_arr.push(state_obj)
                        }
                    } catch (err) {}
                    try {
                        for (nation of region.REGION_NATIONS[0].REGION_NATION) {
                            var nation_obj = {}
                            nation_obj.title = nations_by_id[nation.$.id]
                            nation_obj.id = nation.$.id
                            nation_arr.push(nation_obj)
                        }
                    } catch (err) {}
                    region_obj.nations = nation_arr
                    region_obj.states = state_arr
                    region_obj.cities = city_arr
                    regions.push(region_obj)
                    if (parseInt(region.$.id) > max_region_id) { max_region_id = parseInt(region.$.id) }
                    if (parseInt(region.$.sort_order) > max_region_sort_order) { max_region_sort_order = parseInt(region.$.sort_order) }
                }
            }
            regions_arr.children = regions
            tree_json.push(regions_arr)

            initTree(tree_json)
        } else {
            $("#overlay").css("display","none")
            alert("cancelled!")
        }
    });

    ipcRenderer.on('elevation-retrieved', (event, result) => {
        var json = JSON.parse(result)
        $(json.target).val(getAltitudeEstimate(json.results[0].elevation))
    })

    function initTree(json) {
        $("#xmlOutput").fancytree({
            extensions: ['dnd5', 'multi'],
            source: json,
            init: function(event, data){
                fancyTreeReady = true
            },
            multi: {
                mode: "sameParent"  // Restrict range selection behavior
            },
            dnd5: {
                autoExpandMS: 200,      
                dropMarkerOffsetX: -24,  
                dropMarkerInsertOffsetX: -16, 
                multiSource: true,                
                preventForeignNodes: true,   
                preventNonNodes: false,       
                preventRecursion: true,  
                preventVoidMoves: true,     
                scroll: true,        
                scrollSensitivity: 20,        
                scrollSpeed: 5,               
                dragStart: function (node, data) {
                    switch (node.type) {
                        case "ETHNICITIES_PARENT":
                            return false;
                            break;
                        case "ethnicity":
                            return false;
                            break;
                        case "CONTINENTS_PARENT":
                            return false;
                            break;
                        case "continent":
                            return false;
                            break;
                        case "nation_ethnicity":
                            return false;
                            break;
                        case "second_nations":
                            return false;
                            break;
                        case "STATES_PARENT":
                            return false;
                            break;
                    }
                    data.dropEffect = "move";
                    return true;
                },
                dragDrag: function (node, data) {
                    //console.log('dragDrag');
                }, 
                dragEnd: function (node, data) {
                    //console.log('dragEnd');
                },         
                /* Events (drop support) */
                dragEnter: function (node, data) {
                    switch (data.otherNode.type) {
                        case "nation":
                            if (node.type != "continent") {
                                return false;
                            }
                            break;
                        case "state":
                            if (node.type != "nation") {
                                return false
                            }
                            break;
                        case "city":
                            if (node.type != "state") {
                                return false;
                            }
                            break;
                    }
                    return true;
                },      
                dragOver: function (node, data) {
                    //console.log('dragOver');
                },     
                dragExpand: function (node, data) {
                    //console.log('dragExpand');
                    return true;
                },      
                dragDrop: function (node, data) {
                    var target = null
                    switch (data.otherNode.type) {
                        case "nation":
                            target = node
                            data.otherNode.parent.setExpanded(false)
                            break;
                        case "state":
                            target = node.children[2]
                            data.otherNode.parent.parent.parent.setExpanded(false)
                            break;
                        case "city":
                            target = node
                            data.otherNode.parent.parent.parent.parent.setExpanded(false)
                            break;
                    }
                    var sourceNodes = data.otherNodeList

                    $.each(sourceNodes, function(i, o){
                        //o.info("move to " + target + ": " + data.hitMode);
                        o.moveTo(target, data.hitMode);
                    });

                    /* data.otherNode.moveTo(target, data.hitMode); */
                    target.sortChildren(null, true);
                    data.otherNode.setFocus()
                    data.otherNode.setActive()
                    data.otherNode.makeVisible({scrollIntoView: true});
                },
                dragLeave: function (node, data) {
                    //console.log('dragLeave');
                }
            },
            activate: function(event, data){
                $("#dataTable").html("")
                var node = data.node;
                var html = ""
                switch (node.type) {
                    case "ETHNICITIES_PARENT":
                        if (node.getChildren() != null) {
                            html = '<h2 style="text-align:center;">'+node.countChildren(false)+' Ethnicities found</h2>\n'

                            var african = 0
                            var asian = 0
                            var east_indian = 0
                            var caucasian = 0
                            var hispanic = 0

                            for (child of node.getChildren()) {
                                african += parseInt(child.data.african)
                                asian += parseInt(child.data.asian)
                                east_indian += parseInt(child.data.east_indian)
                                caucasian += parseInt(child.data.caucasian)
                                hispanic += parseInt(child.data.hispanic)
                            }

                            var sum = african + asian + east_indian + caucasian + hispanic

                            html += "<div id='pieChartP'>\n"
                                    + "<div data-lcolor='#623A17'>"+((african/sum)*100).toFixed(3)+"<span>African</span></div>\n"
                                    + "<div data-lcolor='#F7E2AB'>"+((asian/sum)*100).toFixed(3)+"<span>Asian</span></div>\n"
                                    + "<div data-lcolor='#CB9662'>"+((east_indian/sum)*100).toFixed(3)+"<span>East Indian</span></div>\n"
                                    + "<div data-lcolor='#F6DCC3'>"+((caucasian/sum)*100).toFixed(3)+"<span>Caucasian</span></div>\n"
                                    + "<div data-lcolor='#EFC794'>"+((hispanic/sum)*100).toFixed(3)+"<span>Hispanic</span></div>\n"
                                    + "</div>\n"
                                    + "<h4 style='text-align: center;'><b>Approximate Percentages</b></h4>\n"
                                    + "<div class='result_list'></div>"

                            $("#infoPanel").html(html)

                            rightDivContent("#infoPanel")

                            $("#pieChartP").listtopie({
                                size:'auto',  
                                strokeWidth:2,
                                hoverEvent:false,
                                hoverBorderColor:'#585858',
                                hoverWidth:2,
                                textSize:'16',
                                marginCenter:30,
                                listVal:true,
                                strokeColor:'#fff',
                                listValMouseOver: true,
                                infoText:true,
                                setValues:false,
                                listValInsertClass:'result_list',
                                backColorOpacity: '0.8',
                                hoverSectorColor:true,
                                usePercent:true,
                                speedDraw:50
                            });
                        } else {
                            html = "<h2 style='text-align:center;'>No Ethnicities Defined</h2>\n"
                                 + "<div style='width:100%; text-align:center;'><input type='button' id='blankEthnicitiesButton' value='Add Ethnicity'></div>"
                            $("#infoPanel").html(html)

                            $("#blankEthnicitiesButton").on("click", function() {
                                $("#addEthnicityTrigger").trigger("click")
                            })
                            rightDivContent("#infoPanel")
                        }
                        break;
                    case "ethnicity":
                        console.log(node)
                        html = '<h2 style="text-align:center;"><img src="./images/people-group-solid.svg">Ethhnicities&nbsp;&rarr;&nbsp;<img src="./images/user-group-solid.svg">'+node.title+'</h2>\n'
                                + "<div id='pieChart'>\n"
                                + "<div data-lcolor='#623A17'>"+node.data.african/10+"<span>African</span></div>\n"
                                + "<div data-lcolor='#F7E2AB'>"+node.data.asian/10+"<span>Asian</span></div>\n"
                                + "<div data-lcolor='#CB9662'>"+node.data.east_indian/10+"<span>East Indian</span></div>\n"
                                + "<div data-lcolor='#F6DCC3'>"+node.data.caucasian/10+"<span>Caucasian</span></div>\n"
                                + "<div data-lcolor='#EFC794'>"+node.data.hispanic/10+"<span>Hispanic</span></div>\n"
                                + "</div>\n"
                                + "<h4 style='text-align: center;'><b>"+node.title+"</b></h4>\n"
                                + "<div class='result_list'></div><br>\n"
                                + "<div style='width:100%; text-align:center;'><input type='button' id='editEthnicityButton' class='submit' value='Edit Ethnicity'></div>"
                                

                        $("#infoPanel").html(html)

                        rightDivContent("#infoPanel")

                        $("#pieChart").listtopie({
                            size:'auto',  
                            strokeWidth:2,
                            hoverEvent:false,
                            hoverBorderColor:'#585858',
                            hoverWidth:2,
                            textSize:'16',
                            marginCenter:30,
                            listVal:true,
                            strokeColor:'#fff',
                            listValMouseOver: true,
                            infoText:true,
                            setValues:false,
                            listValInsertClass:'result_list',
                            backColorOpacity: '0.8',
                            hoverSectorColor:true,
                            usePercent:true,
                            speedDraw:50
                        });

                        $("#editEthnicityButton").on("click", function(e) {
                            editEthnicity(node)
                        })
                        break;
                    case "CONTINENTS_PARENT":
                        html = '<h2 style="text-align:center;"><img src="./images/globe-solid.svg">Continents</h2>\n'

                        var totalPop = 0;
                        var continentCount = 0;

                        html += "<div id='continentPieChart'>\n"

                        if (node.getChildren() != null) {
                            for (child of node.getChildren()) {
                                totalPop += parseInt(child.data.pop)
                                continentCount++
                                html += "<div data-lcolor='"+chroma.random()+"'>"+child.data.pop+"<span>"+child.title+"</span></div>\n"
                            }

                            html += "</div>"
                                    + "<h4 style='text-align: center; font-weight:bold;'>"+continentCount+" Continents<br><br>Total Population: "+totalPop.toLocaleString("en-US")+"</h4>\n"

                            $("#infoPanel").html(html)

                            rightDivContent("#infoPanel")
                            
                            if (totalPop > 0) {
                                $("#continentPieChart").listtopie({
                                    size:'auto',  
                                    strokeWidth:2,
                                    hoverEvent:false,
                                    hoverBorderColor:'#585858',
                                    hoverWidth:2,
                                    textSize:'16',
                                    marginCenter:30,
                                    listVal:true,
                                    strokeColor:'#fff',
                                    listValMouseOver: true,
                                    infoText:true,
                                    setValues:false,
                                    listValInsertClass:'result_list',
                                    backColorOpacity: '0.8',
                                    hoverSectorColor:true,
                                    usePercent:false,
                                    speedDraw:50
                                });
                            } else {
                                $("#continentPieChart").remove()
                            }
                            
                        } else {
                            html = "<h2 style='text-align:center;'>No Continents Defined</h2>\n"
                                 + "<div style='width:100%; text-align:center;'><input type='button' id='blankContinentButton' value='Add Continent'></div>"
                            $("#infoPanel").html(html)

                            $("#blankContinentButton").on("click", function() {
                                $("#addContinentTrigger").trigger("click")
                            })
                            rightDivContent("#infoPanel")
                        }
                        break;
                    case "continent":
                        var nat = 0;
                        var stt = 0;
                        var cty = 0;
                        node.visit(function(n) {
                            switch (n.type) {
                                case "nation":
                                    nat++
                                    break;
                                case "state":
                                    stt++
                                    break;
                                case "city":
                                    cty++
                                    break;
                                default:
                                    break;
                            }
                        })

                        var pop = (parseInt(node.data.pop) != NaN) ? "0" : parseInt(node.data.pop).toLocaleString("en-US")
                        html = '<h2 style="text-align:center;"><img src="./images/earth-americas-solid.svg">'+node.title+'</h2>\n'
                                + '<div style="width:100%; text-align:center;">\n'
                                + '<table class="blank" style="width:100%;">\n'
                                + '<tr class="blank"><td class="left_float">ID:</td><td class="right_float">'+node.data.id+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Type:</td><td class="right_float">Continent</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Abbreviation:</td><td class="right_float">'+node.data.abbr+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Demonym:</td><td class="right_float" >'+node.data.dem+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Population:</td><td class="right_float" >'+pop+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Ethnicity ID:</td><td class="right_float" >'+node.data.etid+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Name (Korean):</td><td class="right_float" >'+node.data.title_korean+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Abbreviation (Korean):</td><td class="right_float" >'+node.data.abbr_korean+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Demonym (Korean):</td><td class="right_float" >'+node.data.dem_korean+'</td></tr>\n'
                                + "<tr class='blank'><td class='left_float'>Nations:</td><td class='right_float'>"+nat+"</td><tr>\n"
                                + "<tr class='blank'><td class='left_float'>States:</td><td class='right_float'>"+stt+"</td><tr>\n"
                                + "<tr class='blank'><td class='left_float'>Cities:</td><td class='right_float'>"+cty+"</td><tr>\n"
                                + "</table><br>\n"
                                + "<input type='button' id='editContinentButton' class='submit' value='Edit Continent'>"
                                + "</div>\n" 
                        $("#infoPanel").html(html)
                        rightDivContent("#infoPanel")
                        $("#editContinentButton").on("click", function(e) {
                            editContinent(node)
                        })
                        break;
                    case "nation":
                        var stt = 0;
                        var cty = 0;
                        var eth = 0;
                        var sec = 0;
                        node.visit(function(n) {
                            switch (n.type) {
                                case "state":
                                    stt++
                                    break;
                                case "city":
                                    cty++
                                    break;
                                case "nation_ethnicity":
                                    if (n.data.subdata != undefined) { eth = n.data.subdata.length }
                                    break;
                                case "second_nations":
                                    if (n.data.subdata != undefined) { sec = n.data.subdata.length }
                                    break;
                                default:
                                    break;
                            }
                        })

                        var cap
                        if (node.data.capid == undefined || node.data.capid == "0") {
                            cap = "<span style='color:red;'>None Set</span>" 
                        } else {
                            var city = cities_by_nation[node.data.id].find( function( city ){
                                return city.id === node.data.capid;
                            } );
                            if (city != null) {
                                cap = city.title+",&nbsp;"+states_by_id[city.state]
                            }
                        } 

                        var pop = (parseInt(node.data.pop) != NaN) ? "0" : parseInt(node.data.pop).toLocaleString("en-US")
                        html = '<h2 style="text-align:center;"><img src="./images/earth-americas-solid.svg">'+node.parent.title+"&nbsp;&rarr;&nbsp;<img src='./images/flag-solid.svg'>"+node.title+'</h2>\n'
                                + '<div style="width:100%; text-align:center;">\n'
                                + '<table class="blank" style="width:100%;">\n'
                                + '<tr class="blank"><td class="left_float">ID:</td><td class="right_float">'+node.data.id+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Type:</td><td class="right_float">Nation</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Abbreviation:</td><td class="right_float">'+node.data.abbr+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Demonym:</td><td class="right_float" >'+node.data.dem+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Population:</td><td class="right_float" >'+pop+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Capitol:</td><td class="right_float" ><span id="capDisplaySpan">'+cap+'<span></td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Time Zone:</td><td class="right_float" >'+tzDisplay[node.data.time_zone]+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Ethnicity ID:</td><td class="right_float" >'+node.data.etid+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Baseball Quality:</td><td class="right_float" >'+baseballQuality[node.data.bbqual]+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">This is the USA:</td><td class="right_float" >'+usa[node.data.this_is_the_usa]+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Use Hardcoded ML Player Origins:</td><td class="right_float" >'+hardcoded[node.data.this_is_the_usa]+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Gender:</td><td class="right_float" >'+gender[node.data.gender]+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Name (Korean):</td><td class="right_float" >'+node.data.title_korean+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Short (Korean):</td><td class="right_float" >'+node.data.short_korean+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Abbreviation (Korean):</td><td class="right_float" >'+node.data.abbr_korean+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Demonym (Korean):</td><td class="right_float" >'+node.data.dem_korean+'</td></tr>\n'
                                + "<tr class='blank'><td class='left_float'>Ethnicities:</td><td class='right_float'>"+eth+"</td><tr>\n"
                                + "<tr class='blank'><td class='left_float'>Second Nations:</td><td class='right_float'>"+sec+"</td><tr>\n"
                                + "<tr class='blank'><td class='left_float'>States:</td><td class='right_float'>"+stt+"</td><tr>\n"
                                + "<tr class='blank'><td class='left_float'>Cities:</td><td class='right_float'>"+cty+"</td><tr>\n"
                                + "</table><br>\n"
                                + "<input type='button' id='editNationButton' class='submit' value='Edit Nation'>"
                                + "</div>\n" 
                        $("#infoPanel").html(html)
                        rightDivContent("#infoPanel")
                        $("#editNationButton").on("click", function(e) {
                            editNation(node)
                        })
                        break;
                    case "STATES_PARENT":
                        if (node.getChildren() != null) {
                            html = '<h2 style="text-align:center;"><img src="./images/earth-americas-solid.svg">'+node.parent.parent.title+"&nbsp;&rarr;&nbsp;<img src='./images/flag-solid.svg'>"+node.parent.title+"&nbsp;&rarr;&nbsp;<img src='./images/landmark-dome-solid.svg'>"+node.title+'</h2>\n'

                            var totalPop = 0;
                            var stateCount = 0;

                            html += "<div id='statePieChart'>\n"

                            for (child of node.getChildren()) {
                                totalPop += parseInt(child.data.pop)
                                stateCount++
                                html += "<div data-lcolor='"+chroma.random()+"'>"+child.data.pop+"<span>: "+child.title+"</span></div>\n"
                            }

                            html += "</div>"
                                    + "<h4 style='text-align: center; font-weight:bold;'>"+stateCount+" States<br><br>Total Population: "+totalPop.toLocaleString("en-US")+"</h4>\n"

                            $("#infoPanel").html(html)

                            $("#statePieChart").listtopie({
                                size:'auto',  
                                strokeWidth:2,
                                hoverEvent:false,
                                hoverBorderColor:'#585858',
                                hoverWidth:2,
                                textSize:'16',
                                marginCenter:30,
                                listVal:false,
                                strokeColor:'#fff',
                                listValMouseOver: true,
                                infoText:true,
                                setValues:false,
                                listValInsertClass:'result_list',
                                backColorOpacity: '0.8',
                                hoverSectorColor:true,
                                usePercent:false,
                                speedDraw:50
                            });
                        } else {
                            var html = "<h2 style='text-align:center;'>No States Defined</h2>\n"
                                     + "<div style='width:100%; text-align:center;'><input type='button' id='blankStateButton' value='Add State'></div>"

                            $("#infoPanel").html(html)

                            $("#blankStateButton").on("click", function() {
                                //console.log(node.parent.parent.title, node.parent.title)
                                addState(node.parent.parent.data.id, node.parent.data.id)
                            })
                        }

                        rightDivContent("#infoPanel")
                        break;
                    case "state":
                        var cty = 0;
                        node.visit(function(n) {
                            if (n.type == "city") { cty++ }
                        })
                        var lat = (node.data.lat == undefined || node.data.lat == "0") ? "00.00000" : node.data.lat
                        var lon = (node.data.long == undefined || node.data.long == "0") ? "00.00000" : node.data.long
                        var pop = (parseInt(node.data.pop) != NaN) ? "0" : parseInt(node.data.pop).toLocaleString("en-US")
                        html = '<h2 style="text-align:center;"><img src="./images/earth-americas-solid.svg">'+node.parent.parent.parent.title+"&nbsp;&rarr;&nbsp;<img src='./images/flag-solid.svg'>"+node.parent.parent.title+"&nbsp;&rarr;&nbsp;<img src='./images/landmark-flag-solid.svg'>"+node.title+'</h2>\n'
                                + '<div style="width:100%; text-align:center;">\n'
                                + '<table class="blank" style="width:100%;">\n'
                                + '<tr class="blank"><td class="left_float">ID:</td><td class="right_float">'+node.data.id+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Type:</td><td class="right_float">State</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Abbreviation:</td><td class="right_float">'+node.data.abbr+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Population:</td><td class="right_float">'+pop+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Latitude:</td><td class="right_float">'+lat+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Longitude:</td><td class="right_float">'+lon+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Time Zone:</td><td class="right_float">'+tzDisplay[node.data.time_zone]+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Observes DST:</td><td class="right_float">'+dst[node.data.observes_dst]+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Name (Korean):</td><td class="right_float">'+node.data.title_korean+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Abbreviation (Korean):</td><td class="right_float">'+node.data.abbr_korean+'</td></tr>\n'
                                + "<tr class='blank'><td class='left_float'>Cities:</td><td class='right_float'>"+cty+"</td><tr>\n"
                                + "</table><br>\n"
                                + "<input type='button' id='editStateButton' class='submit' value='Edit State'>"
                                + "</div>\n" 
                        $("#infoPanel").html(html)
                        rightDivContent("#infoPanel")
                        $("#editStateButton").on("click", function(e) {
                            editState(node)
                        })
                        break;
                    case "city":
                        var lat = (node.data.lat == undefined || node.data.lat == "0") ? "00.00000" : node.data.lat
                        var lon = (node.data.long == undefined || node.data.long == "0") ? "00.00000" : node.data.long
                        var alt = (node.data.altitude == undefined) ? "0" : node.data.altitude
                        var capitol = (node.data.id == node.parent.parent.parent.data.capid) ? "Yes" : "No"
                        html = '<h2 style="text-align:center;"><img src="./images/earth-americas-solid.svg">'+node.parent.parent.parent.parent.title+"&nbsp;&rarr;&nbsp;<img src='./images/flag-solid.svg'>"+node.parent.parent.parent.title+"&nbsp;&rarr;&nbsp;<img src='./images/landmark-flag-solid.svg'>"+node.parent.title+"&nbsp;&rarr;&nbsp;<img src='./images/city-solid.svg'>"+node.title+'</h2>\n'
                                + '<div style="width:100%; text-align:center;">\n'
                                + '<table class="blank" style="width:100%;">\n'
                                + '<tr class="blank"><td class="left_float">ID:</td><td class="right_float">'+node.data.id+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Type:</td><td class="right_float">City</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Abbreviation:</td><td class="right_float">'+node.data.abbr+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Population:</td><td class="right_float">'+parseInt(node.data.pop).toLocaleString("en-US")+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">National Capitol:</td><td class="right_float">'+capitol+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Latitude:</td><td class="right_float">'+lat+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Longitude:</td><td class="right_float">'+lon+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Altitude:</td><td class="right_float">'+altitudes[alt]+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Time Zone:</td><td class="right_float">'+tzDisplay[node.data.time_zone]+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Observes DST:</td><td class="right_float">'+dst[node.data.observes_dst]+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Name (Korean):</td><td class="right_float">'+node.data.title_korean+'</td></tr>\n'
                                + '<tr class="blank"><td class="left_float">Abbreviation (Korean):</td><td class="right_float">'+node.data.abbr_korean+'</td></tr>\n'
                                + "</table><br>\n"
                                + "<input type='button' id='editCityButton' class='submit' value='Edit City'>"
                                + "</div>\n" 
                        $("#infoPanel").html(html)
                        rightDivContent("#infoPanel")
                        $("#editCityButton").on("click", function(e) {
                            editCity(node)
                        })
                        break;
                    case "second_nations":
                        nodeToEdit = node
                        html = '<h2 style="text-align:center;"><img src="./images/earth-americas-solid.svg">'+node.parent.parent.title+"&nbsp;&rarr;&nbsp;<img src='./images/flag-solid.svg'>"+node.parent.title+"&nbsp;&rarr;&nbsp;<img src='./images/circle-plus-solid.svg'>"+node.title+'</h2>\n'
                                + '<div style="width:100%; text-align:center;">\n'
                                + "<table id='secondNationsTable' class='cell-border compact stripe' style='width:100%;'>\n"
                                + "<thead><tr style='font-weight:bold;'><td class='dt-head-center'>ID</td><td class='dt-head-center'>Nation</td><td class='dt-head-center'>Percent</td><td class='dt-head-center'>Use Name</td></tr></thead>\n"
                                + "<tbody id='sntb'>\n"
                        if (node.data.subdata != undefined) {        
                            for (sn of node.data.subdata) {
                                var un = (sn.use_name == "1") ? "Yes": "No"
                                html += "<tr><td>"+sn.id+"</td><td>"+nations_by_id[sn.id]+"</td><td>"+sn.pct+"</td><td>"+un+"</td></tr>\n"
                            }
                        }
                        html += "</tbody></table>"
                                + "<div id='buttonHolder' style='width:100%; text-align:center; margin-top:10px;'></div>\n"

                                <!-- ADD DIV HERE -->
                                + "<div id='addSNDiv' style='display:none; width:100%;'>\n"
                                + "<form id='addNewSNForm' action=''>\n"
                                + "<table style='width:90%;'><thead><tr><th style='text-align:center; width:60%;'>Nation</th><th style='text-align:center; width:25%;'>Percent</th><th style='text-align:center; width:25%;'>Use Name</th></tr></thead>\n"
                                + "<tbody>\n"
                                + "<tr>\n"
                                + "<td><select id='addNewSNNation' class='sNationSelect'></select></td>\n"
                                + "<td><input type='number' step='0.01' min='0.01' max='100' style='width:100px;' id='addNewSNPercent'/></td>\n"
                                + "<td><select id='addNewSNUseName'>\n"
                                + "<option value=1>Yes</option>\n"
                                + "<option value=0>No</option>\n"
                                + "</select></td>\n"
                                + "</tr>\n"
                                + "</tbody></table><br>\n"
                                + "<b>Total:</b>&nbsp;<input id='addNewSNTotal' type='number' step='0.01' min='0.01' max='100' style='width:100px; margin-right:10px;' value='0'>"
                                + "<input type='submit' class='submit' value='Add Second Nation'><input type='button' style='margin-left:10px;' class='submit' id='cancelNewSN' value='Cancel'></form>\n"
                                + "</div>\n"

                                <!-- EDIT DIV HERE -->
                                + "<div id='editSNDiv' style='display:none;'>\n"
                                + "<form id='editSNForm' action=''>\n"
                                + "<table style='width:90%;'><thead><tr><th style='text-align:center; width:60%;'>Nation</th><th style='text-align:center; width:25%;'>Percent</th><th style='text-align:center; width:25%;'>Use Name</th></tr></thead>\n"
                                + "<tbody>\n"
                                + "<tr>\n"
                                + "<td><select id='editSNNation' class='sNationSelect'></select></td>\n"
                                + "<td><input type='number' step='0.01' min='0.01' max='100' style='width:100px;' id='editSNPercent'/></td>\n"
                                + "<td><select id='editSNUseName'>\n"
                                + "<option value=1>Yes</option>\n"
                                + "<option value=0>No</option>\n"
                                + "</select></td>\n"
                                + "</tr>\n"
                                + "</tbody></table><br>\n"
                                + "<b>Total:</b>&nbsp;<input id='editSNTotal' type='number' step='0.01' min='0.01' max='100' style='width:100px; margin-right:10px;' value='0'>"
                                + "<input type='submit' class='submit' value='Submit Changes'><input type='button' style='margin-left:10px;' class='submit' id='cancelEditSN' value='Cancel'></form>\n"
                                + "</div>\n"
                                + "</div>\n"
                        $("#infoPanel").html(html)
                        $("#addNewSNTotal").on('keydown paste focus mousedown', function(e){
                            e.preventDefault();
                        });
                        sortDropdown("#addNewSNNation")
                        sortDropdown("#editSNNation")
                        let table = $('#secondNationsTable').DataTable({ 
                            fixedHeader: true,
                            order: ( [ 1, 'asc' ] ),
                            buttons: [
                                {
                                    text: 'Add',
                                    action: function ( e, dt, node, config ) {
                                        table.button(0).disable()
                                        table.button(1).disable()
                                        table.button(2).disable()
                                        var total = 0
                                        var alreadyThere = []
                                        table.rows().every(function(){
                                            total += parseFloat(this.data()[2]);
                                            alreadyThere.push(this.data()[0])
                                        });
                                        total = total.toFixed(2)
                                        $("#addNewSNNation").empty()
                                        $.each(nations_by_id, function(key, value) {
                                            if (!alreadyThere.includes(key)) {
                                                $("#addNewSNNation")
                                                    .append($('<option>', { value : key })
                                                    .text(value));
                                            }
                                        });
                                        sortDropdown("#addNewSNNation")
                                        $("#addNewSNPercent").val(0)
                                        $("#addNewSNUseName").val(1)
                                        $("#addNewSNTotal").val(total)
                                        $("#editSNDiv").css("display","none")
                                        $("#addSNDiv").css("display","inline-block")
                                    }
                                },
                                {
                                    text: 'Edit',
                                    action: function ( e, dt, node, config ) {
                                        table.button(0).disable()
                                        table.button(1).disable()
                                        table.button(2).disable()
                                        var total = 0
                                        var alreadyThere = []
                                        table.rows().every(function(){
                                            total += parseFloat(this.data()[2]);
                                            alreadyThere.push(this.data()[0])
                                        });
                                        
                                        $("#editSNNation").empty()

                                        // create dropdown, fitering out nations that are already second nations
                                        $.each(nations_by_id, function(key, value) {
                                            if (!alreadyThere.includes(key)) {
                                                $("#editSNNation")
                                                    .append($('<option>', { value : key })
                                                    .text(value));
                                            }
                                        });
                                        
                                        var row = table.rows( { selected: true } )

                                        // put select row's value back into the dropdown
                                        $("#editSNNation")
                                            .append($('<option>', { value : row.data()[0][0] })
                                            .text(row.data()[0][1]));
                                        sortDropdown("#editSNNation")

                                        total = total.toFixed(2)

                                        var un = (row.data()[0][3] == "Yes") ? 1 : 0;
                                        $("#editSNNation").val(row.data()[0][0])
                                        $("#editSNPercent").val(row.data()[0][2])
                                        $("#editSNUseName").val(un)
                                        $("#editSNTotal").val(total)
                                        $("#editSNDiv").css("display","inline-block")
                                        $("#addSNDiv").css("display","none")
                                    },
                                    enabled: false
                                },
                                {
                                    text: 'Delete',
                                    action: function ( e, dt, node, config ) {
                                        $("#editSNDiv").css("display","none")
                                        $("#addSNDiv").css("display","none")
                                        var row = table.rows( { selected: true } )
                                        if (confirm("Are you sure you want to delete "+row.data()[0][1]+"?")) {
                                            table.rows( { selected: true } ).remove().draw(false);
                                        }
                                        var newData = []
                                        table.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
                                            var obj = {}
                                            var data = this.data();
                                            obj.id = data[0]
                                            obj.pct = data[2]
                                            obj.use_name = (data[3] == "Yes") ? 1 : 0
                                            newData.push(obj)
                                        } );
                                        nodeToEdit.data.subdata = newData
                                        table.button(1).disable()
                                        table.button(2).disable()
                                    },
                                    enabled: false
                                }
                            ],
                            select: true,
                            
                        }).on( 'select', function ( e, dt, type, indexes ) {
                            $("#editSNDiv").css("display","none")
                            $("#addSNDiv").css("display","none")
                            table.button(1).enable()
                            table.button(2).enable()
                        }).on( 'deselect', function ( e, dt, type, indexes ) {
                            $("#editSNDiv").css("display","none")
                            $("#addSNDiv").css("display","none")
                            table.button(1).disable()
                            table.button(2).disable()
                        });
                        table.column(0).visible(false)
                        table.buttons().container().appendTo( $('#buttonHolder' ) );

                        $("#cancelNewSN").on("click", function(e) {
                            table.buttons(0).enable()
                            $("#addSNDiv").css("display","none")
                        })

                        $("#cancelEditSN").on("click", function(e) {
                            table.rows( { selected: true } ).deselect()
                            table.buttons(0).enable()
                            $("#editSNDiv").css("display","none")
                        })

                        $("#addNewSNPercent").on("change", function(e) {
                            var total = 0
                            table.rows().every(function(){
                                total += parseFloat(this.data()[2]);
                            });
                            total += parseFloat($(this).val())
                            total = total.toFixed(2)
                            $("#addNewSNTotal").val(total)
                        })

                        $("#editSNPercent").on("change", function(e) {
                            var total = 0
                            var selRow = table.rows( { selected: true } )
                            table.rows().every(function() {
                                if (this.data()[0] != selRow.data()[0][0]) {
                                    total += parseFloat(this.data()[2]);
                                }
                            })
                            total += parseFloat($(this).val())
                            total = total.toFixed(2)
                            $("#editSNTotal").val(total)
                        })

                        $("#addNewSNForm").on("submit",function(e) {
                            e.preventDefault()
                            table.row
                            .add([
                                $("#addNewSNNation").val(),
                                $("#addNewSNNation option:selected" ).text(),
                                $("#addNewSNPercent").val(),
                                $("#addNewSNUseName option:selected" ).text()
                            ])
                            .draw(false);
                            $("#addSNDiv").css("display","none")
                            $("#addNewSNNation").empty()
                            $("#addNewSNPercent").val(0)
                            var newData = []
                            table.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
                                var obj = {}
                                var data = this.data();
                                obj.id = data[0]
                                obj.pct = data[2]
                                obj.use_name = (data[3] == "Yes") ? 1 : 0
                                newData.push(obj)
                            } );
                            nodeToEdit.data.subdata = newData
                            table.button(0).enable()
                            table.button(1).disable()
                            table.button(2).disable()
                        })

                        $("#editSNForm").on("submit",function(e) {
                            e.preventDefault()
                            table.rows( { selected: true } ).remove().draw(false);
                            table.row
                            .add([
                                $("#editSNNation").val(),
                                $("#editSNNation option:selected" ).text(),
                                $("#editSNPercent").val(),
                                $("#editSNUseName option:selected" ).text()
                            ])
                            .draw(false);
                            $("#editSNDiv").css("display","none")
                            $("#editSNNation").empty()
                            $("#editSNPercent").val(0)
                            var newData = []
                            table.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
                                var obj = {}
                                var data = this.data();
                                obj.id = data[0]
                                obj.pct = data[2]
                                obj.use_name = (data[3] == "Yes") ? 1 : 0
                                newData.push(obj)
                            } );
                            nodeToEdit.data.subdata = newData
                            table.button(0).enable()
                            table.button(1).disable()
                            table.button(2).disable()
                        })

                        rightDivContent("#infoPanel")                        
                        break;
                    case "nation_ethnicity":
                        nodeToEdit = node;
                        html = '<h2 style="text-align:center;"><img src="./images/earth-americas-solid.svg">'+node.parent.parent.title+"&nbsp;&rarr;&nbsp;<img src='./images/flag-solid.svg'>"+node.parent.title+"&nbsp;&rarr;&nbsp;<img src='./images/user-group-solid.svg'>"+node.title+'</h2>\n'
                                + '<div style="width:100%; text-align:center;">\n'
                                + "<table id='nationEthnicityTable' class='cell-border compact stripe' style='width:100%;'>\n"
                                + "<thead><tr style='font-weight:bold;'><td class='dt-head-center'>ID</td><td class='dt-head-center'>Ethnicity</td><td class='dt-head-center'>Percent</td></tr></thead>\n"
                                + "<tbody id='sntb'>\n"
                        if (node.data.subdata != undefined) {
                            for (sn of node.data.subdata) {
                                html += "<tr><td>"+sn.etid+"</td><td>"+ethnicities_by_id[sn.etid]+"</td><td>"+sn.pct+"</td></tr>\n"
                            }
                        }
                        html += "</tbody></table><br>"
                                + "<div id='buttonHolder2' style='width:100%; text-align:center; margin-top:10px;'></div>\n"
                        
                        
                        <!-- ADD DIV HERE -->
                                + "<div id='addNEDiv' style='display:none; width:100%;'>\n"
                                + "<form id='addNewNEForm' action=''>\n"
                                + "<table style='width:90%;'><thead><tr><th style='text-align:center; width:60%;'>Ethnicity</th><th style='text-align:center; width:40%;'>Percent</th></tr></thead>\n"
                                + "<tbody>\n"
                                + "<tr>\n"
                                + "<td><select id='addNewNEthnicity' class='nEthSelect'></select></td>\n"
                                + "<td><input type='number' min='0'  style='width:100px;' id='addNewNEPercent'/></td>\n"
                                + "</tr>\n"
                                + "</tbody></table><br>\n"
                                //+ "<b>Total:</b>&nbsp;<input id='addNewNETotal' type='number' style='width:100px; margin-right:10px;' value='0'>"
                                + "<input type='submit' class='submit' value='Add Nation Ethnicity'><input type='button' style='margin-left:10px;' class='submit' id='cancelAddNE' value='Cancel'></form>\n"
                                + "</div>\n"

                        <!-- EDIT DIV HERE -->
                                + "<div id='editNEDiv' style='display:none;'>\n"
                                + "<form id='editNEForm' action=''>\n"
                                + "<table style='width:90%;'><thead><tr><th style='text-align:center; width:60%;'>Ethnicity<th><th style='text-align:center; width:40%;'>Percent</th></tr></thead>\n"
                                + "<tbody>\n"
                                + "<tr>\n"
                                + "<td><select id='editNEthnicity' class='nEthSelect'></select></td>\n"
                                + "<td><input type='number' min='0' style='width:100px;' id='editNEPercent'/></td>\n"
                                + "</tr>\n"
                                + "</tbody></table><br>\n"
                                //+ "<b>Total:</b>&nbsp;<input id='editNETotal' type='number' style='width:100px; margin-right:10px;' value='0'>"
                                + "<input type='submit' class='submit' value='Submit Changes'><input type='button' style='margin-left:10px;' class='submit' id='cancelEditNE' value='Cancel'></form>\n"
                                + "</div>\n"

                        html += "</div>\n" 
                        $("#infoPanel").html(html)

                        let table2 = $('#nationEthnicityTable').DataTable({ 
                            fixedHeader: true,
                            scrollY: 550,
                            scrollCollapse: true,
                            order: ( [ 1, 'asc' ] ),
                            buttons: [
                                {
                                    text: 'Add',
                                    action: function ( e, dt, node, config ) {
                                        table2.button(0).disable()
                                        table2.button(1).disable()
                                        table2.button(2).disable()
                                        //var total = 0
                                        var alreadyThere = []
                                        table2.rows().every(function(){
                                            //total += parseInt(this.data()[2]);
                                            alreadyThere.push(this.data()[0])
                                        });
                                        $("#addNewNEthnicity").empty()
                                        $.each(ethnicities_by_id, function(key, value) {
                                            if (!alreadyThere.includes(key)) {
                                                $("#addNewNEthnicity")
                                                    .append($('<option>', { value : key })
                                                    .text(value));
                                            }
                                        });
                                        sortDropdown("#addNewNEthnicity")
                                        $("#addNewNEPercent").val(0)
                                        //$("#addNewNETotal").val(total)
                                        $("#editNEDiv").css("display","none")
                                        $("#addNEDiv").css("display","inline-block")
                                    }
                                },
                                {
                                    text: 'Edit',
                                    action: function ( e, dt, node, config ) {
                                        table2.button(0).disable()
                                        table2.button(1).disable()
                                        table2.button(2).disable()
                                        //var total = 0
                                        var alreadyThere = []
                                        table2.rows().every(function(){
                                            //total += parseInt(this.data()[2]);
                                            alreadyThere.push(this.data()[0])
                                        });

                                        $("#editNEthnicity").empty()

                                        // create dropdown, fitering out nations that are already second nations
                                        $.each(ethnicities_by_id, function(key, value) {
                                            if (!alreadyThere.includes(key)) {
                                                $("#editNEthnicity")
                                                    .append($('<option>', { value : key })
                                                    .text(value));
                                            } 
                                        });

        
                                        var row = table2.rows( { selected: true } )

                                        // put select row's value back into the dropdown
                                        $("#editNEthnicity")
                                            .append($('<option>', { value : row.data()[0][0] })
                                            .text(row.data()[0][1]));
                                        sortDropdown("#editNEthnicity")

                                        $("#editNEthnicity").val(row.data()[0][0])
                                        $("#editNEPercent").val(row.data()[0][2])
                                        //$("#editNETotal").val(total)
                                        $("#editNEDiv").css("display","inline-block")
                                        $("#addNEDiv").css("display","none")
                                    },
                                    enabled: false
                                },
                                {
                                    text: 'Delete',
                                    action: function ( e, dt, node, config ) {
                                        $("#editNEDiv").css("display","none")
                                        $("#addNEDiv").css("display","none")
                                        var row = table2.rows( { selected: true } )
                                        if (confirm("Are you sure you want to delete "+row.data()[0][1]+"?")) {
                                            table2.rows( { selected: true } ).remove().draw(false);
                                        }
                                        var newData = []
                                        table2.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
                                            var obj = {}
                                            var data = this.data();
                                            obj.etid = data[0]
                                            obj.pct = data[2]
                                            newData.push(obj)
                                        } );
                                        nodeToEdit.data.subdata = newData
                                        table2.button(1).disable()
                                        table2.button(2).disable()
                                    },
                                    enabled: false
                                }
                            ],
                            select: true,
                            
                        }).on( 'select', function ( e, dt, type, indexes ) {
                            $("#editNEDiv").css("display","none")
                            $("#addNEDiv").css("display","none")
                            table2.button(1).enable()
                            table2.button(2).enable()
                        }).on( 'deselect', function ( e, dt, type, indexes ) {
                            $("#editNEDiv").css("display","none")
                            $("#addNEDiv").css("display","none")
                            table2.button(1).disable()
                            table2.button(2).disable()
                        });
                        table2.column(0).visible(false)
                        table2.buttons().container().appendTo( $('#buttonHolder2' ) );

                        $("#cancelAddNE").on("click", function(e) {
                            table2.buttons(0).enable()
                            $("#addNEDiv").css("display","none")
                        })

                        $("#cancelEditNE").on("click", function(e) {
                            table2.rows( { selected: true } ).deselect()
                            table2.buttons(0).enable()
                            $("#editNEDiv").css("display","none")
                        })

                        /* $("#addNewNEPercent").on("change", function(e) {
                            var total = 0
                            table2.rows().every(function(){
                                total += parseInt(this.data()[2]);
                            });
                            total += parseInt($(this).val())
                            $("#addNewNETotal").val(total)
                        })

                        $("#editNEPercent").on("change", function(e) {
                            var total = 0
                            var selRow = table2.rows( { selected: true } )
                            table2.rows().every(function() {
                                if (this.data()[0] != selRow.data()[0][0]) {
                                    total += parseInt(this.data()[2]);
                                }
                            })
                            total += parseInt($(this).val())
                            $("#editNETotal").val(total)
                        }) */

                        $("#addNewNEForm").on("submit",function(e) {
                            e.preventDefault()
                            table2.row
                            .add([
                                $("#addNewNEthnicity").val(),
                                $("#addNewNEthnicity option:selected" ).text(),
                                $("#addNewNEPercent").val()
                            ])
                            .draw(false);
                            $("#addNEDiv").css("display","none")
                            $("#addNewNENation").empty()
                            $("#addNewNEPercent").val(0)
                            var newData = []
                            table2.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
                                var obj = {}
                                var data = this.data();
                                obj.etid = data[0]
                                obj.pct = data[2]
                                newData.push(obj)
                            } );
                            nodeToEdit.data.subdata = newData
                            table2.button(0).enable()
                            table2.button(1).disable()
                            table2.button(2).disable()
                        })

                        $("#editNEForm").on("submit",function(e) {
                            e.preventDefault()
                            table2.rows( { selected: true } ).remove().draw(false);
                            table2.row
                            .add([
                                $("#editNEthnicity").val(),
                                $("#editNEthnicity option:selected" ).text(),
                                $("#editNEPercent").val()
                            ])
                            .draw(false);
                            $("#editNEDiv").css("display","none")
                            $("#editNENation").empty()
                            $("#editNEPercent").val(0)
                            var newData = []
                            table2.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
                                var obj = {}
                                var data = this.data();
                                obj.etid = data[0]
                                obj.pct = data[2]
                                newData.push(obj)
                            } );
                            nodeToEdit.data.subdata = newData
                            table2.button(0).enable()
                            table2.button(1).disable()
                            table2.button(2).disable()
                        })

                        rightDivContent("#infoPanel")

                        break;
                    case "REGIONS_PARENT":
                        if (node.getChildren() != null) {
                            html = '<h2 style="text-align:center;"><img src="./images/map-solid.svg">'+node.countChildren(false)+' Regions found</h2>\n'
                        
                            var nation_count = 0
                            var state_count = 0
                            var city_count = 0

                            for (child of node.getChildren()) {
                                nation_count += child.data.nations.length
                                state_count += child.data.states.length
                                city_count += child.data.cities.length
                            }

                            var sum = nation_count + state_count + city_count

                            html += "<div id='pieChartRP'>\n"
                                    + "<div data-lcolor='"+chroma.random()+"'>"+nation_count+"<span>Nations</span></div>\n"
                                    + "<div data-lcolor='"+chroma.random()+"'>"+state_count+"<span>States</span></div>\n"
                                    + "<div data-lcolor='"+chroma.random()+"'>"+city_count+"<span>Cities</span></div>\n"
                                    + "</div>\n"
                                    + "<h4 style='text-align: center;'><b>Approximate Percentages</b></h4>\n"
                                    + "<div class='result_list'></div>"

                            $("#infoPanel").html(html)

                            rightDivContent("#infoPanel")

                            $("#pieChartRP").listtopie({
                                size:'auto',  
                                strokeWidth:2,
                                hoverEvent:false,
                                hoverBorderColor:'#585858',
                                hoverWidth:2,
                                textSize:'16',
                                marginCenter:30,
                                listVal:true,
                                strokeColor:'#fff',
                                listValMouseOver: true,
                                infoText:true,
                                setValues:false,
                                listValInsertClass:'result_list',
                                backColorOpacity: '0.8',
                                hoverSectorColor:true,
                                usePercent: false,
                                speedDraw:50
                            });
                        } else {
                            html = "<h2 style='text-align:center;'>No Regions Defined</h2>\n"
                                 + "<div style='width:100%; text-align:center;'><input type='button' id='blankRegionButton' value='Add Region'></div>"
                            $("#infoPanel").html(html)

                            $("#blankRegionButton").on("click", function() {
                                $("#addRegionTrigger").trigger("click")
                            })
                            rightDivContent("#infoPanel")
                        }
                         
                    
                        break;
                    case "region":
                        const n_arr = node.data.nations.sort(sortByKey('title'))
                        const s_arr = node.data.states.sort(sortByKey('title'))
                        const c_arr = node.data.cities.sort(sortByKey('title'))
                        var longest = findLargestArray(n_arr, s_arr, c_arr)
                        html = '<h2 style="text-align:center;"><img src="./images/map-location-dot-solid.svg">'+node.title+'</h2>\n'
                                + '<div style="width:100%; text-align:center;">\n'
                                + "<table id='regionInfoTable' style='width:100%;' class='cell-border compact stripe'>"
                                + "<thead><tr style='font-weight:bold;'><td style='width:33%;' class='dt-head-center'>Nations</td><td style='width:33%;' class='dt-head-center'>States</td><td style='width:33%;' class='dt-head-center'>Cities</td></tr></thead>\n"
                                + "<tbody>\n"
                        for (i = 0; i < longest.length; i++) {
                            html += "<tr><td>"+formatValue(n_arr[i])+"</td><td>"+formatValue(s_arr[i])+"</td><td>"+formatValue(c_arr[i])+"</td></tr>"
                        }
                        html += "</tbody></table><br>"
                        html += "<input type='button' id='editRegionButton' class='submit' value='Edit Region'>"
                        html += "</div>\n" 
                        $("#infoPanel").html(html)
                        $('#regionInfoTable').DataTable({});
                        rightDivContent("#infoPanel")
                            $("#editRegionButton").on("click", function(e) {
                            editRegion(node)
                        })
                        break;
                    default:
                        html += node.title + " - " + node.type + "<br>";
                        break;
                }
                
            }
        })

        var cmItems = {}

        $.contextMenu({
            selector: "#xmlOutput span.fancytree-title",
            build: function($trigger, e) {
                var node = $.ui.fancytree.getNode($trigger);
                switch (node.type) {
                    case "ETHNICITIES_PARENT":
                        cmItems = {
                            "add": {name: "Add Ethnicity", icon: 'fa-plus'},
                            "file": {name: "Add Ethnicities From File", icon: 'fa-file-circle-plus'}
                        }
                        break;  
                    case "CONTINENTS_PARENT":
                        cmItems = {
                            "add": {name: "Add Continent", icon: 'fa-plus'},
                            "file": {name: "Add Continents From File", icon: 'fa-file-circle-plus'}
                        }
                        break;  
                    case "REGIONS_PARENT":
                        cmItems = {
                            "add": {name: "Add Region", icon: 'fa-plus'}
                        }
                        break;
                    case "continent":
                        cmItems = {
                            "edit": {name: "Edit \""+node.title +"\"", icon: 'fa-pen-to-square'},
                            "sep1": "----",
                            "add": {name: "Add Nation", icon: 'fa-plus'},
                            "file": {name: "Add Nations From File", icon: 'fa-file-circle-plus'},
                            "sep2": "----",
                            "delete": {name: "Delete \""+node.title +"\"", icon: 'delete'},
                        }
                        break;
                    case "nation":
                        cmItems = {
                            "edit": {name: "Edit \""+node.title +"\"", icon: 'fa-pen-to-square'},
                            "sep1": "----",
                            "move": {name: "Move \""+node.title +"\"", icon: 'fa-arrow-right-arrow-left'},
                            "sep2": "----",
                            "addState": {name: "Add State", icon: 'fa-plus'},
                            "addStatesFromFile": {name: "Add States From File", icon: 'fa-file-circle-plus'},
                            "addSecondNation": {name: "Add Second Nation", icon: 'fa-plus'},
                            "addEthnicity": {name: "Add Ethnicity", icon: 'fa-plus'},
                            "sep3": "----",
                            "delete": {name: "Delete \""+node.title +"\"", icon: 'delete'},
                        }
                        break;
                    case "STATES_PARENT":
                        cmItems = {
                            "add": {name: "Add State", icon: 'fa-plus'},
                            "file": {name: "Add States From File", icon: 'fa-file-circle-plus'},
                        }
                        break;
                    case "state":
                        cmItems = {
                            "edit": {name: "Edit \""+node.title +"\"", icon: 'fa-pen-to-square'},
                            "sep1": "----",
                            "move": {name: "Move \""+node.title +"\"", icon: 'fa-arrow-right-arrow-left'},
                            "sep2": "----",
                            "add": {name: "Add City", icon: 'fa-plus'},
                            "file": {name: "Add Cities From File", icon: 'fa-file-circle-plus'},
                            "sep3": "----",
                            "delete": {name: "Delete \""+node.title +"\"", icon: 'delete'},
                        }
                        break;
                    case "city":
                        cmItems = { 
                            "edit": {name: "Edit \""+node.title +"\"", icon: 'fa-pen-to-square'},
                            "sep1": "----",
                            "move": {name: "Move \""+node.title +"\"", icon: 'fa-arrow-right-arrow-left'},
                            "sep2": "----",
                            "setCap": {name: "Set \""+node.title +"\" as Captiol", icon: 'fa-arrow-right-arrow-left'},
                            "sep3": "----",
                            "delete": {name: "Delete \""+node.title +"\"", icon: 'delete'},
                        }
                        break;
                    case "ethnicity": {
                        cmItems = {
                            "edit": {name: "Edit \""+node.title +"\"", icon: 'fa-pen-to-square'},
                            "sep1": "----",
                            "delete": {name: "Delete \""+node.title +"\"", icon: 'delete'},
                        }
                        break;
                    }
                    case "region": {
                        cmItems = {
                            "edit": {name: "Edit \""+node.title +"\"", icon: 'fa-pen-to-square'},
                            "sep1": "----",
                            "delete": {name: "Delete \""+node.title +"\"", icon: 'delete'},
                        }
                        break;
                    }
                    case "nation_ethnicity": {
                        cmItems = {
                            "view": {name: "View/Edit Ethnicities", icon: 'fa-pen-to-square'}
                        }
                        break;
                    }
                    case "second_nations": {
                        cmItems = {
                            "view": {name: "View/Edit Second Nations", icon: 'fa-pen-to-square'}
                        }
                        break;
                    }
                    default: 
                        cmItems = {}
                        break;
                }
                return {
                    callback: function(key, options) {
                        var m = "clicked: "+key
                        switch (node.type) {
                            case "ETHNICITIES_PARENT":
                                switch (key) {
                                    case "add":
                                        $("#addEthnicityTrigger").click()
                                        break;
                                    case "file":
                                        $("#bulkImportEthnicities").trigger("click")
                                        break;
                                }
                                break;
                            case "CONTINENTS_PARENT":
                                switch (key) {
                                    case "add":
                                        $("#addContinentTrigger").click()
                                        break;
                                    case "file":
                                        $("#bulkImportContinents").trigger("click")
                                        break;
                                }
                                break;  
                            case "REGIONS_PARENT":
                                $("#newRegionSource").trigger("change")
                                $("#newRegionFilter").trigger("change")
                                rightDivContent("#addRegion")
                                break;
                            case "continent":
                                switch (key) {
                                    case "add":
                                        addNation(node.data.id)
                                        break;
                                    case "file":
                                        addNationsFromFile(node.data.id);
                                        break;
                                    case "delete":
                                        if (confirm("Are you sure you want to delete "+node.title+"?\n\nThis will delete all of "+node.title+"'s nations, states and cities as well!\n\nThis action can not be undone and may have unintended consequences!")) {
                                            deleteNode(node)
                                        } 
                                        break;
                                    case "edit":
                                        editContinent(node)
                                        break;
                                }
                                break;
                            case "nation":
                                switch (key) {
                                    case "edit":
                                        editNation(node)
                                        break;
                                    case "addState":
                                        addState(node.parent.data.id,node.data.id)
                                        //$("#addStateTrigger").click()
                                        break;
                                    case "addStatesFromFile":
                                        $("#bulkImportStates").trigger("click", [node.parent.data.id, node.data.id])
                                        break;
                                    case "addSecondNation":
                                        addSecondNation(node.id)
                                        break;
                                    case "addEthnicity":
                                        console.log("add ethnicity TBD")
                                        break;
                                    case "delete":
                                        if (confirm("Are you sure you want to delete "+node.title+"?\n\nThis will delete all of "+node.title+"'s states and cities as well!\n\nThis action can not be undone and may have unintended consequences!")) {
                                            deleteNode(node)
                                        } 
                                        break;
                                    case "move":
                                        moveNation(node)
                                        break;
                                }
                                break;
                            case "STATES_PARENT":
                                switch (key) {
                                    case "add":
                                        addState(node.parent.parent.data.id,node.parent.data.id)
                                        break;
                                    case "file":
                                        $("#bulkImportStates").trigger("click", [node.parent.parent.data.id, node.parent.data.id])
                                        break;
                                }
                            case "state":
                                switch (key) {
                                    case "edit":
                                        editState(node)
                                        break;
                                    case "add":
                                        //$("#addCityTrigger").click()
                                        addCity(node.parent.parent.parent.data.id, node.parent.parent.data.id, node.data.id)
                                        break;
                                    case "file":
                                        $("#bulkImportCities").trigger("click", [node.parent.parent.parent.data.id, node.parent.parent.data.id, node.data.id])
                                        break;
                                    case "delete":
                                        if (confirm("Are you sure you want to delete "+node.title+"?\n\nThis will delete all of "+node.title+"'s cities as well!\n\nThis action can not be undone and may have unintended consequences!")) {
                                            deleteNode(node)
                                        } 
                                        break;
                                    case "move":
                                        moveState(node)
                                        break;
                                }
                                break;
                            case "city":
                                switch (key) {
                                    case "edit":
                                        editCity(node)
                                        break;
                                    case "delete":
                                        if (confirm("Are you sure you want to delete "+node.title+"?\n\nThis action can not be undone and may have unintended consequences!")) {
                                            deleteNode(node)
                                        } 
                                        break;
                                    case "move":
                                        moveCity(node)
                                        break;
                                    case "setCap":
                                        //console.log(node.data.id, node.title)
                                        node.parent.parent.parent.data.capid = node.data.id
                                        //console.log(node.parent.parent.parent.data)
                                        resetCaptiol(node.parent.parent.parent)   
                                        break;
                                }
                                break;
                            case "ethnicity":
                                switch (key) {
                                    case "delete":
                                        if (confirm("Are you sure you want to delete "+node.title+"?\n\nThis action can not be undone and may have unintended consequences!")) {
                                            deleteNode(node)
                                        } 
                                        break;
                                    case "edit":
                                        editEthnicity(node)
                                        break;
                                }
                                break;
                            case "region":
                                switch (key) {
                                    case "delete":
                                        if (confirm("Are you sure you want to delete "+node.title+"?\n\nThis action can not be undone and may have unintended consequences!")) {
                                            deleteNode(node)
                                        } 
                                        break;
                                    case "edit":
                                        editRegion(node)
                                        break;
                                }
                                break;
                            case "nation_ethnicity":
                                node.setActive(true)
                                break;
                            case "second_nations":
                                node.setActive(true)
                                break;
                            default: 
                                break;
                        }
                    },
                    items: cmItems
                }
            }
        });

        $("#continent_count").text(continent_count)
        $("#nation_count").text(nation_count)
        $("#state_count").text(state_count)
        $("#city_count").text(city_count)
        $("#ethnicity_count").text(ethnicity_count)
        $("#region_count").text(region_count)
        $("#usa_defined_count").text(usa_defined.length)
        $("#max_continent_id").text(max_continent_id)
        $("#max_nation_id").text(max_nation_id)
        $("#max_state_id").text(max_state_id)
        $("#max_city_id").text(max_city_id)
        $("#max_ethnicity_id").text(max_ethnicity_id)
        $("#max_region_id").text(max_region_id)

        var tree = $.ui.fancytree.getTree("#xmlOutput")
        var world = tree.findFirst("CONTINENT")
        if (world != null) {
            world.sortChildren(null, true);
        }
    
        var ethnicities = tree.findFirst("ETHNICITIES")
        if (ethnicities != null) {
            ethnicities.sortChildren(null, true);
        }
        var regions = tree.findFirst("REGIONS")
        if (regions != null) {
            regions.sortChildren(null, true);
        }
    
        $.each(nations_by_id, function(key, value) {
            $('#multi_d')
                .append($('<option>', { value : key })
                .text(value));
        });

        $("#overlay").css("display","none")
    }

    $("#addEthnicityTrigger").on("click", function(e) {
        $("#newEthnicityName").val("")
        $("#newEthnicityNameK").val("")
        $("#newEthnicityID").val(max_ethnicity_id+1)
        $("#newEthnicityIdDisplay").html(max_ethnicity_id+1)
        $(".newEthPct").each(function(){
            $(this).val(0);
        });
        $("#newEthnicityTotal").css("color","red")
        $("#newEthnicityTotal").val("0")
        rightDivContent("#addEthnicity")
        //$("#addEthnicity").css("display","inline-block")
    })

    $("#addContinentTrigger").on("click", function(e) {
        $("#newContinentName").val("")
        $("#newContinentNameK").val("")
        $("#newContinentAbbr").val("")
        $("#newContinentAbbrK").val("")
        $("#newContinentDem").val("")
        $("#newContinentDemK").val("")
        $("#newContinentPopulation").val(0)
        $("#newContinentEtid").val(0)
        $("#newContinentID").val(max_continent_id+1)
        $("#newContinentIDDisplay").text(max_continent_id+1)
        rightDivContent("#addContinent")
    })

    $("#addNationTrigger").on("click", function(e) {
        addNation(null)
    })

    $("#addStateTrigger").on("click", function(e) {
        addState(null, null)
    })

    $("#addCityTrigger").on("click", function(e) {
        addCity(null, null, null)
    })

    $("#addRegionTrigger").on("click", function(e) {
		$("#newRegionID").val(max_region_id+1)
        $("#newRegionIdDisplay").html(max_region_id+1)
        $("#newRegionName").val("")
        $("#newRegionNameK").val("")
        $("#multi_d_to_3").empty()
        $("#multi_d_to_2").empty()
        $("#multi_d_to").empty()
        $("#newRegionSource").val("Nations")
        $("#newRegionSource").trigger("change")
        rightDivContent("#addRegion")
	});

    function deleteNode(node) {
        console.log("You asked for it")
        node.remove()
    }

    function editEthnicity(node) {
        nodeToEdit = node
        const t = parseInt(node.data.african) 
                + parseInt(node.data.asian) 
                + parseInt(node.data.east_indian) 
                + parseInt(node.data.caucasian)
                + parseInt(node.data.hispanic)
        $("#editEthnicityName").val(node.title)
        $("#editEthnicityNameK").val(node.data.name_korean)
        $("#editEthnicityID").val(max_ethnicity_id+1)
        $("#editEthnicityDisplay").html(max_ethnicity_id+1)
        $("#editEthnicityAfrican").val(node.data.african)
        $("#editEthnicityAsian").val(node.data.asian)
        $("#editEthnicityEastIndian").val(node.data.east_indian)
        $("#editEthnicityCaucasian").val(node.data.caucasian)
        $("#editEthnicityHispanic").val(node.data.hispanic)
        $("#editEthnicityTotal").css("color",(t == 1000) ? "green" : "red")
        $("#editEthnicityTotal").val(t)
        rightDivContent("#editEthnicity")
    }

    function editContinent(node) {
        nodeToEdit = node
        $("#editContinentName").val(node.title)
        $("#editContinentNameK").val(node.data.title_korean)
        $("#editContinentAbbr").val(node.data.abbr)
        $("#editContinentAbbrK").val(node.data.abbr_korean)
        $("#editContinentDem").val(node.data.dem)
        $("#editContinentDemK").val(node.data.dem_korean)
        $("#editContinentPop").val(parseInt(node.data.pop))
        $("#editContinentEtid").val(parseInt(node.data.etid))
        $("#editContinentID").val(node.data.id)
        $("#editContinentIDDisplay").text(node.data.id)
        rightDivContent("#editContinent")
    }

    function editNation(node) {
        nodeToEdit = node
        //console.log(node)
        $("#editNationCapitolState").empty()
        $("#editNationID").val(node.data.id)
        $("#editNationIDDisplay").text(node.data.id)
        $("#editNationName").val(node.title)
        $("#editNationNameK").val(node.data.title_korean)
        $("#editNationAbbr").val(node.data.abbr)
        $("#editNationAbbrK").val(node.data.abbr_korean)
        $("#editNationShortK").val(node.data.short_korean)
        $("#editNationDem").val(node.data.dem)
        $("#editNationDemK").val(node.data.dem_korean)
        $("#editNationPopulation").val(node.data.pop)
        $("#editNationEtid").val(node.data.etid)
        $("#editNationTimeZone").val(node.data.time_zone)
        for (x of states_by_nation[node.data.id]) {
            $('#editNationCapitolState')
                .append($('<option>', { value : x.id })
                .text(x.title));
        }

        sortDropdown("#editNationCapitolState")
        
        if (node.data.capid == 0) {
            $("#editNationCapitolState").prepend("<option value='0' selected='selected'>SELECT A STATE</option>");
            $("#editNationCapitol").prepend("<option value='0' selected='selected'></option>");
        } else {
            var city = cities_by_nation[node.data.id].find( function( city ){
                return city.id === node.data.capid;
            } );
            if (city == null) {
                console.log("No cities yet!")
            }

        }
        
        
        if (parseInt(node.data.capid) > 0) {
            $('#editNationCapitolState').val(city.state)
            $('#editNationCapitolState').trigger("change")
            $('#editNationCapitol').val(node.data.capid)
        } else {
            $('#editNationCapitolState').val("0")
        }
        $("#editNationUSA").val(node.data.this_is_the_usa)
        $("#editNationHardcoded").val(node.data.use_hardcoded_ml_player_origins)
        rightDivContent("#editNation")
    }

    $("#editNationCapitolState").on("change", function(e) {
        $('#editNationCapitol').empty()
        if ($(this).val() > 0) {
            for (x of cities_by_state[$(this).val()]) {
                $('#editNationCapitol')
                    .append($('<option>', { value : x.id })
                    .text(x.title));
            }
            sortDropdown("#editNationCapitol")
        }
    })

    function editState(node) {
        nodeToEdit = node
        var lat = (node.data.lat != 0) ? node.data.lat : "00.00000"
        var long = (node.data.long != 0) ? node.data.long : "00.00000"
        $("#editStateId").val(node.data.id)
        $("#editStateIDDisplay").text(node.data.id)
        $("#editStateName").val(node.title)
        $("#editStateNameK").val(node.data.title_korean)
        $("#editStateAbbr").val(node.data.abbr)
        $("#editStateAbbrK").val(node.data.abbr_korean)
        $("#editStatePopulation").val(node.data.pop)
        $("#editStateTimeZone").val(node.data.time_zone)
        $("#editStateDST").val(node.data.observes_dst)
        $("#editStateLatitude").val(lat)
        $("#editStateLongitude").val(long)
        rightDivContent("#editState")
    }

    function editCity(node) {
        nodeToEdit = node
        var lat = (node.data.lat != 0) ? node.data.lat : "00.00000"
        var long = (node.data.long != 0) ? node.data.long : "00.00000"
        var cap = (node.parent.parent.parent.data.capid == node.data.id) ? 1 : 0
        $("#editCityId").val(node.data.id)
        $("#editCityIDDisplay").text(node.data.id)
        $("#editCityName").val(node.title)
        $("#editCityAbbr").val(node.data.abbr)
        $("#editCityPopulation").val(node.data.pop)
        $("#editCityTimeZone").val(node.data.time_zone)
        $("#editCityCapitol").val(cap)
        $("#editCityDST").val(node.data.observes_dst)
        $("#editCityLatitude").val(lat)
        $("#editCityLongitude").val(long)
        $("#editCityAltitude").val(node.data.altitude)
        $("#editCityNameK").val(node.data.title_korean)
        $("#editCityAbbrK").val(node.data.abbr_korean)
        rightDivContent("#editCity")
    }

    function editRegion(node) {
        nodeToEdit = node
        console.log(node)
        $("#editRegionName").val(node.title)
        $("#editRegionNameK").val(node.data.name_korean)
        $("#edit_multi_d").empty()
        $("#edit_multi_d_to").empty()
        $("#edit_multi_d_to_2").empty()
        $("#edit_multi_d_to_3").empty()
        for (child of node.data.nations) {
            $("#edit_multi_d_to")
                .append($('<option>', { value : child.id })
                .text(child.title));
        }
        for (child of node.data.states) {
            $("#edit_multi_d_to_2")
                .append($('<option>', { value : child.id })
                .text(child.title));
        }
        for (child of node.data.cities) {
            $("#edit_multi_d_to_3")
                .append($('<option>', { value : child.id })
                .text(child.title));
        }
        sortDropdown("#edit_multi_d_to")
        sortDropdown("#edit_multi_d_to_2")
        sortDropdown("#edit_multi_d_to_3")
        console.log($("#editRegionSource").val())
        $("#editRegionSource").trigger("change")
        rightDivContent("#editRegion")
    }

    function moveNation(node) {
        nodeToEdit = node
        $("#moveNationToContinent").empty()
        $.each(continents_by_id, function(key, value) {
            if (key != node.parent.data.id) {
                $("#moveNationToContinent")
                    .append($('<option>', { value : key })
                    .text(value));
            }
        });
        sortDropdown("#moveNationToContinent")
        rightDivContent("#moveNation")
    }

    function moveState(node) {
        nodeToEdit = node
        $("#moveStateToContinent").empty()
        $("#moveStateToNation").empty()
        $.each(continents_by_id, function(key, value) {
            $("#moveStateToContinent")
                .append($('<option>', { value : key })
                .text(value));
        });
        sortDropdown("#moveStateToContinent")
        for (nation of nations_by_continent[$("#moveStateToContinent").val()]) {
            if (nodeToEdit.parent.parent.data.id != nation.id) {
                $('#moveStateToNation')
                    .append($('<option>', { value : nation.id })
                    .text(nation.title));
            }
        }
        sortDropdown("#moveStateToNation")
        rightDivContent("#moveState")
    }

    $("#moveStateToContinent").on("change", function() {
        $("#moveStateToNation").empty()
        for (nation of nations_by_continent[$(this).val()]) {
            if (nodeToEdit.parent.parent.data.id != nation.id) {
                $('#moveStateToNation')
                    .append($('<option>', { value : nation.id })
                    .text(nation.title));
            }
        }
        sortDropdown("#moveStateToNation")
    })

    function moveCity(node) {
        nodeToEdit = node
        $("#moveCityToContinent").empty()
        $("#moveCityToNation").empty()
        $("#moveCityToNation").empty()
        $.each(continents_by_id, function(key, value) {
            $("#moveCityToContinent")
                .append($('<option>', { value : key })
                .text(value));
        });
        sortDropdown("#moveCityToContinent")
        for (nation of nations_by_continent[$("#moveCityToContinent").val()]) {
            $('#moveCityToNation')
                .append($('<option>', { value : nation.id })
                .text(nation.title));
        }
        sortDropdown("#moveCityToNation")
        for (state of states_by_nation[$("#moveCityToNation").val()]) {
            if (nodeToEdit.parent.data.id != state.id) {
                $('#moveCityToState')
                    .append($('<option>', { value : state.id })
                    .text(state.title));
            }
        }
        sortDropdown("#moveCityToState")
        rightDivContent("#moveCity")
    }

    $("#moveCityToContinent").on("change", function() {
        $("#moveCityToNation").empty()
        for (nation of nations_by_continent[$(this).val()]) {
            $('#moveCityToNation')
                .append($('<option>', { value : nation.id })
                .text(nation.title));
        }
        sortDropdown("#moveCityToNation")
        $("#moveCityToNation").trigger("change")
    })

    $("#moveCityToNation").on("change", function() {
        $("#moveCityToState").empty()
        for (state of states_by_nation[$(this).val()]) {
            if (nodeToEdit.parent.data.id != state.id) {
                $("#moveCityToState")
                    .append($('<option>', { state : nation.id })
                    .text(state.title));
            }
        }
        sortDropdown("#moveCityToState")
    })

    /*     $(".defineUSA").on("change", function() {
        //var el = "#"+$(this).attr("id")
        //var newUSA = ($(this).attr("id") == "newNationUSA") ? $("#newNationID").val() : $("#editNationID").val()
        //var usa = findUSA()
        if ($(this).val() == 1) {
            if (findUSA != null) {
                if (confirm(nations_by_id[usa]+" is already defined as the USA.\n\nAre you sure you want to change that?")) {
                    var oldUSA = findNationFromScratch(usa)
                    oldUSA.data.this_is_the_usa = 0
                }
            }
        } else {
            console.log("you set it to not be the usa")
        }
    }) */

    function addNation(continent) {
        $("#newNationContinent").empty()
        $.each(continents_by_id, function(key, value) {
            $('#newNationContinent')
                .append($('<option>', { value : key })
                .text(value));
        });
        $("#newNationContinent").html($('#newNationContinent option').sort(function(x, y) {
            return $(x).text().toLowerCase() < $(y).text().toLowerCase() ? -1 : 1;
        }))
        if (continent == null) {
            $("#newNationContinent :nth-child(1)").prop('selected', true);
        } else {
            $("#newNationContinent").val(continent).change();
        }
        $("#newNationName").val("")
        $("#newNationNameK").val("")
        $("#newNationAbbr").val("")
        $("#newNationAbbrK").val("")
        $("#newNationShortK").val("")
        $("#newNationDem").val("")
        $("#newNationDemK").val("")
        $("#newNationPopulation").val(0)
        $("#newNationEtid").val(0)
        $("#newNationLid").val(0)
        $("#newNationID").val(max_nation_id+1)
        $("#newNationIDDisplay").text(max_nation_id+1)
        $("#newNationGender :nth-child(1)").prop('selected', true);
        $("#newNationBbqual :nth-child(3)").prop('selected', true);
        $("#newNationTimeZone :nth-child(14)").prop('selected', true);
        $("#newNationDST :nth-child(1)").prop('selected', true);
        $("#newNationUSA :nth-child(1)").prop('selected', true);

        rightDivContent("#addNation")
    }

    function addNationsFromFile(continent) {
        $("#bulkImportNations").trigger("click", continent)
        $("#bulkNationContinent").val(continent).trigger("change")
    }

    function addState(continent,nation) {
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        var con = tree.findFirst("CONTINENTS")
        $.each(continents_by_id, function(key, value) {
            $('#newStateContinent')
                .append($('<option>', { value : key })
                .text(value));
        });
        if (continent == null) {
            $("#newStateContinent :nth-child(1)").prop('selected', true);
        } else {
            $("#newStateContinent").val(continent);
        }
        $("#newStateContinent").trigger("change")
        if (nation == null) {
            $("#newStateNation :nth-child(1)").prop('selected', true);
        } else {
            $("#newStateNation").val(nation);
        }
        var n = findNation($("#newStateContinent option:selected" ).text(), $("#newStateNation option:selected" ).text())
        $("#newStateId").val(max_state_id+1)
        $("#newStateIDDisplay").text(max_state_id+1)
        $("#newStateName").val("")
        $("#newStateNameK").val("")
        $("#newStatePopulation").val(0)
        $("#newStateAbbr").val("")
        $("#newStateAbbrK").val("")
        $("#newStateTimeZone").val(n.data.time_zone)
        //$("#newStateTimeZone :nth-child(30)").prop('selected', true);
        $("#newStateDST :nth-child(1)").prop('selected', true);
        $("#newStateLatitude").val("00.00000")
        $("#newStateLongitude").val("00.00000")
        rightDivContent("#addState")
    }

    $("#newStateContinent").on("change", function() { 
        $("#newStateNation").empty()
        for (nation of nations_by_continent[$(this).val()]) {
            $('#newStateNation')
                    .append($('<option>', { value : nation.id })
                    .text(nation.title));
        }
        $("#newStateNation").html($('#newStateNation option').sort(function(x, y) {
            return $(x).text().toLowerCase() < $(y).text().toLowerCase() ? -1 : 1;
        }))
        $("#newStateNation").trigger("change")
    })

    $("#newStateNation").on("change",function() {
        n = findNation($("#newStateContinent option:selected").text(), $("#newStateNation option:selected" ).text())
        $("#newStateTimeZone").val(n.data.time_zone)
    })  

    function addSecondNation(nation) {
        console.log(nation)
        console.log(nations_by_id[nation])
    }

    function findContinent(continent) {
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        var world = tree.findFirst("CONTINENTS")
        var arr = world.findAll(continent)
        for (c of arr) {
            if (c.type == "continent") {
                if (c.title == continent) {
                    return c
                }
            }
        }
    }

    function findNation(continent, nation) {
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        var con = findContinent(continent)
        var arr = con.findAll(nation) 
        for (n of arr) {
            if (n.type == "nation") {
                if (n.title == nation) {
                    return n
                }
            }
        }
    }

    function findNationFromScratch(nationToFind) {
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        var world = tree.findFirst("CONTINENTS")
        for (continent of world.getChildren()) {
            for (nation of continent.getChildren()) {
                if (nation.data.id == nationToFind) { 
                    return nation
                }
            }
        }
    }

    function findState(continent, nation, state) {
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        var nat = findNation(continent, nation)
        var arr = nat.findAll(state)
        for (s of arr) {
            if (s.type == "state") {
                if (s.title == state) {
                    return s
                }
            }
        }
    }

    function addCity(continent, nation, state) {
        $("#newCityContinent").empty()
        $.each(continents_by_id, function(key, value) {
            $('#newCityContinent')
                .append($('<option>', { value : key })
                .text(value));
        });
        $("#newCityContinent").html($('#newCityContinent option').sort(function(x, y) {
            return $(x).text().toLowerCase() < $(y).text().toLowerCase() ? -1 : 1;
        }))
        if (continent == null) { 
            $("#newCityContinent :nth-child(1)").prop('selected', true);
        } else {
            $("#newCityContinent").val(continent);
        }
        $("#newCityContinent").trigger("change")
        if (nation == null) { 
            $("#newCityNation :nth-child(1)").prop('selected', true);
        } else {
            $("#newCityNation").val(nation);
        }
        $("#newCityNation").trigger("change")
        if (state == null) { 
            $("#newCityState :nth-child(1)").prop('selected', true);
        } else {
            $("#newCityState").val(state);
        }
        var s = findState($("#newCityContinent option:selected" ).text(), $("#newCityNation option:selected" ).text(), $("#newCityState option:selected" ).text())
        $("#newCityId").val(max_city_id+1)
        $("#newCityIDDisplay").text(max_city_id+1)
        $("#newCityName").val("")
        $("#newCityAbbr").val("")
        $("#newCityPopulation").val(0)
        $("#newCityTimeZone").val(s.data.time_zone)
        if (s.data.observes_dst == undefined) {
            $("#newCityDST").val(0)
        } else {
            $("#newCityDST").val(s.data.observes_dst)
        }
        $("#newCityLatitude").val("00.00000")
        $("#newCityLongitude").val("00.00000")
        $("#newCityAltitude").val("0")
        $("#newCityNameK").val("")
        $("#newCityAbbrK").val("")

        rightDivContent("#addCity")
    }
    
    $("#newCityContinent").on("change", function() { 
        $("#newCityNation").empty()
        for (nation of nations_by_continent[$(this).val()]) {
            $('#newCityNation')
                    .append($('<option>', { value : nation.id })
                    .text(nation.title));
        }
        $("#newCityNation").html($('#newCityNation option').sort(function(x, y) {
            return $(x).text().toLowerCase() < $(y).text().toLowerCase() ? -1 : 1;
        }))
        $("#newCityNation").trigger("change")
    })

    $("#newCityNation").on("change", function() { 
        $("#newCityState").empty()
        for (state of states_by_nation[$(this).val()]) {
            $('#newCityState')
                    .append($('<option>', { value : state.id })
                    .text(state.title));
        }
        $("#newCityState").html($('#newCityState option').sort(function(x, y) {
            return $(x).text().toLowerCase() < $(y).text().toLowerCase() ? -1 : 1;
        }))
        $("#newCityState").trigger("change")
    })

    $(".newCityAltCalc").on("change",function() {
        ipcRenderer.send('get-elevation',[$("#newCityLatitude").val(),$("#newCityLongitude").val(),"#newCityAltitude"])
    })

    $(".editCityAltCalc").on("change", function() {
        ipcRenderer.send('get-elevation',[$("#editCityLatitude").val(),$("#editCityLongitude").val(),"#editCityAltitude"])
    })

    $(".firstwCityAltCalc").on("change", function() {
        ipcRenderer.send('get-elevation',[$("#firstCityLatitude").val(),$("#firstCityLongitude").val(),"#firstCityAltitude"])
    })

    $(".toKorean").on("keyup",function() {
        var id = $(this).attr("id")
        translate($(this).val(), null, 'ko').then(res => {
            $("#"+id+"K").val(res.translation)
        }).catch(err => {
            $("#"+id+"K").val("")
        });
    })

    $("#newEthnicityName").on("keyup", function() {
        translate($(this).val(), null, 'ko').then(res => {
            $("#newEthnicityNameK").val(res.translation)
        }).catch(err => {
            $("#newEthnicityNameK").val("")
        });
    })

    $(".newEthPct").on("change",function() {
        var sum = 0;
        $(".newEthPct").each(function(){
            sum += +$(this).val();
        });
        if (sum !== 1000) {
            $("#newEthnicityTotal").css("color","red")
        } else {
            $("#newEthnicityTotal").css("color","green")
        }
        $("#newEthnicityTotal").val(sum)
    })

    $(".editEthPct").on("change",function() {
        var sum = 0;
        $(".editEthPct").each(function(){
            sum += +$(this).val();
        });
        if (sum !== 1000) {
            $("#editEthnicityTotal").css("color","red")
        } else {
            $("#editEthnicityTotal").css("color","green")
        }
        $("#editEthnicityTotal").val(sum)
    })

    $(".firstEthPct").on("change",function() {
        var sum = 0;
        $(".firstEthPct").each(function(){
            sum += +$(this).val();
        });
        if (sum !== 1000) {
            $("#firstEthnicityTotal").css("color","red")
        } else {
            $("#firstEthnicityTotal").css("color","green")
        }
        $("#firstEthnicityTotal").val(sum)
    })

    function firstStuffSubmit() {
        $("#form-5").trigger("submit")
    }

    $("#form-5").on("submit", function(e) {
        e.preventDefault()

        const regions_arr = {}
        regions_arr.title = "REGIONS"
        regions_arr.folder = true
        regions_arr.icon = './images/map-solid.svg'
        regions_arr.type = "REGIONS_PARENT"
        regions_arr.children = []
        
        const ethnicities_arr = {}
        const ethnicities = []
        ethnicities_arr.title = "ETHNICITIES";
        ethnicities_arr.folder = true
        ethnicities_arr.type = "ETHNICITIES_PARENT"
        ethnicities_arr.icon = './images/people-group-solid.svg'

        const continent_arr = {};
        const continents = [];
        const nations = []
        continent_arr.title = "CONTINENTS";
        continent_arr.folder = true;
        continent_arr.icon = './images/globe-solid.svg'
        continent_arr.type = "CONTINENTS_PARENT"

        const ethnicity_obj = {}
        const continent_obj = {}
        const nation_obj = {}
        const state_obj = {}
        const state_arr = []
        const city_arr = []
        const city_obj = {}
        const second_nations_obj = {}
        const nation_eth_obj = {}
        const tree_json = []

        const states_obj = {}
        states_obj.title = "States"
        states_obj.folder = true
        states_obj.icon = './images/landmark-dome-solid.svg'
        states_obj.type = "STATES_PARENT"
        states_obj.children = ([])
                
        ethnicity_obj.type = 'ethnicity'
        ethnicity_obj.folder = false
        ethnicity_obj.icon = './images/user-group-solid.svg'
        ethnicity_obj.title = $("#firstEthnicityName").val()
        ethnicity_obj.name_korean = $("#firstEthnicityNameK").val()
        ethnicity_obj.id = max_ethnicity_id + 1
        ethnicity_obj.african = $("#firstEthnicityAfrican").val()
        ethnicity_obj.asian = $("#firstEthnicityAsian").val()
        ethnicity_obj.east_indian = $("#firstEthnicityEastIndian").val()
        ethnicity_obj.caucasian = $("#firstEthnicityCaucasian").val()
        ethnicity_obj.hispanic = $("#firstEthnicityHispanic").val()
        ethnicities.push(ethnicity_obj)
        ethnicities_arr.children = ethnicities
        ethnicities_by_id[1] = $("#firstEthnicityName").val()
        max_ethnicity_id++
        ethnicity_count++

        continent_obj.type = 'continent'
        continent_obj.folder = true
        continent_obj.icon = './images/earth-americas-solid.svg'
        continent_obj.id = 1
        continent_obj.title = $("#firstContinentName").val()
        continent_obj.title_korean = $("#firstContinentNameK").val()
        continent_obj.pop = $("#firstContinentPop").val()
        continent_obj.etid = 1
        continent_obj.abbr = $("#firstContinentAbbr").val()
        continent_obj.dem = $("#firstContinentDem").val()
        continent_obj.abbr_korean =  $("#firstContinentAbbrK").val()
        continent_obj.dem_korean = $("#firstContinentDemK").val()
        continents.push(continent_obj)
        continent_arr.children = continents
        continents_by_id[1] = $("#firstContinentName").val()
        max_continent_id++
        continent_count++

        nation_obj.type = 'nation'
        nation_obj.folder = true
        nation_obj.icon = ($("#firstNationUSA").val() == 1) ? './images/flag-usa-solid.svg' : './images/flag-solid.svg'
        nation_obj.id = 1
        nation_obj.title = $("#firstNationName").val()
        nation_obj.title_korean = $("#firstNationNameK").val()
        nation_obj.short_korean = $("#firstNationShortK").val()
        nation_obj.pop = $("#firstNationPopulation").val()
        nation_obj.etid = 1
        nation_obj.capid = 0
        nation_obj.gender = $("#firstNationGender").val()
        nation_obj.bbqual = $("#firstNationBbqual").val()
        nation_obj.abbr = $("#firstNationAbbr").val()
        nation_obj.abbr_korean = $("#firstNationAbbrK").val()
        nation_obj.dem = $("#firstNationDem").val()
        nation_obj.dem_korean = $("#firstNationDemK").val()
        nation_obj.time_zone = $("#firstNationTimeZone").val()
        nation_obj.observes_dst = $("#firstNationDST").val()
        nation_obj.this_is_the_usa = $("#firstNationUSA").val()
        nation_obj.use_hardcoded_ml_player_origins = $("#firstNationHardcoded").val()
        nation_obj.children = []
        nations.push(nation_obj)
        nations_by_id[1] = $("#firstNationName").val()
        max_nation_id++
        nation_count++
        $("#firstStateTimeZone").val($("#firstNationTimeZone").val())

        second_nations_obj.title = "Second Nations"
        second_nations_obj.folder = false
        second_nations_obj.icon = './images/circle-plus-solid.svg'
        second_nations_obj.type = 'second_nations'
        second_nations_obj.subdata = []
            
        nation_eth_obj.title = "Ethnicities"
        nation_eth_obj.folder = false
        nation_eth_obj.icon = './images/user-group-solid.svg'
        nation_eth_obj.type = 'nation_ethnicity'
        nation_eth_obj.subdata = []

        state_obj.type = 'state'
        state_obj.folder = true
        state_obj.icon = './images/landmark-flag-solid.svg'
        state_obj.id = 1
        state_obj.title = $("#firstStateName").val()
        state_obj.title_korean = $("#firstStateNameK").val()
        state_obj.pop = $("#firstStatePopulation").val()
        state_obj.abbr = $("#firstStateAbbr").val()
        state_obj.abbr_korean = $("#firstStateAbbrK").val()
        state_obj.time_zone = $("#firstStateTimeZone").val()
        state_obj.observes_dst = $("#firstStateDST").val()
        state_obj.lat = $("#firstStateLatitude").val().trim()
        state_obj.long = $("#firstStateLongitude").val().trim()
        state_obj.children = []
        states_by_id[1] = $("#firstStateName").val()
        max_state_id++
        state_count++
        $("#firstCityTimeZone").val($("#firstStateTimeZone").val())

        city_obj.type = 'city'
        city_obj.folder = false
        city_obj.icon = './images/city-solid.svg'
        city_obj.id = 1
        city_obj.title = $("#firstCityName").val()
        city_obj.title_korean = $("#firstCityNameK").val()
        city_obj.pop = $("#firstCityPopulation").val()
        city_obj.lat = $("#firstCityLatitude").val()
        city_obj.long = $("#firstCityLongitude").val()
        city_obj.abbr = $("#firstCityAbbr").val()
        city_obj.altitude = $("#firstCityAltitude").val()
        city_obj.abbr_korean = $("#firstCityAbbrK").val()
        city_obj.time_zone = $("#firstCityTimeZone").val()
        city_obj.observes_dst = $("#firstCityDST").val()
        city_obj.state = "1"
        city_obj.nation = "1"

        var obj = {}
        obj.name = $("#firstCityName").val()
        obj.state = "1"
        obj.nation = "1"
        obj.continent = "1"

        var city_bn_obj = {}
        city_bn_obj.id = "1"
        city_bn_obj.title = $("#firstCityName").val()
        city_bn_obj.state = "1"
        city_bn_obj.nation = "1"

        cities_by_state[1] = obj
        cities_by_id[1] = obj

        max_city_id++
        city_count++

        city_arr.push(city_obj)
        state_arr.push(state_obj)
        state_obj.children.push(city_obj)
        states_obj.children = state_arr
        nation_obj.children = [second_nations_obj, nation_eth_obj, states_obj]
        continent_obj.children = nations

        nations_by_continent[1] = nations
        states_by_nation[1] = state_arr
        cities_by_state[1] = city_arr
        cities_by_nation[1] = [city_bn_obj]

        tree_json.push(ethnicities_arr, continent_arr, regions_arr)

        initTree(tree_json)

        $.magnificPopup.close()
    })

    $("#newEthnicityForm").on("submit", function(e) {
        e.preventDefault()
        ethnicity_count++;
        var ethnicity_obj = {}
        ethnicity_obj.type = 'ethnicity'
        ethnicity_obj.folder = false
        ethnicity_obj.icon = './images/user-group-solid.svg'
        ethnicity_obj.title = $("#newEthnicityName").val()
        ethnicity_obj.name_korean = $("#newEthnicityNameK").val()
        ethnicity_obj.id = $("#newEthnicityID").val()
        ethnicity_obj.african = $("#newEthnicityAfrican").val()
        ethnicity_obj.asian = $("#newEthnicityAsian").val()
        ethnicity_obj.east_indian = $("#newEthnicityEastIndian").val()
        ethnicity_obj.caucasian = $("#newEthnicityCaucasian").val()
        ethnicity_obj.hispanic = $("#newEthnicityHispanic").val()
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        var world = tree.findFirst("ETHNICITIES")
        world.addChildren(ethnicity_obj)
        world.sortChildren(null, true);
        var ethnicity = world.findFirst($("#newEthnicityName").val())
        world.setExpanded()
        ethnicity.setFocus()
        ethnicity.setActive()
        ethnicity.makeVisible({scrollIntoView: true});
        $("#max_ethnicity_id").text(max_ethnicity_id)
        $("#ethnicity_count").text(ethnicity_count)
    })

    $("#newContinentForm").on("submit", function(e) {
        e.preventDefault()
        var continent_obj = {}
        continent_obj.type = 'continent'
        continent_obj.folder = true
        continent_obj.icon = './images/earth-americas-solid.svg'
        continent_obj.id = $("#newContinentID").val()
        continent_obj.title = $("#newContinentName").val()
        continent_obj.title_korean = $("#newContinentNameK").val()
        continent_obj.pop = $("#newContinentPop").val()
        continent_obj.etid = $("#newContinentEtid").val()
        continent_obj.abbr = $("#newContinentAbbr").val()
        continent_obj.dem = $("#newContinentDem").val()
        continent_obj.abbr_korean =  $("#newContinentAbbrK").val()
        continent_obj.dem_korean = $("#newContinentDemK").val() 
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        var world = tree.findFirst("CONTINENT")
        world.addChildren(continent_obj)
        world.sortChildren(null, true);
        var continent = world.findFirst($("#newContinentName").val())
        world.setExpanded()
        tree.activateKey(false)
        continent.setFocus()
        continent.setActive()
        continent_count++
        if (parseInt($("#newContinentID").val()) > max_continent_id) { max_continent_id = parseInt($("#newContinentID").val()) }
        continents_by_id[$("#newContinentID").val()] = $("#newContinentName").val()
        nations_by_continent[$("#newContinentID").val()] = []
        $("#max_continent_id").text(max_continent_id)
        $("#continent_count").text(continent_count)
    })

    $("#newNationForm").on("submit", function(e) {
        e.preventDefault()
        var usa = findUSA()
        if ($("#newNationUSA").val() == 1) {
            if (!confirm(nations_by_id[usa]+" is already defined as the USA.\n\nAre you sure you want to change it to "+$("#newNationName").val()+"?")) {
                return false
            } else {
                var oldUSA = findNationFromScratch(usa)
                console.log(oldUSA)
                oldUSA.data.this_is_the_usa = 0
                oldUSA.icon = './images/flag-solid.svg'
                oldUSA.renderTitle()
            }
        }
        nations_by_id[$("#newNationID").val()] = $("#newNationName").val()
        nation_count++;
        var nation_obj = {}
        nation_obj.type = 'nation'
        nation_obj.folder = true
        nation_obj.icon = ($("#newNationUSA").val() == 1) ? './images/flag-usa-solid.svg' : './images/flag-solid.svg'
        nation_obj.id = $("#newNationID").val()
        nation_obj.title = $("#newNationName").val()
        nation_obj.title_korean = $("#newNationNameK").val()
        nation_obj.short_korean = $("#newNationShortK").val()
        nation_obj.pop = $("#newNationPopulation").val()
        nation_obj.etid = $("#newNationEtid").val()
        /* nation_obj.lid = $("#newNationLid").val() */
        nation_obj.capid = '0'
        nation_obj.gender = $("#newNationGender").val()
        nation_obj.bbqual = $("#newNationBbqual").val()
        nation_obj.abbr = $("#newNationAbbr").val()
        nation_obj.abbr_korean = $("#newNationAbbrK").val()
        nation_obj.dem = $("#newNationDem").val()
        nation_obj.dem_korean = $("#newNationDemK").val()
        nation_obj.time_zone = $("#newNationTimeZone").val()
        nation_obj.observes_dst = $("#newNationDST").val()
        nation_obj.this_is_the_usa = $("#newNationUSA").val()
        nation_obj.use_hardcoded_ml_player_origins = $("#newNationHardcoded").val()
        var states_obj = {}
        states_obj.title = "States"
        states_obj.folder = true
        states_obj.icon = './images/landmark-dome-solid.svg'
        states_obj.type = "STATES_PARENT"
        states_obj.children = ([])
        var second_nations_obj = {}
        second_nations_obj.title = "Second Nations"
        second_nations_obj.folder = false
        second_nations_obj.icon = './images/circle-plus-solid.svg'
        second_nations_obj.type = 'second_nations'
        second_nations_obj.subdata = []
        var nation_eth_obj = {}
        nation_eth_obj.title = "Ethnicities"
        nation_eth_obj.folder = false
        nation_eth_obj.icon = './images/user-group-solid.svg'
        nation_eth_obj.type = 'nation_ethnicity'
        nation_eth_obj.subdata = []
        nation_obj.children = [second_nations_obj, nation_eth_obj, states_obj]
        //nation_obj.children = [states_obj]
        if (parseInt($("#newNationID").val()) > max_nation_id) { max_nation_id = parseInt($("#newNationID").val()) }
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        var world = tree.findFirst("CONTINENT")
        var continent = world.findFirst($("#newNationContinent option:selected" ).text())
        continent.addChildren(nation_obj)
        world.sortChildren(null, true);
        var newNodes = continent.findAll($("#newNationName").val())
        for (node of newNodes) {
            if (node.title == $("#newNationName").val()) {
                tree.activateKey(false)
                node.setFocus()
                node.setActive()
                node.makeVisible({scrollIntoView: true});
                node.setExpanded()
                break;
            }
        }
        cities_by_nation[$("#newNationID").val()] = []
        states_by_nation[$("#newNationID").val()] = []
        nations_by_continent[$("#newNationContinent").val()].push(nation_obj)
        $("#max_nation_id").text(max_nation_id)
        $("#nation_count").text(nation_count)
        $("#usa_defined_count").text(countUSA())
    })

    function countUSA() {
        var count = 0
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        var world = tree.findFirst("CONTINENTS")
        for (continent of world.getChildren()) {
            for (nation of continent.getChildren()) {
                if (nation.data.this_is_the_usa == 1) {
                    count++
                }
            }
        }
        return count
    }

    function findUSA() {
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        var world = tree.findFirst("CONTINENTS")
        for (continent of world.getChildren()) {
            if (continent.getChildren() != null) {
                for (nation of continent.getChildren()) {
                    if (nation.data.this_is_the_usa == 1) {
                        return nation.data.id
                    }
                }
            } else {

            }
        }
        return null;
    }

    $("#newStateForm").on("submit", function(e) {
        e.preventDefault()
        states_by_id[$("#newStateId").val()] = $("#newStateName").val()
        state_count++;
        var state_obj = {}
        state_obj.type = 'state'
        state_obj.folder = true
        state_obj.icon = './images/landmark-flag-solid.svg'
        state_obj.id = $("#newStateId").val()
        state_obj.title = $("#newStateName").val()
        state_obj.title_korean = $("#newStateNameK").val()
        state_obj.pop = $("#newStatePopulation").val()
        state_obj.abbr = $("#newStateAbbr").val()
        state_obj.abbr_korean = $("#newStateAbbrK").val()
        state_obj.time_zone = $("#newStateTimeZone").val()
        state_obj.observes_dst = $("#newStateDST").val()
        state_obj.lat = $("#newStateLatitude").val().trim()
        state_obj.long = $("#newStateLongitude").val().trim()
        if (parseInt($("#newStateId").val()) > max_state_id) { max_state_id = parseInt($("#newStateId").val()) }
        $("#max_state_id").text(max_state_id)
        $("#state_count").text(state_count)
        var nation = findNation($("#newStateContinent option:selected").text(), $("#newStateNation option:selected").text())
        var states = nation.findFirst("States")
        states.addChildren(state_obj)
        states.sortChildren(null, true)
        var node = states.findFirst($("#newStateName").val())
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        tree.activateKey(false)
        node.setFocus()
        node.setActive()
        node.makeVisible({scrollIntoView: true});
        states_by_nation[$("#newStateNation").val()].push(state_obj)
        cities_by_state[$("#newStateId").val()] = []
    })

    $("#newCityForm").on("submit", function(e) {
        e.preventDefault()
        var nation = findNation($("#newCityContinent option:selected").text(), $("#newCityNation option:selected").text())
        var state = findState($("#newCityContinent option:selected").text(), $("#newCityNation option:selected").text(), $("#newCityState option:selected").text())
        var obj = {}
        obj.name = $("#newCityName").val()
        obj.state = $("#newCityState").val()
        obj.nation = $("#newCityNation").val()
        obj.continent = $("#newCityContinent").val()
        cities_by_id[$("#newCityId").val()] = obj
        city_count++;
        var city_obj = {}
        var city_bn_obj = {}
        city_obj.type = 'city'
        city_obj.folder = false
        city_obj.icon = './images/city-solid.svg'
        city_obj.id = $("#newCityId").val()
        city_obj.title = $("#newCityName").val()
        city_obj.title_korean = $("#newCityNameK").val()
        city_obj.pop = $("#newCityPopulation").val()
        city_obj.lat = $("#newCityLatitude").val()
        city_obj.long = $("#newCityLongitude").val()
        city_obj.abbr = $("#newCityAbbr").val()
        city_obj.altitude = $("#newCityAltitude").val()
        city_obj.abbr_korean = $("#newCityAbbrK").val()
        city_obj.time_zone = $("#newCityTimeZone").val()
        city_obj.observes_dst = $("#newCityDST").val()
        city_obj.state = $("#newCityState").val()
        city_obj.nation = $("#newCityNation").val()
        city_bn_obj.id = $("#newCityId").val()
        city_bn_obj.title = $("#newCityName").val()
        city_bn_obj.state = $("#newCityState").val()
        city_bn_obj.nation = $("#newCityNation").val()
        if (parseInt($("#newCityId").val()) > max_city_id) { max_city_id = parseInt($("#newCityId").val()) }
        $("#max_city_id").text(max_city_id)
        $("#city_count").text(city_count)
        state.addChildren(city_obj)
        state.sortChildren(null, true)
        var node = state.findFirst($("#newCityName").val())
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        tree.activateKey(false)
        node.setFocus()
        node.setActive()
        node.makeVisible({scrollIntoView: true});
        cities_by_state[$("#newCityState").val()].push(city_obj)
        cities_by_nation[$("#newCityNation").val()].push(city_bn_obj)
        if ($("#newCityCapitol").val() == 1) {
            nation.data.capid = $("#newCityId").val()
            resetCaptiol(nation)
        }
    })

    $("#editEthnicityForm").on("submit", function(e) {
        e.preventDefault()
        nodeToEdit.setTitle($("#editEthnicityName").val())    
        nodeToEdit.data.name_korean = $("#editEthnicityNameK").val()
        nodeToEdit.data.african = $("#editEthnicityAfrican").val()
        nodeToEdit.data.asian = $("#editEthnicityAsian").val()
        nodeToEdit.data.east_indian = $("#editEthnicityEastIndian").val()
        nodeToEdit.data.caucasian = $("#editEthnicityCaucasian").val()
        nodeToEdit.data.hispanic = $("#editEthnicityHispanic").val()
        scrollToEditedNode("ETHNICITIES")
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        tree.activateKey(false)
        nodeToEdit.setFocus()
        nodeToEdit.setActive()
    })

    $("#editContinentForm").on("submit", function(e) {
        e.preventDefault()
        nodeToEdit.setTitle($("#editContinentName").val())
        nodeToEdit.data.abbr = $("#editContinentAbbr").val()
        nodeToEdit.data.abbr_korean = $("#editContinentAbbrK").val()
        nodeToEdit.data.dem = $("#editContinentDem").val()
        nodeToEdit.data.dem_korean = $("#editContinentDemK").val()
        nodeToEdit.data.etid = $("#editContinentEtid").val()
        nodeToEdit.data.pop = $("#editContinentPop").val()
        nodeToEdit.data.title_korean = $("#editContinentNameK").val()
        scrollToEditedNode("CONTINENTS")
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        tree.activateKey(false)
        nodeToEdit.setFocus()
        nodeToEdit.setActive()
    })

    $("#editNationForm").on("submit", function(e) {
        e.preventDefault()
        var usa = findUSA()
        if ($("#editNationUSA").val() == 1) {
            if (!confirm(nations_by_id[usa]+" is already defined as the USA.\n\nAre you sure you want to change it to "+$("#editNationName").val()+"?")) {
                return false
            } else {
                var oldUSA = findNationFromScratch(usa)
                if (oldUSA != undefined) {
                    console.log(oldUSA)
                    oldUSA.data.this_is_the_usa = 0
                    oldUSA.icon = './images/flag-solid.svg'
                    oldUSA.renderTitle()
                }
            }
        }
        nodeToEdit.setTitle($("#editNationName").val())
        nodeToEdit.icon = ($("#editNationUSA").val() == 1) ? './images/flag-usa-solid.svg' : './images/flag-solid.svg'
        nodeToEdit.data.abbr = $("#editNationAbbr").val()
        nodeToEdit.data.abbr_korean = $("#editNationAbbrK").val()
        nodeToEdit.data.bbqual = $("#editNationBbqual").val()
        nodeToEdit.data.capid = $("#editNationCapitol").val()
        nodeToEdit.data.dem = $("#editNationDem").val()
        nodeToEdit.data.dem_korean = $("#editNationDemK").val()
        nodeToEdit.data.etid = $("#editNationEtid").val()
        nodeToEdit.data.gender = $("#editNationGender").val()
        nodeToEdit.data.observes_dst = $("#editNationDST").val()
        nodeToEdit.data.pop = $("#editNationPop").val()
        nodeToEdit.data.short_korean = $("#editNationShortK").val()
        nodeToEdit.data.this_is_the_usa = $("#editNationUSA").val()
        nodeToEdit.time_zone = $("#editNationTimeZone").val()
        nodeToEdit.data.title_korean = $("#editNationNameK").val()
        nodeToEdit.renderTitle()
        $("#usa_defined_count").text(countUSA())
        scrollToEditedNode("CONTINENTS")
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        tree.activateKey(false)
        nodeToEdit.setFocus()
        nodeToEdit.setActive()
    })

    $("#editStateForm").on("submit", function(e) {
        e.preventDefault()
        nodeToEdit.setTitle($("#editStateName").val())
        nodeToEdit.data.abbr = $("#editStateAbbr").val()
        nodeToEdit.data.abbr_korean = $("#editStateAbbrK").val()
        nodeToEdit.data.lat = $("#editStateLatitude").val()
        nodeToEdit.data.long = $("#editStateLongitude").val()
        nodeToEdit.data.observes_dst = $("#editStateDST").val()
        nodeToEdit.data.pop = $("#editStatePopulation").val()
        nodeToEdit.data.time_zone = $("#editStateTimeZone").val()
        nodeToEdit.data.title_korean = $("#editStateNameK").val()
        scrollToEditedNode("CONTINENTS")
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        tree.activateKey(false)
        nodeToEdit.setFocus()
        nodeToEdit.setActive()
    })

    $("#editCityForm").on("submit", function(e) {
        e.preventDefault()
        nodeToEdit.setTitle($("#editCityName").val())
        nodeToEdit.data.abbr = $("#editCityAbbr").val()
        nodeToEdit.data.abbr_korean = $("#editCityAbbrK").val()
        nodeToEdit.altitude = $("#editCityAltitude").val()
        nodeToEdit.lat = $("#editCityLatitude").val()
        nodeToEdit.long = $("#editCityLongitude").val()
        nodeToEdit.observes_dst = $("#editCityDST").val()
        nodeToEdit.pop = $("#editCityPopulation").val()
        nodeToEdit.time_zone = $("#editCityPopulation").val()
        nodeToEdit.title_korean = $("#editCityNameK").val()
        if ($("#editCityCapitol").val() == "1") {
            nodeToEdit.parent.parent.parent.data.capid = $("#editCityId").val()
            resetCaptiol(nodeToEdit.parent.parent.parent)
        }
        scrollToEditedNode("CONTINENTS")
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        tree.activateKey(false)
        nodeToEdit.setFocus()
        nodeToEdit.setActive()
    })

    function resetCaptiol (nation) {
        nation.visit(function(n){
            if (n.type == "city") {
                if (n.data.id == nation.data.capid) {
                    n.icon = './images/star-solid.svg'
                } else {
                    n.icon = './images/city-solid.svg'
                }
                n.renderTitle()
            }
        });
        // if the nation is the "active" node, update the capitol display span
        var city = cities_by_nation[nation.data.id].find( function( city ){
            return city.id === nation.data.capid;
        } );
        if (city != null) {
            $("#capDisplaySpan").text(city.title+", "+states_by_id[city.state])
            //cap = city.title+",&nbsp;"+states_by_id[city.state]
        }
    }

    $("#moveNationForm").on("submit", function(e) {
        e.preventDefault()
        var oldParent = nodeToEdit.parent
        var newParent = findContinent($("#moveNationToContinent option:selected" ).text())
        nodeToEdit.moveTo(newParent)
        oldParent.setExpanded(false)
        nodeToEdit.setFocus()
        nodeToEdit.setActive()
        scrollToEditedNode("CONTINENTS")
    })

    $("#moveStateForm").on("submit", function(e) {
        e.preventDefault()
        var oldParent = nodeToEdit.parent.parent
        var newParent = findNation($("#moveStateToContinent option:selected" ).text(), $("#moveStateToNation option:selected" ).text())
        console.log(oldParent)
        console.log(newParent)
        nodeToEdit.moveTo(newParent.children[2])
        oldParent.setExpanded(false)
        nodeToEdit.setFocus()
        nodeToEdit.setActive()
        scrollToEditedNode("CONTINENTS")
    })

    $("#moveCityForm").on("submit", function(e) {
        e.preventDefault()
        var oldParent = nodeToEdit.parent
        var newParent = findState($("#moveCityToContinent option:selected" ).text(), $("#moveCityToNation option:selected" ).text(), $("#moveCityToState option:selected" ).text())
        nodeToEdit.moveTo(newParent)
        oldParent.parent.parent.parent.setExpanded(false)
        nodeToEdit.setFocus()
        nodeToEdit.setActive()
        scrollToEditedNode("CONTINENTS")
    })

    $(".resetButton").on("click", function() {
        $($(this).data("trigger")).trigger("click")
    })

    $("#newRegionForm").on("submit", function(e) {
        e.preventDefault()
        regions_by_id[$("#newRegionID").val()] = $("#newRegionName").val()
        var region_obj = {}
        region_obj.type = 'region'
        region_obj.folder = true
        region_obj.icon = "./images/map-location-dot-solid.svg"
        region_obj.id = $("#newRegionID").val()
        region_obj.title = $("#newRegionName").val()
        region_obj.sort_order = max_region_sort_order+1
        region_obj.name_korean = $("#newRegionNameK").val()
        var city_arr = []
        if ($('#multi_d_to_3 option').length > 0) {
            $("#multi_d_to_3 option").each(function() {
                var city_obj ={}
                city_obj.title = this.text
                city_obj.id = this.value
                city_arr.push(city_obj)
            });
        }
        var state_arr = []
        if ($('#multi_d_to_2 option').length > 0) {
            $("#multi_d_to_2 option").each(function() {
                var state_obj ={}
                state_obj.title = this.text
                state_obj.id = this.value
                state_arr.push(state_obj)
            });
        } 
        var nation_arr = []
        if ($('#multi_d_to option').length > 0) {
            $("#multi_d_to option").each(function() {
                var nation_obj ={}
                nation_obj.title = this.text
                nation_obj.id = this.value
                nation_arr.push(nation_obj)
            });
        }
        region_obj.nations = nation_arr
        region_obj.states = state_arr
        region_obj.cities = city_arr
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        var world = tree.findFirst("REGIONS")
        world.addChildren(region_obj)
        world.sortChildren(null, true);
        var region = world.findFirst($("#newRegionName").val())
        world.setExpanded()
        region.setFocus()
        region.setActive()
        region.makeVisible({scrollIntoView: true});
        region_count++;
        $("#max_region_id").text(max_region_id)
        $("#region_count").text(region_count)
        if (parseInt($("#newRegionID").val()) > max_region_id) { max_region_id = parseInt($("#newRegionID").val()) }
        max_region_sort_order++
    })

    $("#about").magnificPopup({
		items: {
			src: '#FAQ',
			type: 'inline'
		}
	});
    
    function rightDivContent(div) {
        $(".rightDiv").each(function() {
            $(this).css("display","none")
        })
        $(div).css("display","inline-block")
    }

    function sortTable(tbody, index, ascending) {
        Array.prototype.slice.call(tbody.children).sort(
            (tr1, tr2) => tr1.children[index].textContent.localeCompare(tr2.children[index].textContent) * (ascending ? 1 : -1)
        ).forEach(tr => tbody.appendChild(tr));
    }

    function findLargestArray(arr1, arr2, arr3) {
        const lengths = [arr1.length, arr2.length, arr3.length];
        const maxIndex = lengths.indexOf(Math.max(...lengths));

        switch (maxIndex) {
            case 0:
            return arr1;
            case 1:
            return arr2;
            case 2:
            return arr3;
            default:
            return null; // In case of all arrays having the same length or invalid input
        }
    }

    const sortByKey = (key) => (a, b) => {
        if (a[key] < b[key]) return -1;
        if (a[key] > b[key]) return 1;
        return 0;
    };

    function formatValue(val) {
        if (val == undefined) {
            return "&nbsp;"
        } else {
            return val.title + " ("+val.id+")"
        }
    }

    function isValidLatitude(input) {
        // Latitude should be in the range of -90 to 90
        return /^-?([0-9]|[1-8][0-9]|90)(\.\d+)?$/.test(input);
    }

    function isValidLongitude(input) {
        // Longitude should be in the range of -180 to 180
        return /^-?([0-9]|[1-9][0-9]|1[0-7][0-9]|180)(\.\d+)?$/.test(input);
    }

    function removeDiacritics(str) {
        return latinize(str)
    }

    function addDiacriticsToOption(option, originalText) {
        var normalizedText = removeDiacritics(originalText);
        var sortedText = option.text.toLowerCase();
        var startIndex = sortedText.indexOf(normalizedText);
        var sortedChars = sortedText.split("");
        var diacriticChars = originalText
            .split("")
            .slice(normalizedText.length)
            .join("");

        sortedChars.splice(startIndex, 0, diacriticChars);

        return sortedChars.join("");
    }

    function sortDropdown(dropdown) {
        $(dropdown).html($(dropdown + ' option').sort(function(x, y) {
            var textX = latinize($(x).text().toLowerCase());
            var textY = latinize($(y).text().toLowerCase());
            return textX < textY ? -1 : 1;
        }));
        $(dropdown+" :nth-child(1)").prop('selected', true);
    }

    function scrollToEditedNode(toSort) {
        var tree = $.ui.fancytree.getTree("#xmlOutput")
        var node_to_sort = tree.findFirst(toSort)
        node_to_sort.sortChildren(null, true);
        node_to_sort.setExpanded()
        nodeToEdit.setFocus()
        nodeToEdit.setActive()
        nodeToEdit.makeVisible({scrollIntoView: true});
    }

    function clearRightDiv() {
        $("#infoPanel").html("")
        rightDivContent("#infoPanel")
    }

    function getAltitudeEstimate(x) {
        let valuesArray = [0, 500, 1000, 1500, 2000, 2500, 3000]
        let closestValue = valuesArray[0]; // Initialize with the first value in the array
        let minDifference = Math.abs(x - valuesArray[0]); // Initialize with the difference between x and the first value

        for (let i = 1; i < valuesArray.length; i++) {
            const difference = Math.abs(x - valuesArray[i]);
            
            if (difference < minDifference) {
            minDifference = difference;
            closestValue = valuesArray[i];
            }
        }

        switch (closestValue) {
            case 0:
                return 0;
                break;
            case 500:
                return 1;
                break;
            case 1000:
                return 2;
                break;
            case 1500:
                return 3;
                break;
            case 2000:
                return 4;
                break;
            case 2500:
                return 5;
                break;
            case 3000:
                return 6;
                break;
            default:
                return 0;
                break;
        }
    }

    function getElevationDataSync(lat, lon) {
        const url = "https://api.open-elevation.com/api/v1/lookup?locations="+lat+","+lon

        const request = new XMLHttpRequest();
        request.open('GET', url, false); // Passing `false` for synchronous

        request.send();

        if (request.status === 200) {
            const data = JSON.parse(request.responseText);
            if (data.results && data.results.length > 0) {
                return data.results[0].elevation;
            } else {
                console.log("no elevation data available")
                return 0
            }
        } else {
            console.log(`Request failed with status ${request.status}`)
            return 0
        }
    }
    
    </script>
</html>