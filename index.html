<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
    <title>OOTP World Editor</title>
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
	<script type="text/javascript" src="./scripts/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="./scripts/jquery.fancytree-all-deps.min.js"></script>
    <script type="text/javascript" src="./scripts/jquery.magnific-popup.min.js"></script>
    <script type="text/javascript" src="./scripts/jquery.validate.min.js"></script>
    <script type="text/javascript" src="./scripts/additional-methods.min.js"></script>
    <script type="text/javascript" src="./scripts/vkbeautify.0.99.00.beta.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/translate@2/index.min.js"></script>
    <link href="./scripts/worldeditor.css" rel="stylesheet">
    <link href="./scripts/skin-win8-n/ui.fancytree.min.css" rel="stylesheet">
    <link href='./scripts/magnific-popup.css' rel='stylesheet' type='text/css'>
    <link href="./scripts/jquery.contextMenu.css" rel="stylesheet" type='text/css'/>
    <script type="text/javascript" src="./scripts/jquery.contextMenu.js"></script>
    <script type="text/javascript" src="./scripts/jquery.fancytree.contextMenu.js"></script>


    <script>
        const { ipcRenderer } = require('electron');
        const { translate } = require('bing-translate-api');
        const XMLWriter = require('xml-writer');
        var max_world_id = 0
        var max_continent_id = 0
        var max_nation_id = 0
        var max_state_id = 0
        var max_city_id = 0
        var max_ethnicity_id = 0
        var max_region_id = 0
        var world_count = 0
        var continent_count = 0
        var nation_count = 0
        var state_count = 0
        var city_count = 0
        var ethnicity_count = 0
        var region_count = 0
        var ethnicities_by_id = {}
        var cities_by_id = {}
        var states_by_id = {}
        var nations_by_id = {}
        var continents_by_id = {}
        var regions_by_id = {}
        var nations_by_continent = {}
        var states_by_nation = {}
        const time_zones = [{ tz: "-12.00", loc: "(GMT-12:00) International Date Line West" }, { tz: "-11.00", loc: "(GMT-11:00) Midway Island, Samoa" }, { tz: "-10.00", loc: "(GMT-10:00) Hawaii" }, { tz: "-9.00", loc: "(GMT-09:00) Alaska" }, { tz: "-8.00", loc: "(GMT-08:00) Pacific Time (US &amp; Canada)" }, { tz: "-8.00", loc: "(GMT-08:00) Tijuana, Baja California" }, { tz: "-7.00", loc: "(GMT-07:00) Arizona" }, { tz: "-7.00", loc: "(GMT-07:00) Chihuahua, La Paz, Mazatlan" }, { tz: "-7.00", loc: "(GMT-07:00) Mountain Time (US &amp; Canada)" }, { tz: "-6.00", loc: "(GMT-06:00) Central America" }, { tz: "-6.00", loc: "(GMT-06:00) Central Time (US &amp; Canada)" }, { tz: "-6.00", loc: "(GMT-06:00) Guadalajara, Mexico City, Monterrey" }, { tz: "-6.00", loc: "(GMT-06:00) Saskatchewan" }, { tz: "-5.00", loc: "(GMT-05:00) Bogota, Lima, Quito, Rio Branco" }, { tz: "-5.00", loc: "(GMT-05:00) Eastern Time (US &amp; Canada)" }, { tz: "-5.00", loc: "(GMT-05:00) Indiana (East)" }, { tz: "-4.00", loc: "(GMT-04:00) Atlantic Time (Canada)" }, { tz: "-4.00", loc: "(GMT-04:00) Caracas, La Paz" }, { tz: "-4.00", loc: "(GMT-04:00) Manaus" }, { tz: "-4.00", loc: "(GMT-04:00) Santiago" }, { tz: "-3.50", loc: "(GMT-03:30) Newfoundland" }, { tz: "-3.00", loc: "(GMT-03:00) Brasilia" }, { tz: "-3.00", loc: "(GMT-03:00) Buenos Aires, Georgetown" }, { tz: "-3.00", loc: "(GMT-03:00) Greenland" }, { tz: "-3.00", loc: "(GMT-03:00) Montevideo" }, { tz: "-2.00", loc: "(GMT-02:00) Mid-Atlantic" }, { tz: "-1.00", loc: "(GMT-01:00) Cape Verde Is." }, { tz: "-1.00", loc: "(GMT-01:00) Azores" }, { tz: "0.00", loc: "(GMT+00:00) Casablanca, Monrovia, Reykjavik" }, { tz: "0.00", loc: "(GMT+00:00) Greenwich Mean Time - Dublin, Edinburgh, Lisbon, London" }, { tz: "1.00", loc: "(GMT+01:00) Amsterdam, Berlin, Bern, Rome, Stockholm, Vienna" }, { tz: "1.00", loc: "(GMT+01:00) Belgrade, Bratislava, Budapest, Ljubljana, Prague" }, { tz: "1.00", loc: "(GMT+01:00) Brussels, Copenhagen, Madrid, Paris" }, { tz: "1.00", loc: "(GMT+01:00) Sarajevo, Skopje, Warsaw, Zagreb" }, { tz: "1.00", loc: "(GMT+01:00) West Central Africa" }, { tz: "2.00", loc: "(GMT+02:00) Amman" }, { tz: "2.00", loc: "(GMT+02:00) Athens, Bucharest, Istanbul" }, { tz: "2.00", loc: "(GMT+02:00) Beirut" }, { tz: "2.00", loc: "(GMT+02:00) Cairo" }, { tz: "2.00", loc: "(GMT+02:00) Harare, Pretoria" }, { tz: "2.00", loc: "(GMT+02:00) Helsinki, Kyiv, Riga, Sofia, Tallinn, Vilnius" }, { tz: "2.00", loc: "(GMT+02:00) Jerusalem" }, { tz: "2.00", loc: "(GMT+02:00) Minsk" }, { tz: "2.00", loc: "(GMT+02:00) Windhoek" }, { tz: "3.00", loc: "(GMT+03:00) Kuwait, Riyadh, Baghdad" }, { tz: "3.00", loc: "(GMT+03:00) Moscow, St. Petersburg, Volgograd" }, { tz: "3.00", loc: "(GMT+03:00) Nairobi" }, { tz: "3.00", loc: "(GMT+03:00) Tbilisi" }, { tz: "3.50", loc: "(GMT+03:30) Tehran" }, { tz: "4.00", loc: "(GMT+04:00) Abu Dhabi, Muscat" }, { tz: "4.00", loc: "(GMT+04:00) Baku" }, { tz: "4.00", loc: "(GMT+04:00) Yerevan" }, { tz: "4.50", loc: "(GMT+04:30) Kabul" }, { tz: "5.00", loc: "(GMT+05:00) Yekaterinburg" }, { tz: "5.00", loc: "(GMT+05:00) Islamabad, Karachi, Tashkent" }, { tz: "5.50", loc: "(GMT+05:30) Sri Jayawardenapura" }, { tz: "5.50", loc: "(GMT+05:30) Chennai, Kolkata, Mumbai, New Delhi" }, { tz: "5.75", loc: "(GMT+05:45) Kathmandu" }, { tz: "6.00", loc: "(GMT+06:00) Almaty, Novosibirsk" }, { tz: "6.00", loc: "(GMT+06:00) Astana, Dhaka" }, { tz: "6.50", loc: "(GMT+06:30) Yangon (Rangoon)" }, { tz: "7.00", loc: "(GMT+07:00) Bangkok, Hanoi, Jakarta" }, { tz: "7.00", loc: "(GMT+07:00) Krasnoyarsk" }, { tz: "8.00", loc: "(GMT+08:00) Beijing, Chongqing, Hong Kong, Urumqi" }, { tz: "8.00", loc: "(GMT+08:00) Kuala Lumpur, Singapore" }, { tz: "8.00", loc: "(GMT+08:00) Irkutsk, Ulaan Bataar" }, { tz: "8.00", loc: "(GMT+08:00) Perth" }, { tz: "8.00", loc: "(GMT+08:00) Taipei" }, { tz: "9.00", loc: "(GMT+09:00) Osaka, Sapporo, Tokyo" }, { tz: "9.00", loc: "(GMT+09:00) Seoul" }, { tz: "9.00", loc: "(GMT+09:00) Yakutsk" }, { tz: "9.50", loc: "(GMT+09:30) Adelaide" }, { tz: "9.50", loc: "(GMT+09:30) Darwin" }, { tz: "10.00", loc: "(GMT+10:00) Brisbane" }, { tz: "10.00", loc: "(GMT+10:00) Canberra, Melbourne, Sydney" }, { tz: "10.00", loc: "(GMT+10:00) Hobart" }, { tz: "10.00", loc: "(GMT+10:00) Guam, Port Moresby" }, { tz: "10.00", loc: "(GMT+10:00) Vladivostok" }, { tz: "11.00", loc: "(GMT+11:00) Magadan, Solomon Is., New Caledonia" }, { tz: "12.00", loc: "(GMT+12:00) Auckland, Wellington" }, { tz: "12.00", loc: "(GMT+12:00) Fiji, Kamchatka, Marshall Is." }]
    </script>
    <style>
        
    </style>
</head>
<body>
    <div id="overlay">
        <div class="loader"></div>
    </div>
    <div class="section group" style="position: absolute; top: 10px; width:100%;" >
        <div class="col span_1_of_2">
            <div id="xmlOutput" style="max-height: 840px; overflow: auto;"></div>
        </div>
        <div class="col span_1_of_2">
            <div id="dataTable"></div>
        </div>
    </div>
    <div class="section group" style="position: absolute; bottom: 20px; width:100%;">
        <table style="width:90%; margin: 0 auto; font-size:0.7em;">
            <tr>
                <td>CONTINENTS: <span id="continent_count">0</span></td>
                <td>NATIONS: <span id="nation_count">0</span></td>
                <td>STATES: <span id="state_count">0</span></td>
                <td>CITIES: <span id="city_count">0</span></td>
                <td>ETHNICITIES: <span id="ethnicity_count">0</span></td>
                <td>REGIONS: <span id="region_count">0</span></td>
            </tr>
            <tr>
                <td>MAX_CONTINENT_ID: <span id="max_continent_id">0</span></td>
                <td>MAX_NATION_ID: <span id="max_nation_id">0</span></td>
                <td>MAX_STATE_ID: <span id="max_state_id">0</span></td>
                <td>MAX_CITY_ID: <span id="max_city_id">0</span></td>
                <td>MAX_ETHNICITY_ID: <span id="max_ethnicity_id">0</span></td>
                <td>MAX_REGION_ID: <span id="max_region_id">0</span></td>
            </tr>
        </table>    
    </div>
    <div id="addEthnicity" class="jm-white-popup mfp-hide">
        <form id="newEthnicity">
            <table>
                <tr>
                    <td>ID:</td>
                    <td><input type='text' id='newEthnicityID' class="centerText" readonly></td>
                </tr>
                <tr>
                    <td>Name:</td>
                    <td><input type='text' id='newEthnicityName' class="centerText toKorean"></td>
                </tr>
                <tr>
                    <td>Name (Korean):</td>
                    <td><input type='text' id='newEthnicityNameK' class="centerText"></td>
                </tr>
                <tr>
                    <td>African:</td>
                    <td><input type='number' class='newEthPct' min='0' max='1000' id='newEthnicityAfrican' value="0"></td>
                </tr>
                <tr>
                    <td>Asian:</td>
                    <td><input type='number' class='newEthPct' min='0' max='1000' id='newEthnicityAsian' value="0"></td>
                </tr>
                <tr>
                    <td>East Indian:</td>
                    <td><input type='number' class='newEthPct' min='0' max='1000' id='newEthnicityEastIndian' value="0"></td>
                </tr>
                <tr>
                    <td>Caucasian:</td>
                    <td><input type='number' class='newEthPct' min='0' max='1000' id='newEthnicityCaucasian' value="0"></td>
                </tr>
                <tr>
                    <td>Hispanic:</td>
                    <td><input type='number' class='newEthPct' min='0' max='1000' d='newEthnicityHispanic' value="0"></td>
                </tr>
                <tr>
                    <td>Total:</td>
                    <td id="newEthnicityTotal" style="text-align:center;"></td>
                </tr>
            </table>
            <input type="button" value="Submit">
        </form>
	</div>
    <div id="addContinent" class="jm-white-popup mfp-hide">
        <h2 style="text-align:center;">Add Continent</h2>
        <form id="newContinentForm" action="">
            <table style="width: 80%; margin:0 auto;">
                <tr>
                    <td class="left">ID:</td>
                    <td class="right"><input style="display:none;" type='text' name='newContinentID' id='newContinentID' class="centerText">7</td>
                </tr>
                <tr>
                    <td class="left">Name:</td>
                    <td class="left"><input style="width:95%;" type="text" class="centerText toKorean" name="newContinentName" id="newContinentName" required></td>
                </tr>
                <tr>
                    <td class="left">Abbreviation:</td>
                    <td class="left"><input style="width:95%;" type="text" class="centerText toKorean" name="newContinentAbbr" id="newContinentAbbr" required></td>
                </tr>
                <tr>
                    <td class="left">Demonym:</td>
                    <td class="left"><input style="width:95%;" type="text" class="centerText toKorean" name="newContinentDem" id="newContinentDem" required></td>
                </tr>
                <tr>
                    <td class="left">Population:</td>
                    <td class="left"><input style="width:95%;" type="number" class="centerText" name="newContinentPop" id="newContinentPop" value="0"></td>
                </tr>
                <tr>
                    <td class="left">ETID:</td>
                    <td class="left"><input style="width:95%;" type="number" class="centerText" name="newContinentEtid" id="newContinentEtid" value="0"></td>
                </tr>
                <tr>
                    <td class="left">Name (Korean):</td>
                    <td class="left"><input style="width:95%;" type="text" class="centerText" name="newContinentNameK" id="newContinentNameK" value=""></td>
                </tr>
                <tr>
                    <td class="left">Abbreviation (Korean):</td>
                    <td class="left"><input style="width:95%;" type="text" class="centerText" name="newContinentAbbrK" id="newContinentAbbrK" value=""></td>
                </tr>
                <tr>
                    <td class="left">Demonym (Korean):</td>
                    <td class="left"><input style="width:95%;" type="text" class="centerText" name="newContinentDemK" id="newContinentDemK" value=""></td>
                </tr>
            </table>
            <br>
            <div style="text-align:center;">
                <input type="submit" id="newContinentSubmit" value="Add Continent">
            </div>
        </form>
        
	</div>
    <div id="addNation" class="jm-white-popup mfp-hide">
        <h2 style="text-align:center;">Add Nation</h2>
		<form id="newNationForm">
            <table style="width:95%; margin:0 auto;">
                <tr>
                    <td class="left" style="width:25%;">ID:</td>
                    <td class="right" style="width:25%;"><input type='text' id='newNationID' class="centerText" readonly></td>
                    <td class="left" style="width:25%;">Continent:</td>
                    <td class="right" style="width:25%;">
                        <select style="width:95%;" id="newNationContinent">
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="left">Name:</td>
                    <td class="right"><input type="text" class="centerText toKorean" id="newNationName" value="" required></td>
                    <td class="left">Abbreviation:</td>
                    <td class="right"><input type="text" class="centerText toKorean" id="newNationAbbr" value="" required></td>
                </tr>
                <tr>
                    <td class="left">Demonym:</td>
                    <td class="right"><input type="text" class="centerText toKorean" id="newNationDem" value="" required></td>
                    <td class="left">Population:</td>
                    <td class="right"><input type="number" id="newNationPopulation" value="0"></td>
                </tr>
                <tr>
                    <td class="left">ETID:</td>
                    <td class="right"><input type="number" id="newNationEtid" value="0"></td>
                    <td class="left">LID:</td>
                    <td class="right"><input type="number" id="newNationLid" value="0"></td>
                </tr>
                <tr>
                    <td class="left">Gender:</td>
                    <td class="right">
                        <select id="newNationGender" style="width:99%;">
                            <option value="0">0: Male</option>
                            <option value="1">1: Female</option>
                        </select>
                    </td>
                    <td class="left">Baseball Quality:</td>
                    <td class="right">
                        <select id="newNationBbqual" style="width:99%;">
                            <option value="5">5: Excellent</option>
                            <option value="4">4: Good</option>
                            <option value="3" selected>3: Average</option>
                            <option value="2">2: Fair</option>
                            <option value="1">1: Poor</option>
                            <option value="0">0: Non-Existent</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="left">Observes DST:</td>
                    <td class="right">
                        <select id="newNationDST" style="width:99%;">
                            <option value="0">0: No</option>
                            <option value="1">1: Yes</option>
                        </select>
                    </td>
                    <td class="left">Modern USA?</td>
                    <td class="right">
                        <select id="newNationUSA" style="width:99%;">
                            <option value="0">0: No</option>
                            <option value="1">1: Yes</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="left">Name (Korean):</td>
                    <td class="right"><input type="text" class="centerText" id="newNationNameK" value=""></td>
                    <td class="left">Short (Korean):</td>
                    <td class="right"><input type="text" class="centerText" id="newNationShortK" value=""></td>
                </tr>
                <tr>
                    <td class="left">Abbr. (Korean):</td>
                    <td class="right"><input type="text" class="centerText" id="newNationAbbrK" value=""></td>
                    <td class="left">Demonym (Korean):</td>
                    <td class="right"><input type="text" class="centerText" id="newNationDemK" value=""></td>
                </tr>
                <tr>
                    <td class="left">Time Zone:</td>
                    <td  class="right" colspan="3">
                        <select class="tzSelect" id="newNationTimeZone" style="width:100%;">
                        </select>
                    </td>
                </tr>
            </table>
            <br>
            <div style="text-align:center;">
                <input type="submit" id="newNationSubmit" value="Add Nation">
            </div>
        </form>   
	</div>
    <div id="addState" class="jm-white-popup mfp-hide">
		<table>
            <tr>
                <td>ID:</td>
                <td><input type='text' id='newStateId' class="centerText" readonly></td>
            </tr>
            <tr>
                <td>Continent:</td>
                <td>
                    <select id="newStateContinent">
                    </select>
                </td>
            </tr>
            <tr>
                <td>Nation:</td>
                <td>
                    <select id="newStateNation">
                    </select>
                </td>
            </tr>
            <tr>
                <td>Name:</td>
                <td><input type="text" class="centerText toKorean" id="newStateName" value=""></td>
            </tr>
            <tr>
                <td>Abbreviation:</td>
                <td><input type="text" class="centerText toKorean" id="newStateAbbr" value=""></td>
            </tr>
            <tr>
                <td>Population:</td>
                <td><input type="number" id="newStatePopulation" value="0"></td>
            </tr>
            <tr>
                <td>Time Zone:</td>
                <td><select class="tzSelect" id="newStateTimeZone" style="width:100%;"></select></td>
            </tr>
            <tr>
                <td>Observes DST:</td>
                <td>
                    <select id="newStateDST" style="width:100%;">
                        <option value="0">0: No</option>
                        <option value="1">1: Yes</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>Latitude:</td>
                <td><input type="text" id="newStateLatitude" value="0"></td>
            </tr>
            <tr>
                <td>Longitude:</td>
                <td><input type="text" id="newStateLongitude" value="0"></td>
            </tr>
            <tr>
                <td>Name (Korean):</td>
                <td><input type="text" id="newStateNameK" value="0"></td>
            </tr>
            <tr>
                <td>Abbreviation (Korean):</td>
                <td><input type="text" id="newStateAbbrK" value="0"></td>
            </tr>
        </table>
	</div>
    <div id="addCity" class="jm-white-popup mfp-hide">
		<table>
            <tr>
                <td>ID:</td>
                <td><input type='text' id='newCityId' class="centerText" readonly></td>
            </tr>
            <tr>
                <td>Continent:</td>
                <td>
                    <select id="newCityContinent">
                    </select>
                </td>
            </tr>
            <tr>
                <td>Nation:</td>
                <td>
                    <select id="newCityNation">
                    </select>
                </td>
            </tr>
            <tr>
                <td>State:</td>
                <td>
                    <select id="newCityState">
                    </select>
                </td>
            </tr>
            <tr>
                <td>Name:</td>
                <td><input type="text" class="centerText toKorean" id="newCityName" value=""></td>
            </tr>
            <tr>
                <td>Abbreviation:</td>
                <td><input type="text" class="centerText toKorean" id="newCityAbbr" value=""></td>
            </tr>
            <tr>
                <td>Population:</td>
                <td><input type="number" id="newCityPopulation" value="0"></td>
            </tr>
            <tr>
                <td>Time Zone:</td>
                <td><select class="tzSelect" id="newCityTimeZone" style="width:100%;"></select></td>
            </tr>
            <tr>
                <td>Observes DST:</td>
                <td>
                    <select id="newCityDST" style="width:100%;">
                        <option value="0">0: No</option>
                        <option value="1">1: Yes</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>Latitude:</td>
                <td><input type="text" id="newCityLatitude" value="0"></td>
            </tr>
            <tr>
                <td>Longitude:</td>
                <td><input type="text" id="newCityLongitude" value="0"></td>
            </tr>
            <tr>
                <td>Altitude:</td>
                <td>
                    <select id='newCityAltitude' style='width:100%;'> 
                        <option value='0'>0: ~0 m</option>
                        <option value='1'>1: ~500 m</option>
                        <option value='2'>2: ~1000 m</option>
                        <option value='3'>3: ~1500 m</option>
                        <option value='4'>4: ~2000 m</option>
                        <option value='5'>5: ~2500 m</option>
                        <option value='6'>6: ~3000 m</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>Name (Korean):</td>
                <td><input type="text" id="newCityNameK" value="0"></td>
            </tr>
            <tr>
                <td>Abbreviation (Korean):</td>
                <td><input type="text" id="newCityAbbrK" value="0"></td>
            </tr>
        </table>
	</div>
    <div id="addRegion" class="jm-white-popup mfp-hide">
		<table>
            <tr>
                <td>ID:</td>
                <td><input type='text' name='newRegionID' id='newRegionID' class="centerText" readonly></td>
            </tr>
            <tr>
                <td>Name:</td>
                <td><input type="text" class="centerText toKorean" name="newRegionName" id="newRegionName" required></td>
            </tr>
            <tr>
                <td>Name (Korean):</td>
                <td><input type="text" class="centerText" name="newRegionNameK" id="newRegionNameK" required></td>
            </tr>
            <tr>
                <td>Region Type:</td>
                <td>
                    <select id="newRegionType">
                        <option value="nations">Nations</option>
                        <option value="states">States</option>
                    </select>
                </td>
            </tr>
        </table>    
	</div>
    <input type="button" id="loadXML" value="Load XML file" style="display: none;">
    <input type="button" id="saveXML" value="Save XML file" style="display: none;">
    <input type="button" id="closeXML" value="Close XML file" style="display: none;">
    <input type="button" class="button" id="addEthnicityTrigger" value="Add Ethnicity" style="display:none;">
    <input type="button" class="button" id="addContinentTrigger" value="Add Continent" style="display:none;">
    <input type="button" class="button" id="addNationTrigger" value="Add Nation" style="display:none;">
    <input type="button" class="button" id="addStateTrigger" value="Add State" style="display:none;">
    <input type="button" class="button" id="addCityTrigger" value="Add City" style="display:none;">
    <input type="button" class="button" id="addRegionTrigger" value="Add Region" style="display:none;">
<script>
    require('./renderer.js')

    var fancyTreeReady = false;
    var treeGlobal = "hello world"

    $(document).ready(function() {
        ipcRenderer.send('debug-load', null)
        for (z of time_zones) {
            $('#newNationTimeZone')
                .append($('<option>', { value : z.tz })
                .text(z.loc));
            $('#newStateTimeZone')
                .append($('<option>', { value : z.tz })
                .text(z.loc));
            $('#newCityTimeZone')
                .append($('<option>', { value : z.tz })
                .text(z.loc));
        }
        $(".tzSelect").each(function() {
            $(this).children(':nth-child(30)').prop('selected', true);
        })
        ipcRenderer.send('menu-reset', null)
    })

    $("#loadXML").on("click",function(e) {
        $("#overlay").css("display","inline-block")
        ipcRenderer.send('open-xml', null)
    })

    $("#closeXML").on("click", function() {
        if (confirm("Are you sure?")) {
            window.location.reload()
        } 
    })

    $("#saveXML").on("click",function(e) {
        $("#overlay").css("display","inline-block")

        const tree = $.ui.fancytree.getTree("#xmlOutput")

        const commentStr = "\nOOTP loads this file whenever the user creates a new game. You can edit this file as long as you watch the syntax. Please read the online manual section about customizing the world XML file.\n"
                         + "NATION tokens:\n"
                         + "use_hardcoded_ml_player_origins - either 1 (=yes) or 0 (=no). If missing, the value will be set to 0. By default it's 1 for the USA nation record in the XML file. Just disable it (set it to 0) or delete it and OOTP will not use the hard coded player distribution for that nation anymore.\n"
                         + "this_is_modern_usa - either 1 (=yes) or 0 (=no). If missing, the value will be set to 0. By default it's 1 for the USA nation record in the XML file. There should always be at least one nation with this flag enabled because OOTP needs it as the nation for pre-defined leagues, like NL or AL.\n"
                         + "\r\n"
                         + "When OOTP creates fictional players for modern US major leagues, it will need to find the following nations by name: Dominican Republic, Venezuela, Puerto Rico, Mexico, Canada, Cuba, Japan, Panama, Australia, South Korea, Germany, Aruba, England, The Netherlands, Italy, Spain, Taiwan. So you should not change the names for these nations if you want to simulate realistic major leagues!\n"

        xw = new XMLWriter()
        xw.startDocument('1.0', 'UTF-8')
        xw.writeComment(commentStr)
        xw.startElement('WORLD')
            .writeAttribute("id","1")
            .writeAttribute("name", "default")
            .writeAttribute("version", "3")
            .writeAttribute("timestamp", "OOTP Developments 2023-04-24 13:59:02")

            xw.startElement("ETHNICITIES")
            
            var ethnicities = tree.findFirst("ETHNICITIES")
            var eth = ethnicities.toDict(true)
            for (e of eth.children) {
                xw.startElement("ETHNICITY")
                .writeAttribute("id", e.data.id)
                .writeAttribute("name", e.title)
                .writeAttribute("name_korean", e.data.name_korean)
                .writeAttribute("aftrican", e.data.african)
                .writeAttribute("asian", e.data.asian)
                .writeAttribute("east_indian", e.data.east_indian)
                .writeAttribute("caucasian", e.data.caucasian)
                .writeAttribute("hispanic", e.data.hispanic)
                .endElement()
            }
            
            xw.endElement()

            xw.startElement("CONTINENTS")
            var continent = tree.findFirst("CONTINENT")
            var cont = continent.toDict(true)
            for (c of cont.children) {
                xw.startElement("CONTINENT")
                .writeAttribute("id", c.data.id)
                .writeAttribute("name", c.title)
                .writeAttribute("pop", c.data.pop)
                .writeAttribute("etid", c.data.etid)
                .writeAttribute("abbr", c.data.abbr)
                .writeAttribute("dem", c.data.dem)
                .writeAttribute("abbr_korean", c.data.abbr_korean)
                .writeAttribute("dem_korean", c.data.dem_korean)
                nationsEl = xw.startElement("NATIONS")
                for(n of c.children){
                    xw.startElement("NATION")
                    .writeAttribute("id", n.data.id)
                    .writeAttribute("name", n.title)
                    .writeAttribute("name_korean", n.data.name_korean)
                    .writeAttribute("short_korean", n.data.short_korean)
                    .writeAttribute("pop", n.data.pop)
                    .writeAttribute("etid", n.data.etid)
                    .writeAttribute("capid", n.data.capid)
                    .writeAttribute("gender", n.data.gender)
                    .writeAttribute("bbqual", n.data.bbqual)
                    .writeAttribute("abbr", n.data.abbr)
                    .writeAttribute("abbr_korean", n.data.abbr_korean)
                    .writeAttribute("dem", n.data.dem)
                    .writeAttribute("dem_korean", n.data.dem_korean)
                    .writeAttribute("time_zone", n.data.time_zone)
                    if (n.children[0].data != undefined) {
                        xw.startElement("SECOND_NATIONS")
                        for (sn of n.children[0].data.subdata) {
                            xw.startElement("SECOND_NATION")
                            .writeAttribute("id", sn.id)
                            .writeAttribute("pct", sn.pct) 
                            .writeAttribute("use_name", sn.use_name)
                            .endElement()
                        }
                        xw.endElement()
                    }
                    if (n.children[1].data != undefined) {
                        xw.startElement("ETHN_PCTS")
                        for (e of n.children[1].data.subdata) {
                            xw.startElement("ETHN_PCT")
                            .writeAttribute("name", e.name)
                            .writeAttribute("etid", e.etid) 
                            .writeAttribute("pct", sn.pct)
                            .endElement()
                        }
                        xw.endElement()
                    }
                    xw.startElement("STATES")
                    for (s of n.children[2].children) {
                        xw.startElement("STATE")
                        .writeAttribute("id", s.data.id)
                        .writeAttribute("name", s.title)
                        .writeAttribute("name_korean", s.data.name_korean)
                        .writeAttribute("pop", s.data.pop)
                        .writeAttribute("abbr", s.data.abbr)
                        .writeAttribute("abbr_korean", s.data.abbr_korean)
                        .writeAttribute("time_zone", s.data.time_zone)
                        .writeAttribute("observes_dst", s.data.observes_dst)
                        .writeAttribute("lat",s.data.lat)
                        .writeAttribute("long", s.data.long)
                        if (s.children != undefined) {
                            xw.startElement("CITIES")
                            for (ci of s.children) {
                                xw.startElement("CITY")
                                .writeAttribute("id", ci.data.id)
                                .writeAttribute("name", ci.title)
                                .writeAttribute("name_korean", ci.data.name_korean)
                                .writeAttribute("pop", ci.data.pop)
                                .writeAttribute("time_zone", ci.data.time_zone)
                                .writeAttribute("observes_dst", ci.data.observes_dst)
                                .writeAttribute("lat", ci.data.lat)
                                .writeAttribute("long", ci.data.long)
                                .writeAttribute("abbr", ci.data.abbr)
                                .writeAttribute("abbr_korean", ci.data.abbr_korean)
                                .endElement()
                            } 
                            xw.endElement()                  
                        }
                        xw.endElement()
                    }
                    xw.endElement()
                    xw.startElement("CAPITAL")
                        .writeAttribute("id",n.data.capid)
                        .endElement()
                xw.endElement()
                }
            
            xw.endElement() 
        xw.endElement()
        }

        
        xw.endElement()

        xw.startElement("REGIONS")
        
        var regions = tree.findFirst("REGIONS")
        var reg = regions.toDict(true)
        for (r of reg.children) {
            xw.startElement("REGION")
            .writeAttribute("id", r.data.id)
            .writeAttribute("sort_order", r.data.sort_order)
            .writeAttribute("name", r.title)
            .writeAttribute("name_korean", r.data.title_korean)
            //console.log(r.title)
            if (r.children[0].children != undefined) {
                xw.startElement("REGION_STATES")
                for (st of r.children[0].children) {
                    xw.startElement("REGION_STATE")
                      .writeAttribute("id", st.data.id)
                    .endElement()
                }
                xw.endElement()
            }
            if (r.children[1].children != undefined) {
                xw.startElement("REGION_NATIONS")
                for (st of r.children[1].children) {
                    xw.startElement("REGION_NATION")
                      .writeAttribute("id", st.data.id)
                    .endElement()
                }
                xw.endElement()
            }
            xw.endElement()
        }

        xw.endElement()

        var tmpXML = vkbeautify.xml(xw.toString())
        tmpXML = tmpXML.replaceAll("SECOND_NATION id","SECOND_NATIONS id")
        tmpXML = tmpXML.replace("<!--","\n<!--")
        tmpXML = tmpXML.replace("-->","-->\n")

        ipcRenderer.send('save_xml',Buffer.from(tmpXML))
    })

    ipcRenderer.on('save_xml_result', (event, data) => {
        if (data.status != "success") {
            alert(data.message)
        }
        $("#overlay").css("display","none")
    })

    ipcRenderer.on('xml-opened', (event, result) => {
        if (result != 'cancelled') {
            // reset everything
            if (fancyTreeReady) {
                $("#xmlOutput").fancytree("destroy");
            }
            $("#dataTable").html("")
            max_world_id = 0
            max_continent_id = 0
            max_nation_id = 0
            max_state_id = 0
            max_city_id = 0
            max_ethnicity_id = 0
            max_region_id = 0
            world_count = 0
            continent_count = 0
            nation_count = 0
            state_count = 0
            city_count = 0
            ethnicity_count = 0
            region_count = 0

            $("#continent_count").text(continent_count)
            $("#nation_count").text(nation_count)
            $("#state_count").text(state_count)
            $("#city_count").text(city_count)
            $("#ethnicity_count").text(ethnicity_count)
            $("#region_count").text(region_count)
            $("#max_continent_id").text(max_continent_id)
            $("#max_nation_id").text(max_nation_id)
            $("#max_state_id").text(max_state_id)
            $("#max_city_id").text(max_city_id)
            $("#max_ethnicity_id").text(max_ethnicity_id)
            $("#max_region_id").text(max_region_id)

            // start parsing the new data
            var json = JSON.parse(result)
            var tree_json = [];

            var ethnicities_arr = {}
            var ethnicities = []
            ethnicities_arr.title = "ETHNICITIES";
            ethnicities_arr.folder = true
            ethnicities_arr.type = "ETHNICITIES_PARENT"
            ethnicities_arr.icon = './images/people-group-solid.svg'
            for (ethnicity of json.WORLD.ETHNICITIES[0].ETHNICITY) {
                ethnicities_by_id[ethnicity.$.id] = ethnicity.$.name
                ethnicity_count++;
                var ethnicity_obj = {}
                ethnicity_obj.type = 'ethnicity'
                ethnicity_obj.folder = false
                ethnicity_obj.icon = './images/user-group-solid.svg'
                ethnicity_obj.title = ethnicity.$.name
                ethnicity_obj.name_korean = ethnicity.$.name_korean
                ethnicity_obj.id = ethnicity.$.id
                ethnicity_obj.african = ethnicity.$.african
                ethnicity_obj.asian = ethnicity.$.asian
                ethnicity_obj.east_indian = ethnicity.$.east_indian
                ethnicity_obj.caucasian = ethnicity.$.caucasian
                ethnicity_obj.hispanic = ethnicity.$.hispanic
                ethnicities.push(ethnicity_obj)
                if (parseInt(ethnicity.$.id) > max_ethnicity_id) { max_ethnicity_id = parseInt(ethnicity.$.id) }
            }
            ethnicities_arr.children = ethnicities
            tree_json.push(ethnicities_arr)
            
            var continent_arr = {};
            continent_arr.title = "CONTINENTS";
            continent_arr.folder = true;
            continent_arr.icon = './images/globe-solid.svg'
            continent_arr.type = "CONTINENTS_PARENT"
            var continents = []
            for (continent of json.WORLD.CONTINENTS[0].CONTINENT) {
                continents_by_id[continent.$.id] = continent.$.name
                continent_count++;
                var continent_obj = {}
                continent_obj.type = 'continent'
                continent_obj.folder = true
                continent_obj.icon = './images/earth-americas-solid.svg'
                continent_obj.id = continent.$.id
                continent_obj.title = continent.$.name
                continent_obj.title_korean = (continent.$.name_korean != undefined) ? continent.$.name_korean : ""
                continent_obj.pop = (continent.$.population != undefined) ? continent.$.population : continent.$.pop
                continent_obj.etid = (continent.$.etid != undefined) ? continent.$.etid : ""
                continent_obj.abbr = continent.$.abbr
                continent_obj.dem = continent.$.dem
                continent_obj.abbr_korean = (continent.$.abbr_korean != undefined) ? continent.$.abbr_korean : ""
                continent_obj.dem_korean = (continent.$.dem_korean != undefined) ? continent.$.dem_korean : ""
                if (parseInt(continent.$.id) > max_continent_id) { max_continent_id = parseInt(continent.$.id) }
                var nation_arr = []     
                for (nation of continent.NATIONS[0].NATION) {
                    const usa = (nation.$.hasOwnProperty('this_is_the_usa')) ? nation.$.this_is_the_usa : nation.$.this_is_modern_usa
                    nations_by_id[nation.$.id] = nation.$.name
                    nation_count++;
                    var nation_obj = {}
                    nation_obj.type = 'nation'
                    nation_obj.folder = true
                    nation_obj.icon = './images/flag-solid.svg'
                    nation_obj.id = nation.$.id
                    nation_obj.title = nation.$.name
                    nation_obj.title_korean = (nation.$.name_korean != undefined) ? nation.$.name_korean : ""
                    nation_obj.short_korean = (nation.$.short_korean != undefined) ? nation.$.short_korean : ""
                    nation_obj.pop = nation.$.pop
                    nation_obj.etid = (nation.$.etid != undefined) ? nation.$.etid : ""
                    nation_obj.lid = nation.$.lid = (nation.$.lid != undefined) ? nation.$.lid : ""
                    nation_obj.capid = (nation.$.capid != undefined) ? nation.$.capid : ""
                    nation_obj.gender = nation.$.gender
                    nation_obj.bbqual = nation.$.bbqual
                    nation_obj.abbr = nation.$.abbr
                    nation_obj.abbr_korean = (nation.$.abbr_korean != undefined) ? nation.$.abbr_korean : ""
                    nation_obj.dem = nation.$.dem
                    nation_obj.dem_korean = (nation.$.dem_korean != undefined) ? nation.$.dem_korean : ""
                    nation_obj.time_zone = parseFloat(nation.$.time_zone).toFixed(2).toString()
                    nation_obj.observes_dst = (nation.$.observes_dst != undefined) ? nation.$.observes_dst : ""
                    nation_obj.this_is_the_usa = (usa != undefined) ? '1' : "0"
                    if (parseInt(nation.$.id) > max_nation_id) { max_nation_id = parseInt(nation.$.id) }
                    var second_nations_obj = {}
                    second_nations_obj.title = "Second Nations"
                    second_nations_obj.folder = false
                    second_nations_obj.icon = './images/circle-plus-solid.svg'
                    second_nations_obj.type = 'second_nations'
                    var second_nations_arr = []
                    if (nation.SECOND_NATIONS != undefined) {
                        for (sn of nation.SECOND_NATIONS[0].SECOND_NATIONS) {
                            var sn_obj = {}
                            sn_obj.name = nations_by_id[sn.$.id]
                            sn_obj.id = sn.$.id
                            sn_obj.pct = sn.$.pct
                            sn_obj.use_name = sn.$.use_name
                            second_nations_arr.push(sn_obj)
                        }
                        second_nations_obj.subdata = (second_nations_arr)
                    }
                    var nation_eth_obj = {}
                    nation_eth_obj.title = "Ethnicities"
                    nation_eth_obj.folder = false
                    nation_eth_obj.icon = './images/user-group-solid.svg'
                    nation_eth_obj.type = 'nation_ethnicity'
                    var nation_eth_arr = []
                    if (nation.ETHN_PCTS != undefined) {
                        for (n_eth of nation.ETHN_PCTS[0].ETHN_PCT) {
                            var eth_obj = {}
                            eth_obj.name = ethnicities_by_id[n_eth.$.etid]
                            eth_obj.etid = n_eth.$.etid
                            eth_obj.pct = n_eth.$.pct
                            nation_eth_arr.push(eth_obj)
                        }
                        nation_eth_obj.subdata = (nation_eth_arr)
                    }
                    var states_obj = {}
                    states_obj.title = "States"
                    states_obj.folder = true
                    states_obj.icon = './images/landmark-dome-solid.svg'
                    states_obj.type = "STATES_PARENT"
                    var state_arr = []
                    for (state of nation.STATES[0].STATE) {
                        states_by_id[state.$.id] = state.$.name
                        state_count++;
                        var state_obj = {}
                        state_obj.type = 'state'
                        state_obj.folder = true
                        state_obj.icon = './images/landmark-flag-solid.svg'
                        state_obj.id = state.$.id
                        state_obj.title = state.$.name
                        state_obj.title_korean = (state.$.name_korean != undefined) ? state.$.name_korean : ""
                        state_obj.pop = state.$.pop
                        state_obj.abbr = state.$.abbr
                        state_obj.abbr_korean = (state.$.abbr_korean != undefined) ? state.$.abbr_korean : ""
                        state_obj.time_zone = (state.$.time_zone != undefined) ? parseFloat(state.$.time_zone).toFixed(2).toString() : parseFloat(nation.$.time_zone).toFixed(2).toString()
                        state_obj.observes_dst = (state.$.observes_dst != undefined) ? state.$.observes_dst : "0"
                        state_obj.lat = (state.$.lat != undefined) ? state.$.lat : "0"
                        state_obj.long = (state.$.long != undefined) ? state.$.long : "0"
                        if (parseInt(state.$.id) > max_state_id) { max_state_id = parseInt(state.$.id) }
                        var city_arr = []
                        if (state.CITIES[0].CITY != undefined) {
                            for (city of state.CITIES[0].CITY) {
                                cities_by_id[city.$.id] = city.$.name
                                city_count++;
                                var city_obj = {}
                                city_obj.type = 'city'
                                city_obj.folder = false
                                city_obj.icon = './images/city-solid.svg'
                                city_obj.id = city.$.id
                                city_obj.title = city.$.name
                                city_obj.title_korean = (city.$.name_korean != undefined) ? city.$.name_korean : ""
                                city_obj.pop = city.$.pop
                                city_obj.lat = (city.$.lat != undefined) ? city.$.lat : "0"
                                city_obj.long = (city.$.long != undefined) ? city.$.long : "0"
                                city_obj.abbr = city.$.abbr
                                city_obj.altitude = (city.$.altitude != undefined) ? city.$.altitude : "0"
                                city_obj.abbr_korean = (city.$.abbr_korean != undefined) ? city.$.abbr_korean : ""
                                city_obj.time_zone = (city.$.time_zone != undefined) ? parseFloat(city.$.time_zone).toFixed(2).toString() : parseFloat(nation.$.time_zone).toFixed(2).toString()
                                city_obj.observes_dst = (city.$.observes_dst != undefined) ? city.$.observes_dst : "0"
                                city_arr.push(city_obj)
                                if (parseInt(city.$.id) > max_city_id) { max_city_id = parseInt(city.$.id) }
                            }
                        }
                        state_obj.children = city_arr
                        state_arr.push(state_obj)
                    }
                    states_obj.children = (state_arr)
                    nation_obj.children = [second_nations_obj, nation_eth_obj, states_obj]
                    nation_arr.push(nation_obj)
                    states_by_nation[nation.$.id] = state_arr
                }
                nations_by_continent[continent.$.id] = nation_arr
                continent_obj.children = nation_arr
                continents.push(continent_obj)
            }
            continent_arr.children = continents
            tree_json.push(continent_arr)

            var regions_arr = {}
            regions_arr.title = "REGIONS"
            regions_arr.folder = true
            regions_arr.icon = './images/map-solid.svg'
            regions_arr.type = "REGIONS_PARENT"
            var regions = []
            
            for (region of json.WORLD.REGIONS[0].REGION) {
                regions_by_id[region.$.id] = region.$.name
                region_count++;
                var region_obj = {}
                region_obj.type = 'region'
                region_obj.folder = true
                region_obj.icon = "./images/map-location-dot-solid.svg"
                region_obj.id = region.$.id
                region_obj.title = region.$.name
                region_obj.sort_order = region.$.sort_order
                region_obj.name_korean = region.$.name_korean
                var states = {}
                var nations = {}
                var state_arr = []
                var nation_arr = []
                states.folder = true
                states.title = "STATES"
                states.icon = './images/landmark-dome-solid.svg'
                nations.folder = true
                nations.title = "NATIONS"
                nations.icon = './images/earth-americas-solid.svg'
                try {
                    for (state of region.REGION_STATES[0].REGION_STATE) {
                        var state_obj = {}
                        state_obj.title = states_by_id[state.$.id] + " ("+state.$.id+")"
                        state_obj.icon = './images/landmark-flag-solid.svg'
                        state_obj.id = state.$.id
                        state_arr.push(state_obj)
                    }
                } catch (err) {
                }
                try {
                    for (nation of region.REGION_NATIONS[0].REGION_NATION) {
                        var nation_obj = {}
                        nation_obj.title = nations_by_id[nation.$.id] + " ("+nation.$.id+")"
                        nation_obj.icon = './images/flag-solid.svg'
                        nation_obj.id = nation.$.id
                        nation_arr.push(nation_obj)
                    }
                } catch (err) {
                }
                states.children = state_arr
                nations.children = nation_arr
                region_obj.children = [states, nations]
                regions.push(region_obj)
                if (parseInt(region.$.id) > max_region_id) { max_region_id = parseInt(region.$.id) }
            }
            regions_arr.children = regions
            tree_json.push(regions_arr)

            $("#xmlOutput").fancytree({
                extensions: [],
                source: tree_json,
                init: function(event, data){
                    fancyTreeReady = true
                },
                activate: function(event, data){
                    $("#dataTable").html("")
                    var node = data.node;
                    var html = ""
                    switch (node.type) {
                        case "ethnicity":
                            const eth_total = parseInt(node.data.african) + parseInt(node.data.asian) + parseInt(node.data.east_indian) + parseInt(node.data.caucasian) + parseInt(node.data.hispanic)
                            html += "<form id='ethnicityForm'>\n"
                                  + "<table id='ethnicityTable'>\n"
                                  + "<tr><td>ID:</td><td>"+node.data.id+"</td></tr>\n"
                                  + "<tr><td>Name:</td><td><input type='text' id='name' style='width:100%;' value='"+node.title+"'></td></tr>\n"
                                  + "<tr><td>Name (Korean):</td><td><input type='text' id='name_korean' style='width:100%;' value='"+node.data.name_korean+"'></td></tr>\n"
                                  + "<tr><td>African:</td><td><input type='number' min='0' max='1000' id='african' style='width:100%;' value='"+node.data.african+"'></td></tr>\n"
                                  + "<tr><td>Asian:</td><td><input type='number' min='0' max='1000' id='asian' style='width:100%;' value='"+node.data.asian+"'></td></tr>\n"
                                  + "<tr><td>East Indian:</td><td><input type='number' min='0' max='1000' id='east_indian' style='width:100%;' value='"+node.data.east_indian+"'></td></tr>\n"
                                  + "<tr><td>Caucasian:</td><td><input type='number' min='0' max='1000' id='caucasian' style='width:100%;' value='"+node.data.caucasian+"'></td></tr>\n"
                                  + "<tr><td>Hispanic:</td><td><input type='number' min='0' max='1000' id='hispanic' style='width:100%;' value='"+node.data.hispanic+"'></td></tr>\n"
                                  + "<tr><td>Total:</td><td>"+eth_total+"</td></tr>\n"
                                  + "</table>\n"
                                  + "<input type='submit' value='Submit'>\n"
                                  + "</form>"
                            $("#dataTable").html(html)
                            break;
                        case "continent":
                            html += "<form id='continentForm'>\n"
                                  + "<table id='continentTable'>\n"
                                  + "<tr><td>ID:</td><td>"+node.data.id+"</td></tr>\n"
                                  + "<tr><td>Name:</td><td><input type='text' id='name' value='"+node.title+"'></td></tr>\n"
                                  + "<tr><td>Abbreviation:</td><td><input type='text' id='abbr' value='"+node.data.abbr+"'></td></tr>\n"
                                  + "<tr><td>Demonym:</td><td><input type='text' id='dem' value='"+node.data.dem+"'></td></tr>\n"
                                  + "<tr><td>Population:</td><td><input type='number' id='pop' value='"+node.data.pop+"'></td></tr>\n"
                                  + "<tr><td>ETID:</td><td><input type='number' id='etid' value='"+node.data.etid+"'></td></tr>\n"
                                  + "<tr><td>Name (Korean):</td><td><input type='text' id='name_korean' value='"+node.data.title_korean+"'></td></tr>\n"
                                  + "<tr><td>Abbreviation (Korean):</td><td><input type='text' id='abbr_korean' value='"+node.data.abbr_korean+"'></td></tr>\n"
                                  + "<tr><td>Demonym (Korean):</td><td><input type='text' id='dem_korean' value='"+node.data.dem_korean+"'></td></tr>\n"
                                  + "</table>\n"
                                  + "<input type='submit' value='Submit'>\n"
                                  + "</form>"
                            $("#dataTable").html(html)
                            break;
                        case "nation":
                            html += "<form id='nationForm'>\n"
                                + "<table id='nationTable'>\n"
                                + "<tr><td>ID:</td><td>"+node.data.id+"</td></tr>\n"
                                + "<tr><td>Name:</td><td><input type='text' id='name' value='"+node.title+"'></td></tr>\n"
                                + "<tr><td>Abbreviation:</td><td><input type='text' id='abbr' value='"+node.data.abbr+"'></td></tr>\n"
                                + "<tr><td>Demonym:</td><td><input type='text' id='dem' value='"+node.data.dem+"'></td></tr>\n"
                                + "<tr><td>Population:</td><td><input type='number' id='pop' value='"+node.data.pop+"'></td></tr>\n"
                                + "<tr><td>ETID:</td><td><input type='text' id='etid' value='"+node.data.etid+"'></td></tr>\n"
                                + "<tr><td>LID:</td><td><input type='text' id='lid' value='"+node.data.lid+"'></td></tr>\n"
                                + "<tr><td>Gender:</td><td><select id='gender' style='width:100%;'>\n"
                                + "<option value='0'>0: Male</option>\n"
                                + "<option value='1'>1: Female</option></select></td></tr>\n"
                                + "<tr><td>Baseball Quality:</td><td><select id='bbqual' style='width:100%;'>\n"
                                + "<option value='5'>5: Excellent</option>\n"
                                + "<option value='4'>4: Good</option>\n"
                                + "<option value='3'>3: Average</option>\n"
                                + "<option value='2'>2: Fair</option>\n"
                                + "<option value='1'>1: Poor</option>\n"
                                + "<option value='0'>0: Non-Existent</option></select></td></tr>\n"
                                + "<tr><td>Time Zone:</td><td><select id='time_zone' style='width:100%;'>\n"     
                                + "</select></td></tr>\n"    
                                + "<tr><td>Observes DST:</td><td><select id='observes_dst' style='width:100%;'>\n"
                                + "<option value='0'>0: No</option>\n"
                                + "<option value='1'>1: Yes</option></select></td></tr>\n"
                                + "<tr><td>Modern USA?</td><td><select id='this_is_the_usa' style='width:100%;'>\n"
                                + "<option value='0'>0: No</option>\n"
                                + "<option value='1'>1: Yes</option></select></td></tr>\n"
                                + "<tr><td>Name (Korean):</td><td><input type='text' id='name_korean' value='"+node.data.title_korean+"'></td></tr>\n"
                                + "<tr><td>Short (Korean):</td><td><input type='text' id='name_korean' value='"+node.data.short_korean+"'></td></tr>\n"
                                + "<tr><td>Abbreviation (Korean):</td><td><input type='text' id='abbr_korean' value='"+node.data.abbr_korean+"'></td></tr>\n"
                                + "<tr><td>Demonym (Korean):</td><td><input type='text' id='dem_korean' value='"+node.data.dem_korean+"'></td></tr>\n"
                                + "</table>\n"
                                + "<input type='submit' value='Submit'>\n"
                                + "</form>"
                            $("#dataTable").html(html)
                            $("#bbqual").val(node.data.bbqual)
                            $("#gender").val(node.data.gender)
                            $("#observes_dst").val(node.data.observes_dst)
                            $("#this_is_the_usa").val(node.data.this_is_the_usa)
                            for (z of time_zones) {
                                $('#time_zone')
                                    .append($('<option>', { value : z.tz })
                                    .text(z.loc));
                            }
                            $("#time_zone").val(node.data.time_zone)
                            break;
                        case "state":
                            html += "<form id='cityForm'>\n"
                                + "<table id='cityTable'>\n"
                                + "<tr><td>ID:</td><td>"+node.data.id+"</td></tr>\n"
                                + "<tr><td>Name:</td><td><input type='text' id='name' value='"+node.title+"'></td></tr>\n"
                                + "<tr><td>Abbreviation:</td><td><input type='text' id='abbr' value='"+node.data.abbr+"'></td></tr>\n"
                                + "<tr><td>Population:</td><td><input type='text' id='abbr' value='"+node.data.pop+"'></td></tr>\n"
                                + "<tr><td>Time Zone:</td><td><select id='time_zone' style='width:100%;'>\n"
                                + "</option></select></td></tr>\n"
                                + "<tr><td>Observes DST:</td><td><select id='observes_dst' style='width:100%;'>\n"
                                + "<option value='0'>0: No</option>\n"
                                + "<option value='1'>1: Yes</option></select></td></tr>\n"
                                + "<tr><td>Latitude:</td><td><input type='text' id='abbr' value='"+node.data.lat+"'></td></tr>\n"
                                + "<tr><td>Longitude:</td><td><input type='text' id='abbr' value='"+node.data.long+"'></td></tr>\n"
                                + "<tr><td>Name (Korean):</td><td><input type='text' id='name_korean' value='"+node.data.title_korean+"'></td></tr>\n"
                                + "<tr><td>Abbreviation (Korean):</td><td><input type='text' id='abbr_korean' value='"+node.data.abbr_korean+"'></td></tr></table>\n"
                            $("#dataTable").html(html)
                            $("#observes_dst").val(node.data.observes_dst)
                            for (z of time_zones) {
                                $('#time_zone')
                                    .append($('<option>', { value : z.tz })
                                    .text(z.loc));
                            }
                            $("#time_zone").val(node.data.time_zone)
                            break;
                        case "city":
                            html += "<form id='cityForm'>\n"
                                + "<table id='cityTable'>\n"
                                + "<tr><td>ID:</td><td>"+node.data.id+"</td></tr>\n"
                                + "<tr><td>Name:</td><td><input type='text' id='name' value='"+node.title+"'></td></tr>\n"
                                + "<tr><td>Abbreviation:</td><td><input type='text' id='abbr' value='"+node.data.abbr+"'></td></tr>\n"
                                + "<tr><td>Population:</td><td><input type='text' id='abbr' value='"+node.data.pop+"'></td></tr>\n"
                                + "<tr><td>Time Zone:</td><td><select id='time_zone' style='width:100%;'>\n"
                                + "</select></td></tr>\n"
                                + "<tr><td>Observes DST:</td><td><select id='observes_dst' style='width:100%;'>\n"
                                + "<option value='0'>0: No</option>\n"
                                + "<option value='1'>1: Yes</option></select></td></tr>\n"
                                + "<tr><td>Latitude:</td><td><input type='text' id='abbr' value='"+node.data.lat+"'></td></tr>\n"
                                + "<tr><td>Longitude:</td><td><input type='text' id='abbr' value='"+node.data.long+"'></td></tr>\n"
                                + "<tr><td>Altitude:</td><td><select id='altitude' style='width:100%;'>\n"
                                + "<option value='0'>0: ~0 m</option>\n"
                                + "<option value='1'>1: ~500 m</option>\n"
                                + "<option value='2'>2: ~1000 m</option>\n"
                                + "<option value='3'>3: ~1500 m</option>\n"
                                + "<option value='4'>4: ~2000 m</option>\n"
                                + "<option value='5'>5: ~2500 m</option>\n"
                                + "<option value='6'>6: ~3000 m</option></select></td></tr>\n"
                                + "<tr><td>Name (Korean):</td><td><input type='text' id='name_korean' value='"+node.data.title_korean+"'></td></tr>\n"
                                + "<tr><td>Abbreviation (Korean):</td><td><input type='text' id='abbr_korean' value='"+node.data.abbr_korean+"'></td></tr></table>\n"
                            $("#dataTable").html(html)
                            $("#observes_dst").val(node.data.observes_dst)
                            for (z of time_zones) {
                                $('#time_zone')
                                    .append($('<option>', { value : z.tz })
                                    .text(z.loc));
                            }
                            $("#time_zone").val(node.data.time_zone)
                            $("#altitude").val(node.data.altitude)
                            break;
                        case "second_nations":
                            html += "<form id='secondNationsForm'>\n"
                                + "<table id='secondNationsTable'>\n"
                                + "<thead>\n<tr><td>ID</td><td>Name</td><td>PCT</td><td>Use Name?</td></tr>\n</thead>\n"
                                + "<tbody>\n"
                             if (node.data.subdata != undefined) {
                                for (e of node.data.subdata) {
                                    console.log(e)
                                    var selected_no = (e.use_name == "0") ? " selected" : ""
                                    var selected_yes = (e.use_name == "1") ? " selected" : ""
                                    html += "<tr><td>"+e.id+"</td><td>"+nations_by_id[e.id]+"</td><td>"+e.pct+"</td>"
                                    + "<td><select>\n"
                                    + "<option value-'0'"+selected_no+">No</option>\n"
                                    + "<option value-'1'"+selected_yes+">Yes</option>\n"
                                    + "</select></td></tr>\n"
                                }
                            }
                            html += "</tbody></table>"
                            $("#dataTable").html(html)  
                            break;
                        case "nation_ethnicity":
                            html += "<form id='nEthnicityForm'>\n"
                                + "<table id='nEthnicityTable'>\n"
                                + "<thead>\n<tr><td>ID</td><td>Ethnicity</td><td>PCT</td></tr>\n</thead>\n"
                                + "<tbody>\n"
                            if (node.data.subdata != undefined) {
                                for (e of node.data.subdata) {
                                    html += "<tr><td>"+e.etid+"</td><td>"+e.name+"</td><td>"+e.pct+"</td></tr>\n"
                                }
                            }
                            html += "</tbody></table>"
                            $("#dataTable").html(html)    
                            break;
                        default:
                            html += node.title + " - " + node.type + "<br>";
                    }
                    
                }
            })

            var cmItems = {}

            $.contextMenu({
                selector: "#xmlOutput span.fancytree-title",
                build: function($trigger, e) {
                    var node = $.ui.fancytree.getNode($trigger);
                    switch (node.type) {
                        case "ETHNICITIES_PARENT":
                            cmItems = {
                                "add": {name: "Add Ethnicity", icon: 'add'}
                            }
                            break;  
                        case "CONTINENTS_PARENT":
                            cmItems = {
                                "add": {name: "Add Continent", icon: 'add'}
                            }
                            break;  
                        case "REGIONS_PARENT":
                            cmItems = {
                                "add": {name: "Add Region", icon: 'add'}
                            }
                            break;
                        case "continent":
                            cmItems = {
                                "add": {name: "Add Nation", icon: 'add'},
                                "sep1": "----",
                                "delete": {name: "Delete \""+node.title +"\"", icon: 'delete'},
                            }
                            break;
                        case "nation":
                            cmItems = {
                                "addState": {name: "Add State", icon: 'add'},
                                "addSecondNation": {name: "Add Second Nation", icon: 'add'},
                                "addEthnicity": {name: "Add Ethnicity", icon: 'add'},
                                "sep1": "----",
                                "delete": {name: "Delete \""+node.title +"\"", icon: 'delete'},
                            }
                            break;
                        case "STATES_PARENT":
                            cmItems = {
                                "add": {name: "Add State", icon: 'add'},
                            }
                            break;
                        case "state":
                            cmItems = {
                                "add": {name: "Add City", icon: 'add'},
                                "sep1": "----",
                                "delete": {name: "Delete \""+node.title +"\"", icon: 'delete'},
                            }
                            break;
                        case "city":
                            cmItems = { 
                                "delete": {name: "Delete \""+node.title +"\"", icon: 'delete'},
                            }
                            break;
                        default: 
                            cmItems = {}
                            break;
                    }
                    return {
                        callback: function(key, options) {
                            var m = "clicked: "+key
                            switch (node.type) {
                                case "ETHNICITIES_PARENT":
                                    $("#addEthnicityTrigger").click()
                                    break;  
                                case "CONTINENTS_PARENT":
                                    if (key == "add") { $("#addContinentTrigger").click() }
                                    break;  
                                case "REGIONS_PARENT":
                                    $("#addRegionTrigger").click()
                                    break;
                                case "continent":
                                    addNation(node.data.id)
                                    break;
                                case "nation":
                                    switch (key) {
                                        case "addState":
                                            addState(node.parent.data.id,node.data.id)
                                            //$("#addStateTrigger").click()
                                            break;
                                        case "addSecondNation":
                                            console.log("add second nation TBD")
                                            break;
                                        case "addEthnicity":
                                            console.log("add ethnicity TBD")
                                            break;
                                        case "delete":
                                            confirm("Are you sure you want to delete "+node.title+"?\n\nThis will delete all states and cities as well!")
                                            break;
                                    }
                                    break;
                                case "STATES_PARENT":
                                    addState(node.parent.parent.data.id,node.parent.data.id)
                                    break;
                                case "state":
                                    switch (key) {
                                        case "add":
                                            //$("#addCityTrigger").click()
                                            addCity(node.parent.parent.parent.data.id, node.parent.parent.data.id, node.data.id)
                                            break;
                                        case "delete":
                                            confirm("Are you sure you want to delete "+node.title+"?\n\nThis will delete all cities as well!")
                                            break;
                                    }
                                    break;
                                case "city":
                                    confirm("Are you sure you want to delete "+node.title+"?")
                                    break;
                                default: 
                                    break;
                            }
                        },
                        items: cmItems
                    }
                }
            });


            $("#continent_count").text(continent_count)
            $("#nation_count").text(nation_count)
            $("#state_count").text(state_count)
            $("#city_count").text(city_count)
            $("#ethnicity_count").text(ethnicity_count)
            $("#region_count").text(region_count)
            $("#max_continent_id").text(max_continent_id)
            $("#max_nation_id").text(max_nation_id)
            $("#max_state_id").text(max_state_id)
            $("#max_city_id").text(max_city_id)
            $("#max_ethnicity_id").text(max_ethnicity_id)
            $("#max_region_id").text(max_region_id)

            var tree = $.ui.fancytree.getTree("#xmlOutput")
            var world = tree.findFirst("CONTINENT")
            world.sortChildren(null, true);

            $("#overlay").css("display","none")
        } else {
            $("#overlay").css("display","none")
            alert("cancelled!")
        }
    });

    $("#addEthnicityTrigger").magnificPopup({
        closeOnBgClick: false,
		items: {
			src: '#addEthnicity',
			type: 'inline'
		},
        callbacks: {
            beforeOpen: function() {
                $("#newEthnicityName").val("")
                $("#newEthnicityNameK").val("")
                $("#newEthnicityID").val(max_ethnicity_id+1)
                $(".newEthPct").each(function(){
                    $(this).val(0);
                });
                $("#newEthnicityTotal").css("color","red")
                $("#newEthnicityTotal").html("0")
            }
        }
	});

    $("#addContinentTrigger").magnificPopup({
        closeOnBgClick: false,
		items: {
			src: '#addContinent',
			type: 'inline'
		},
        callbacks: {
            beforeOpen: function() {
                $("#newContinentName").val("Ruthlandia")
                $("#newContinentNameK").val("")
                $("#newContinentAbbr").val("RTH")
                $("#newContinentAbbrK").val("")
                $("#newContinentDem").val("Ruthlandian")
                $("#newContinentDemK").val("")
                $("#newContinentPopulation").val(0)
                $("#newContinentEtid").val(0)
                $("#newContinentID").val(max_continent_id+1)
            }
        }
	});

    function addNation(continent) {
        $.magnificPopup.open({
            closeOnBgClick: false,
            items: {
                src: '#addNation',
                type: 'inline'
            },
            callbacks: {
                beforeOpen: function() {
                    $("#newNationContinent").empty()
                    $.each(continents_by_id, function(key, value) {
                        $('#newNationContinent')
                            .append($('<option>', { value : key })
                            .text(value));
                    });
                    $("#newNationContinent").html($('#newNationContinent option').sort(function(x, y) {
                        return $(x).text().toLowerCase() < $(y).text().toLowerCase() ? -1 : 1;
                    }))
                    if (continent == null) {
                        $("#newNationContinent :nth-child(1)").prop('selected', true);
                    } else {
                        $("#newNationContinent").val(continent).change();
                    }
                    $("#newNationName").val("")
                    $("#newNationNameK").val("")
                    $("#newNationAbbr").val("")
                    $("#newNationAbbrK").val("")
                    $("#newNationShortK").val("")
                    $("#newNationDem").val("")
                    $("#newNationDemK").val("")
                    $("#newNationPopulation").val(0)
                    $("#newNationEtid").val(0)
                    $("#newNationLid").val(0)
                    $("#newNationID").val(max_nation_id+1)
                    $("#newNationGender :nth-child(1)").prop('selected', true);
                    $("#newNationBbqual :nth-child(3)").prop('selected', true);
                    $("#newNationTimeZone :nth-child(30)").prop('selected', true);
                    $("#newNationDST :nth-child(1)").prop('selected', true);
                    $("#newNationUSA :nth-child(1)").prop('selected', true);

                    $(this).css("height", "800px;")
                }
            }
        });
    }

    function addState(continent,nation) {
        $.magnificPopup.open({
            items: {
                src: '#addState',
                type: 'inline'
            },
            callbacks: {
                beforeOpen: function() {
                    $.each(continents_by_id, function(key, value) {
                        $('#newStateContinent')
                            .append($('<option>', { value : key })
                            .text(value));
                    });
                    if (continent == null) {
                        $("#newStateContinent :nth-child(1)").prop('selected', true);
                    } else {
                        $("#newStateContinent").val(continent);
                    }
                    $("#newStateContinent").trigger("change")
                    if (nation == null) {
                        $("#newStateNation :nth-child(1)").prop('selected', true);
                    } else {
                        $("#newStateNation").val(nation);
                    }
                }
            }
	});
    }

    $("#newStateContinent").on("change", function() { 
        $("#newStateNation").empty()
        for (nation of nations_by_continent[$(this).val()]) {
            $('#newStateNation')
                    .append($('<option>', { value : nation.id })
                    .text(nation.title));
        }
        $("#newStateNation").html($('#newStateNation option').sort(function(x, y) {
            return $(x).text().toLowerCase() < $(y).text().toLowerCase() ? -1 : 1;
        }))
    })

    function addCity(continent, nation, state) {
        console.log(continent)
        console.log(nation)
        console.log(state)
        $.magnificPopup.open({
            items: {
                src: '#addCity',
                type: 'inline'
            },
            callbacks: {
                beforeOpen: function() {
                    $("#newCityContinent").empty()
                    $.each(continents_by_id, function(key, value) {
                        $('#newCityContinent')
                            .append($('<option>', { value : key })
                            .text(value));
                    });
                    $("#newCityContinent").html($('#newCityContinent option').sort(function(x, y) {
                        return $(x).text().toLowerCase() < $(y).text().toLowerCase() ? -1 : 1;
                    }))
                    if (continent == null) { 
                        $("#newCityContinent :nth-child(1)").prop('selected', true);
                    } else {
                        $("#newCityContinent").val(continent);
                    }
                    $("#newCityContinent").trigger("change")
                    if (nation == null) { 
                        $("#newCityNation :nth-child(1)").prop('selected', true);
                    } else {
                        $("#newCityNation").val(nation);
                    }
                    $("#newCityNation").trigger("change")
                    if (state == null) { 
                        $("#newCityState :nth-child(1)").prop('selected', true);
                    } else {
                        $("#newCityState").val(state);
                    }
                    $("#newCityId").val(max_city_id+1)
                }
            }
        });
    }
    
    $("#newCityContinent").on("change", function() { 
        $("#newCityNation").empty()
        for (nation of nations_by_continent[$(this).val()]) {
            $('#newCityNation')
                    .append($('<option>', { value : nation.id })
                    .text(nation.title));
        }
        $("#newCityNation").html($('#newCityNation option').sort(function(x, y) {
            return $(x).text().toLowerCase() < $(y).text().toLowerCase() ? -1 : 1;
        }))
        $("#newCityNation").trigger("change")
    })

    $("#newCityNation").on("change", function() { 
        $("#newCityState").empty()
        for (state of states_by_nation[$(this).val()]) {
            $('#newCityState')
                    .append($('<option>', { value : state.id })
                    .text(state.title));
        }
        $("#newCityState").html($('#newCityState option').sort(function(x, y) {
            return $(x).text().toLowerCase() < $(y).text().toLowerCase() ? -1 : 1;
        }))
    })

    $("#addRegionTrigger").magnificPopup({
		items: {
			src: '#addRegion',
			type: 'inline'
		},
        callbacks: {
            beforeOpen: function() {
                $("#newRegionId").val(max_region_id+1)
            }
        }
	});

    $(".toKorean").on("keyup",function() {
        var id = $(this).attr("id")
        translate($(this).val(), null, 'ko').then(res => {
            $("#"+id+"K").val(res.translation)
        }).catch(err => {
            $("#"+id+"K").val("")
        });
    })

    $("#newEthnicityName").on("keyup", function() {
        translate($(this).val(), null, 'ko').then(res => {
            $("#newEthnicityNameK").val(res.translation)
        }).catch(err => {
            $("#newEthnicityNameK").val("")
        });
    })

    $(".newEthPct").on("change",function() {
        var sum = 0;
        $(".newEthPct").each(function(){
            sum += +$(this).val();
        });
        if (sum !== 1000) {
            $("#newEthnicityTotal").css("color","red")
        } else {
            $("#newEthnicityTotal").css("color","green")
        }
        $("#newEthnicityTotal").html(sum)
    })

    $("#newContinentForm").validate({
        //debug: true,
        errorClass: "invalid",
        submitHandler: function() { 
            continent_count++
            continents_by_id[$("#newContinentID").val()] = $("#newContinentName").val()
            var continent_obj = {}
            continent_obj.type = 'continent'
            continent_obj.folder = true
            continent_obj.icon = './images/earth-americas-solid.svg'
            continent_obj.id = $("#newContinentID").val()
            continent_obj.title = $("#newContinentName").val()
            continent_obj.title_korean = $("#newContinentNameK").val()
            continent_obj.pop = $("#newContinentPop").val()
            continent_obj.etid = $("#newContinentEtid").val()
            continent_obj.abbr = $("#newContinentAbbr").val()
            continent_obj.dem = $("#newContinentDem").val()
            continent_obj.abbr_korean =  $("#newContinentAbbrK").val()
            continent_obj.dem_korean = $("#newContinentDemK").val()
            if (parseInt($("#newContinentID").val()) > max_continent_id) { max_continent_id = parseInt($("#newContinentID").val()) }
            $("#max_continent_id").text(max_continent_id)
            $("#continent_count").text(continent_count)
            var tree = $.ui.fancytree.getTree("#xmlOutput")
            var world = tree.findFirst("CONTINENT")
            world.addChildren(continent_obj)
            world.sortChildren(null, true);
            var continent = world.findFirst($("#newContinentName").val())
            world.setExpanded()
            continent.setFocus()
            continent.setActive()
            $.magnificPopup.close()
        }
    })

    $("#newNationForm").validate({
        //debug: true,
        errorClass: "invalid",
        submitHandler: function() { 
            nations_by_id[$("#newNationID").val()] = $("#newNationName").val()
            nation_count++;
            var nation_obj = {}
            nation_obj.type = 'nation'
            nation_obj.folder = true
            nation_obj.icon = './images/flag-solid.svg'
            nation_obj.id = $("#newNationID").val()
            nation_obj.title = $("#newNationName").val()
            nation_obj.title_korean = $("#newNationNameK").val()
            nation_obj.short_korean = $("#newNationShortK").val()
            nation_obj.pop = $("#newNationPopulation").val()
            nation_obj.etid = $("#newNationEtid").val()
            nation_obj.lid = $("#newNationLid").val()
            nation_obj.capid = '0'
            nation_obj.gender = $("#newNationGender").val()
            nation_obj.bbqual = $("#newNationBbqual").val()
            nation_obj.abbr = $("#newNationAbbr").val()
            nation_obj.abbr_korean = $("#newNationAbbrK").val()
            nation_obj.dem = $("#newNationDem").val()
            nation_obj.dem_korean = $("#newNationDemK").val()
            nation_obj.time_zone = $("#newNationTimeZone").val()
            nation_obj.observes_dst = $("#newNationDST").val()
            nation_obj.this_is_the_usa = $("#newNationUSA").val()
            if (parseInt($("#newNationID").val()) > max_nation_id) { max_nation_id = parseInt($("#newNationID").val()) }
            $("#max_nation_id").text(max_nation_id)
            $("#nation_count").text(nation_count)
            var tree = $.ui.fancytree.getTree("#xmlOutput")
            var world = tree.findFirst("CONTINENT")
            var continent = world.findFirst($("#newNationContinent option:selected" ).text())
            continent.addChildren(nation_obj)
            world.sortChildren(null, true);
            var newNode = continent.findFirst($("#newNationName").val())
            continent.setExpanded()
            newNode.setFocus()
            newNode.setActive()
            $.magnificPopup.close()
        }
    })
    </script>
</html>